<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Зачем?</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Цель: научиться получать компактные EXE-файлы для Qt-программ под Windows. Для этого надо сделать статическую сборку Qt (в идеале - сделать её один раз) и использовать в своих проектах. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Именно из соображений компактности я ориентировался на Qt ветки 4.8. Перейти на Qt5 можно легко, она хорошо совместима с Qt4 по исходным текстом, но экзешник таким компактным уже не будет. :) Разумеется, если нужны свежие плюшки из Qt5 (например, Qt3D), придётся собрать именно её. </p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Простейшая сборка</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для начала, нам нужен компилятор. Я использовал 32-разрядный MinGW (gcc 4.4.0) из Qt SDK 2009.05, вы можете взять что-нибудь посвежее. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, качаем с qt.io архив с исходниками Qt. У меня это <span style=" font-weight:600;">qt-everywhere-opensource-src-4.8.6.zip</span>. Распаковываем архив в каталог с не слишком страшным именем, желательно без русских букв. У меня это <span style=" font-weight:600;">C:\Qt\4.8.6.st</span>. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее медленно и печально идём в этот каталог (проверьте - configure.exe должен лежать именно там) и создаём командный файл для сборки. У меня он называется <span style=" font-weight:600;">buildstat-486.bat</span> и выглядит вот как: </p>
<pre style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">SET QTDIR=c:\Qt\4.8.6.st</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">SET MINGWDIR=c:\Qt\2009.05\mingw</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">SET QMAKESPEC=win32-g++</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-style:italic;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">SET PATH=%PATH%;%QTDIR%\bin;%MINGWDIR%\bin</span></pre>
<pre style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace'; font-style:italic;"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">configure -opensource -confirm-license -platform win32-g++ -static -release -no-exceptions -qt-zlib -qt-libpng -qt-libmng -qt-libjpeg -no-qt3support -no-phonon -no-webkit -nomake examples -nomake demos -prefix %QTDIR%</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">mingw32-make</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Естественно, QTDIR, MINGWDIR и имя компилятора должны соответствовать вашим реалиям. MINGWDIR - это корневой каталог MinGW, внутри него должны находиться bin, lib, share и др. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Набор ключей можно и нужно корректировать под свои хотелки, у меня, например, выброшены примеры, работа с вебом, мультимедией и SQL. Некоторые ключи могут потребовать дополнительных библиотек, в частности, ключ <span style=" font-weight:600;">-openssl</span> подразумевает наличие отдельно собранного OpenSSL (см. ниже). Для просмотра списка возможных ключей сделайте <span style=" font-weight:600;">configure.exe /? &gt;configure-options.txt</span> (он довольно большой). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Всё, запускаем наш батничек. Желательно из отдельной копии cmd, чтобы потом можно было посмотреть лог. Можно идти пить чай, а то и лечь спать - сборка вполне может занять 2-4 часа. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если сборка прошла успешно, запускаем Qt Creator и подключаем нашу Qt, указав путь к её экземпляру qmake.exe. </p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Подключаем OpenSSL</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Усложним задачу. Пусть мы активно работаем с сетью, и нам нужна поддержка OpenSSL (без него, например, в QNetworkAccessManager не будет работать протокол HTTPS). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для Qt 4.8.6 я взял исходники openssl-1.0.2m (с более новыми версиями у Qt4 возможны проблемы). В отличие от самой Qt, просто так собрать его в Windows без дополнительных инструментов не получится. Я использовал MSYS 1.0.11, в качестве компилятора подключил всё тот же gcc 4.4.0. Если Вы предпочитаете свежие версии, будет проще - в современных версиях MSYS2 из коробки есть уже и компилятор, и пакетный менеджер, и многое другое. Впрочем, и у меня подключение компилятора делается просто - инсталлятор MSYS сам запрашивает путь к нему. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Закидываем исходники OpenSSL в дерево MSYS. У меня это <span style=" font-weight:600;">C:\msys\1.0\home\username\projects</span> (каталог projects я создал вручную, чтобы все исходники были в одном месте). Заходим в консоль MSYS, распаковываем исходники, переходим в распакованный каталог и собираем OpenSSL почти как в линуксе: :)</p>
<pre style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">./config</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">make</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Результатами нашей деятельности являются заголовочные файлы (include/openssl/*.h) и библиотечные файлы (libcrypto.a, libcrypto.pc, libssl.a и libssl.pc). Кладём их куда-нибудь, откуда их увидит MinGW при сборке Qt. (Скорее всего, их можно и в дереве MSYS оставить, не проверял). Модифицируем в файле <span style=" font-weight:600;">buildstat-486.bat</span> вызов configure примерно следующим образом: </p>
<pre style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'monospace';"><br /></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace'; font-style:italic;">configure -I &quot;c:\Qt\3dparty\openssl-1.0.2m\include&quot; -L &quot;c:\Qt\3dparty\openssl-1.0.2m&quot; -opensource -confirm-license -platform win32-g++ -static -release -no-exceptions -qt-zlib -qt-libpng -qt-libmng -qt-libjpeg -openssl -no-qt3support -no-phonon -no-webkit -nomake examples -nomake demos -prefix %QTDIR%</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"> </pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ВНИМАНИЕ! В каталоге, на который указывает -I, должен присутствовать подкаталог openssl, а уже в нём файлы *.h. Если Вы укажете напрямую путь к файлам *.h, Qt не соберётся. Запускаем батничек (вероятно, перед этим стоит почистить объектные файлы от предыдущей сборки) и терпеливо ждём результата. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если ваши программы, работающие с HTTPS и/или SSL-сертификатами, нормально собираются и работают (мне, например, была нужна <a href="https://github.com/mhaller/qwebdavlib"><span style=" text-decoration: underline; color:#0000ff;">qwebdavlib</span></a>) - значит, квест пройден. </p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Куда расти?</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для работы наших программ по-прежнему нужны библиотеки mingwm10.dll и libgcc_s_dw2-1.dll. Возможно, их тоже можно как-то слинковать статически, но как - я ещё не разобрался. Впрочем, они небольшие и погоды не делают.</p></body></html>