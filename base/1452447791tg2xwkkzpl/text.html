<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Как на самом деле работает mod_rewrite. Пособие для продолжающих</span></p>
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Эта статья выросла из идеи продвинутого обучения наших сотрудников технической поддержки работе с mod_rewrite. Практика показала, что после изучения имеющихся в большом количестве учебников на русском языке саппортам хорошо дается решение шаблонных задач, но вот самостоятельное составление правил происходит методом проб и большого количества ошибок. Проблема заключается в том, что для хорошего понимания работы mod_rewrite требуется изучение оригинальной англоязычной документации, после чего — либо дополнительные разъяснения, либо часы экспериментов с RewriteLog.<br /><br />В статье изложен механизм работы mod_rewrite. Понимание принципов его работы позволяет четко осознавать действие каждой директивы и ясно представлять себе, что происходит в тот или иной момент внутри mod_rewrite при обработке директив.<br /><br />Я предполагаю, что читатель уже знаком с тем, что такое mod_rewrite, и не буду описывать его основы, которые легко найти в интернете. Также нужно отметить, что в статье освещается работа mod_rewrite при использовании его директив в файле .htaccess. Отличия при работе в контексте &lt;VirtualHost&gt; изложены в конце статьи.<br /><br />Итак, вы изучили mod_rewrite, составили несколько RewriteRule и успели столкнуться с бесконечными перенаправлениями, со случаем, когда правило почему-то не ловит ваш запрос, а также с непредсказуемой работой группы правил, когда последующее правило неожиданно изменяет запрос, кропотливо подготовленный правилами предыдущими.<br /><br />Почему так происходит?<br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">С чем работает RewriteRule</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Первому RewriteRule передается путь от того места, где находится .htaccess, до запрошенного файла. Эта строка никогда не начинается со &quot;/&quot;. Последующим RewriteRule передается результат предыдущих преобразований.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Чтобы досконально понять, как работает RewriteRule, необходимо сначала определить, </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">с чем он работает</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Рассмотрим, как Apache получает строку, которая изначально передается на обработку RewriteRule в .htaccess.<br /><br />Когда только начинаешь работать с mod_rewrite, логично предполагаешь, что он работает со ссылками. Однако в случае с использованием mod_rewrite в .htaccess это не так. На самом деле в RewriteRule передается </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">не ссылка, а путь до запрошенного файла</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">.<br /><br />Из-за внутренней архитектуры Apache в тот момент, когда в действие вступает .htaccess, mod_rewrite может оперировать только с путем до файла, который должен быть обработан. Это связано с тем, что до передачи в mod_rewrite запрос уже могли изменить другие модули (например, mod_alias), и итоговый путь до файла на сайте уже может не совпадать с исходной ссылкой. Если бы mod_rewrite работал с исходной ссылкой, он бы нарушал действие модулей, которые изменили запрос до него.<br /><br />Поэтому в mod_rewrite передается абсолютный путь до файла, который должен быть обработан. Также mod_rewrite знает путь до .htaccess, в котором размещены правила RewriteRule. Чтобы сделать из пути до файла что-то похожее на ссылку, с которой планирует работать разработчик сайта, mod_rewrite отрезает от абсолютного пути часть до файла .htaccess.<br /><br />Так вот, именно этот путь, от которого отрезан путь до .htaccess, передается в первый RewriteRule. Например:<br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запрос: http://example.com/templates/silver/images/logo.gif</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">DocumentRoot: /var/www/example.com</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Путь до файла: /var/www/example.com/templates/silver/images/logo.gif</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">.htaccess находится в: /var/www/example.com/templates/.htaccess</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В первый RewriteRule будет передано: <span style=" font-weight:600;">silver/images/logo.gif</span></li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Обратите внимание: «templates/» тоже отрезалось.</li></ul>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image428687873.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Путь до .htaccess отрезается вместе со слешем. Из этого есть следствие: строка, которая изначально передается на обработку RewriteRule никогда не начинается со &quot;/&quot;. <br /><br />Важно запомнить, что </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">не делает</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> RewriteRule. Она не обрабатывает имя сайта, аргументы, которые переданы в скрипт, да и ссылку обрабатывает не всю, если .htaccess размещен не в корне сайта. Всем этим занимается RewriteCond, которого кратко коснемся чуть позже. Итак:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># работать не будет - правило начинается со / RewriteRule ^/index.php$ /my-index.php # работать не будет - название сайта не анализируется RewriteRule RewriteRule ^example.com/.* http:&lt;span&gt;//www.&lt;/span&gt;example.com # работать не будет - аргументы ссылки не попадают в RewriteRule RewriteRule index.php\?newspage=([0-9]+) news.php?page=$1 # Будет работать только если .htaccess находится там же, где находится папка templates, # например, в корне сайта. То есть, если .htaccess находится в templates/.htaccess , правило # работать НЕ БУДЕТ, потому что mod_rewrite отрежет путь до .htaccess и на вход RewriteRule # строка попадет уже без &quot;templates/&quot; RewriteRule ^templates/common/yandex-money.gif$ templates/shared/yad.gif</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />В начале использования mod_rewrite я рекомендую работать с ним только в .htaccess в корне сайта. Это несколько упростит контроль за его работой.<br /><br />С чем работает RewriteRule, мы разобрались. Теперь посмотрим, </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">как</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> он работает.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Как работает RewriteRule</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">RewriteRule просто преобразовывает строку в соответствии с регулярными выражениями, и все. RewriteRule работает со строкой, а не со ссылкой или путем до файла.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Как мы выяснили выше, на вход RewriteRule попадает путь от .htaccess до запрошенного файла. Удобнее всего теперь абстрагироваться от путей и ссылок и рассматривать то, с чем работает RewriteRule, </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">как обычную строку</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Эта строка передается от RewriteRule к RewriteRule, видоизменяясь, если какое-то из RewriteRule сработало.<br /><br />В общем виде, если исключить сложности с использованием флагов (некоторые из которых мы рассмотрим ниже) и сложности с составлением регулярных выражений (которых мы почти не будем касаться в этой статье), RewriteRule работает ОЧЕНЬ просто.<br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Взяли строку.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сравнили с регулярным выражением в первом аргументе.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если есть совпадение — заменили <span style=" font-weight:600;">всю строку</span> на значение второго аргумента.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Передали строку следующему RewriteRule.</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Вот, в общем, и все. Чтобы наглядно проиллюстрировать, что RewriteRule работает именно </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">со строкой</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, рассмотрим следующий фантастический пример:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># &lt;b&gt;Запрос: http:&lt;span&gt;//mysite&lt;/span&gt;.com/info.html&lt;/b&gt; # В первый RewriteRule попадет &quot;info.html&quot; # Преобразовываем запрос в произвольную строку. RewriteRule ^info.html$ &quot;I saw a turtle in the hole. And it was dancing rock-n-roll. And it was smiling. All in all, it was a very funny doll.&quot; # &quot;info.html&quot; -&gt; &quot;I saw a turtle...&quot; # Заменяем эту строку на внешнюю ссылку. RewriteRule turtle https:&lt;span&gt;//example&lt;/span&gt;.com/information/index.html # &quot;I saw a turtle...&quot; -&gt; &quot;https:&lt;span&gt;//example&lt;/span&gt;.com/information/index.html&quot; # Заменяем имя сайта! RewriteRule ^(.*)example.com(.*)$ $1example.org$2 # &quot;https://example.com/information/index.html&quot; -&gt; &quot;https:&lt;span&gt;//example&lt;/span&gt;.org/information/index.html&quot; # Заменяем протокол! RewriteRule ^https:(.*)$ ftp:$1 # &quot;https:&lt;span&gt;//example&lt;/span&gt;.org/information/index.html&quot; -&gt; &quot;ftp:&lt;span&gt;//example&lt;/span&gt;.org/information/index.html&quot; # Заменяем конечную ссылку. RewriteRule ^(.*)/index.html$ $1/main.php # &quot;ftp:&lt;span&gt;//example&lt;/span&gt;.org/information/index.html&quot; -&gt; &quot;ftp:&lt;span&gt;//example&lt;/span&gt;.org/information/main.php&quot;</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Как видите, RewriteRule все равно, с чем работать — она просто преобразовывает строку в соответствии с заданными ей аргументами. Если хотите, можете в строке хранить любые массивы данных, при желании, настойчивости и хорошем знании регулярных выражений можете хоть крестики-нолики на RewriteRule написать.<br /><br />Здесь нужно сделать замечание: хоть RewriteRule и работает с чистой строкой, она все-таки </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-style:italic;">ориентирована</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> на работу со ссылками. Поэтому она будет по-особому реагировать на строки, начинающиеся на «https://» или аналоги (запомнит, что мы хотели сделать внешний редирект) и на символ &quot;?&quot; (посчитает следующие символы аргументами, которые нужно будет подставить к запросу). Однако сейчас нас это не интересует — важно понять, что в RewriteRule нет никакой магии — она просто берет строку и изменяет ее так, как вы ей сказали. Внешние редиректы и аргументы мы рассмотрим позже в статье, там тоже есть, о чем поговорить.<br /><br />После того как все преобразования произведены и выполнено последнее RewriteRule, вступает в силу RewriteBase.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Для чего нужен RewriteBase</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Если получившийся после преобразований запрос является относительным и отличается от исходного, RewriteBase добавит себя к нему слева. Нужно обязательно указывать RewriteBase в .htaccess. Его значение — путь от корня сайта до .htaccess.<br />RewriteBase выполняется только после всех RewriteRule, а не между ними.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Мы уже говорили выше о том, что в mod_rewrite, работающий в .htaccess, попадает абсолютный путь до запрошенного файла. Чтобы передать его в RewriteRule, mod_rewrite отрезает путь до .htaccess. Потом правила RewriteRule одно за одним последовательно изменяют запрос. И вот после того, как запрос изменен, Apache должен восстановить абсолютный путь до файла, который он должен в итоге обработать. RewriteBase фактически является хаком, который помогает восстановить исходный путь до файла.<br /><br />RewriteBase выполняется после всех преобразований. Это значит, что он не будет изменять запрос между RewriteRule, а вступит в силу только когда все RewriteRule отработают.<br /><br />После всех преобразований RewriteBase смотрит, относительный получился в итоге путь или абсолютный. В контексте Apache имеется в виду относительный или абсолютный путь, отсчитывая от корня сайта:<br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">images/logo.gif — относительный.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">/images/logo.gif — абсолютный (в начале слеш).</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">http://example.com/images/logo.gif — самый абсолютный из всех.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Если путь абсолютный, RewriteBase ничего не делает. А если относительный — RewriteBase дописывает себя слева. Это работает как для внутренних, так и для внешних редиректов:<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># .htaccess находится в /images/ # RewriteBase указан /images/ RewriteBase /images/ # &lt;b&gt;Запрос http:&lt;span&gt;//example.&lt;/span&gt;com/images/logo.gif&lt;/b&gt; # На вход RewriteRule попадает &quot;logo.gif&quot; RewriteRule ^logo.gif$ logo-orange.gif # После RewriteRule: &quot;logo.gif&quot; -&gt; &quot;logo-orange.gif&quot; # После RewriteBase: &quot;logo-orange.gif&quot; -&gt; &quot;/images/logo-orange.gif&quot; # &lt;b&gt;Запрос http:&lt;span&gt;//example.&lt;/span&gt;com/images/header.png&lt;/b&gt; # На вход RewriteRule попадает &quot;header.png&quot; RewriteRule ^header.png$ /templates/rebranding/header.png # После RewriteRule: &quot;header.png&quot; -&gt; &quot;/templates/rebranding/header.png&quot; # После RewriteBase: ничего не меняется, так итоговый результат преобразований начинается со &quot;/'. # &lt;b&gt;Запрос http:&lt;span&gt;//example.&lt;/span&gt;com/images/director.tiff&lt;/b&gt; # На вход RewriteRule попадает &quot;director.tiff&quot; # Используем &lt;em&gt;внешний относительный&lt;/em&gt; редирект RewriteRule ^director.tiff$ staff/manager/director.tiff [R=301] # После RewriteRule: &quot;director.tiff&quot; -&gt; &quot;staff/manager/director.tiff&quot; # + mod_rewrite запомнил, что будет внешний редирект # После RewriteBase: &quot;staff/manager/director.tiff&quot; -&gt; &quot;/images/staff/manager/director.tiff&quot; # mod_rewrite вспомнил про внешний редирект: # &quot;/images/staff/manager/director.tiff&quot; -&gt; http:&lt;span&gt;//example.&lt;/span&gt;com/images/staff/manager/director.tiff</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Обычно после некоторого знакомства с mod_rewrite складывается следующая привычка: 1) в каждый .htaccess добавлять «RewriteBase /», 2) все перенаправления начинать со слеша: «RewriteRule news.php /index.php?act=news». Это помогает избавиться от артефактов работы RewriteBase, но так делать неправильно. Теперь, когда нам известно, что делает RewriteBase, можно </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">сформулировать следующие корректные правила:</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">RewriteBase должен совпадать с путем от корня сайта до .htaccess.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Начинать перенаправления со &quot;/&quot; нужно только тогда, когда необходимо указать абсолютный путь от корня сайта до файла.</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image723731351.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Что будет, если не указать RewriteBase? По умолчанию Apache делает его равным абсолютному пути на файловой системе до .htaccess (например, /var/www/example.com/templates/). Некорректность такого предположения Apache проявляется на внешних относительных редиректах:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># Запрос http://example.com/index.php</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># DocumentRoot: /var/www/example.com/ </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># .htaccess находится в корне сайта, и в нем НЕ УКАЗАН RewriteBase. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># Поэтому по умолчанию RewriteBase равен абсолютному пути до .htaccess: /var/www/example.com/ </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># На входе RewriteRule - &quot;index.php&quot; RewriteRule ^index.php main.php [R] </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># На выходе: &quot;index.php&quot; -&gt; &quot;main.php&quot; </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># mod_rewrite запомнил, что нужен внешний редирект </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># Закончились RewriteRule </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># mod_rewrite все равно выполняет RewriteBase, так как у него есть значение по умолчанию. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># Получается: &quot;main.php&quot; -&gt; &quot;/var/www/example.com/main.php&quot; </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># Здесь mod_rewrite вспоминает, что был внешний редирект: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># &quot;/var/www/example.com/main.php&quot; -&gt; http:&lt;span&gt;//example.&lt;/span&gt;com/var/www/example.com/main.php </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:9pt;"># Получилось совсем не то, что имели в виду.</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Итак, запрос прошел через все RewriteRule, после чего к нему, в случае необходимости, добавился RewriteBase. Должен ли теперь Apache отдать файл, на который показывает результирующий путь? </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Нет. Теперь получившийся запрос будет обрабатываться еще раз.</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Как работает mod_rewrite. Флаг [L]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">mod_rewrite запускает обработку запроса снова и снова, до тех пор, пока он не перестанет меняться. И флаг [L] не может это остановить.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />При составлении более-менее сложных конфигураций mod_rewrite важно понимать, что </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">изменение запроса не заканчивается на последнем RewriteRule</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. После того, как сработало последнее правило RewriteRule и был добавлен RewriteBase, mod_rewrite смотрит, изменился запрос или нет. Если запрос изменился, его обработка начинается заново с начала .htaccess.<br /><br />Apache поступает так, потому что в процессе изменения запроса он мог быть перенаправлен в другую директорию. В ней может быть собственный .htaccess, который не участвовал в предыдущей обработке запроса. В этом же новом .htaccess могут быть правила, которые влияют на обработку запроса — как правила mod_rewrite, так и правила других модулей. Чтобы корректно обработать эту ситуацию, Apache должен запустить весь цикл обработки заново.<br /><br /></span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-style:italic;">— Постойте, но ведь есть флаг </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600; font-style:italic;">[L]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-style:italic;">, который останавливает обработку запроса mod_rewrite'ом!</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /><br />Не совсем так. Флаг [L] останавливает </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">текущую итерацию</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> обработки запроса. Однако если запрос был изменен теми RewriteRule, которые все-таки успели отработать, Apache запустит цикл обработки запроса заново с первого RewriteRule.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># &lt;b&gt;Запрос: http:&lt;span&gt;//example&lt;/span&gt;.com/a.html&lt;/b&gt; RewriteBase / RewriteRule ^a.html$ b.html [L] RewriteRule ^b.html$ a.html [L]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Пример выше приведет к бесконечному циклу перенаправлений и к «Internal Server Error» в итоге. В этом примере бесконечный цикл очевиден, однако в более сложных конфигурациях может потребоваться покопаться в правилах, чтобы определить, какие запросы зацикливаются между собой. <br /><br />Чтобы избежать подобных ситуаций, рекомендуется использовать флаг [L] только при необходимости. Необходимость может быть двух типов:<br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда используется внешний редирект — [L,R=301] или [L,R=302]. В случае внешнего редиректа дальнейшая обработка запроса нежелательна (см. ниже про флаг [R]), и ее лучше остановить.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда в .htaccess есть зацикливание, от которого не избавиться, и обработку запроса mod_rewrite'ом нужно принудительно прекратить. В этом случае используется специальная конструкция — см. в конце статьи советы на эту тему.</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />А вот приведенный ниже пример зацикливаться не будет. Попробуйте определить, почему, и какой в итоге файл будет отдан Apache'м.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># &lt;b&gt;Запрос: http:&lt;span&gt;//example&lt;/span&gt;.com/a.html&lt;/b&gt; # Начало .htaccess RewriteBase / RewriteRule ^a.html$ b.html RewriteRule ^b.html$ a.html # Конец .htaccess</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Отгадка: </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; color:#ffffff;">В результате выполнения всех RewriteRule запрос меняется таким образом, что конечный результат равен исходному</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; color:#ffffff;">Apache видит это и не запускает повторную обработку запроса</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; color:#ffffff;">Будет возвращен файл a.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Как работает mod_rewrite. Флаг [R]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Флаг [R] не останавливает обработку запроса, возвращая сразу внешний редирект. Вместо этого он запоминает необходимость внешнего редиректа, и обработка запроса продолжается следующими RewriteRule. Рекомендуется всегда использовать с флагом [L].<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Флаг [R] сообщает Apache, что нужно выполнить не внутренний, а внешний редирект. Чем отличается внешний редирект от внутреннего? Внутренний редирект просто изменяет путь до файла, который будет отдан пользователю, при этом пользователь считает, что получает тот файл, который он изначально запросил. При внешнем же редиректе Apache вместо содержимого файла возвращает пользователю статус ответа 301 или 302 и сообщает ссылку, по которой браузер должен обратиться для получения файла.<br /><br />Казалось бы, при обработке флага [R] Apache должен сразу прекратить обработку RewriteRule и вернуть пользователю внешний редирект. Однако давайте вспомним фантастический пример из раздела «Как работает RewriteRule». В нем мы сначала указали флаг [R], обозначив необходимость внешнего редиректа, после чего продолжили изменять ссылку следующими RewriteRule.<br /><br />Именно так и работает Apache при указании внешнего редиректа. Он просто «помечает» себе, что после выполнения всех правил необходимо вернуть статус 302 (по умолчанию), но при этом продолжает выполнение всех RewriteRule дальше по списку. Мы можем и дальше изменять запрос как нам нужно, единственное, что не получится — сделать редирект обратно внутренним.<br /><br />Тем не менее, вряд ли вы хотите после отдачи внешнего редиректа каким-либо образом изменять его. Поэтому </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">рекомендуется при употреблении флага [R] указывать его совместно с [L]:</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># BlackJack переехал на красивое имя RewriteRule ^bj/(.*) blackjack/$1 [R=301,L] # Можно использовать просто внешнюю ссылку RewriteRule ^bj/(.*) http:&lt;span&gt;//blackjack.example&lt;/span&gt;.com/$1 [L]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Вместо использования флага [R] можно указывать просто внешнюю ссылку. В этом случае Apache сам догадается, что необходимо сделать внешний редирект. Здесь, как и с в случае с явным указанием флага [R], рекомендуется использовать флаг [L].<br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если внешний редирект ведет на тот же сайт, лучше использовать флаг [R] без указания полной ссылки (иными словами, использовать относительный внешний редирект). Это сделает правило независимым от имени сайта.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если же внешний редирект ведет на другой сайт, иначе, как указав полную внешнюю ссылку, это сделать не получится.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Как работает mod_rewrite. Указание параметров запроса и флаг [QSA]</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Изменение параметров запроса в RewriteRule не изменяет строку, с которой работает следующий RewriteRule. Однако при изменении параметров изменяется переменная %{QUERY_STRING}, с которой может работать RewriteCond.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Используемая терминология: «параметры» — параметры запроса, «аргументы» — аргументы RewriteRule.<br /><br />С помощью RewriteRule можно изменять не только путь до файла, который будет обрабатываться, но и параметры запроса GET, которые будут ему передаваться. Это часто используется для передачи обработки ЧПУ в общий скрипт-обработчик, например:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">RewriteBase / # &lt;b&gt;Запрос: http:&lt;span&gt;//example&lt;/span&gt;.com/news/2010/07/12/grand-opening.html&lt;/b&gt; # На входе: &quot;news/2010/07/12/grand-opening.html&quot; RewriteRule ^news/(.*)$ index.php?act=news&amp;what=$1 # После RewriteRule: &quot;news/2010/07/12/grand-opening.html&quot; -&gt; &quot;index.php&quot; # %{QUERY_STRING}: &quot;&quot; -&gt; &quot;act=news&amp;what=2010/07/12/grand-opening.html&quot;</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />В момент, когда правило RewriteRule встречает вопросительный знак во втором аргументе, оно понимает, что происходит изменение параметров в запросе. В результате происходит следующее:<br /></span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">RewriteRule заменяет строку, с которой оно работает, на часть второго аргумента <span style=" font-weight:600;">до вопросительного знака</span>. Обратите внимание, что новые параметры запроса <span style=" font-weight:600;">не попадают</span> в строку, с которой будут работать последующие правила RewriteRule.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Часть второго аргумента <span style=" font-weight:600;">после вопросительного знака</span> попадает в переменную %{QUERY_STRING}. Если был указан флаг [QSA], параметры запроса будут добавлены в начало %{QUERY_STRING}. Если флаг указан не был, %{QUERY_STRING} полностью заменится параметрами запроса из RewriteRule.</li></ol>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Еще пара примеров:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">RewriteBase / # &lt;b&gt;Запрос: http:&lt;span&gt;//example&lt;/span&gt;.com/news/2010/?page=2&lt;/b&gt; # На входе RewriteRule: &quot;news/2010/&quot; RewriteRule ^news/(.*)$ index.php?act=news&amp;what=$1 # После преобразования: &quot;news/2010/&quot; -&gt; &quot;index.php&quot; # Значение %{QUERY_STRING}: &quot;page=2&quot; -&gt; &quot;act=news&amp;what=2010/&quot;</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Скорее всего, правило выше работает неправильно, так как теряется аргумент page. Исправим это:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">RewriteBase / # &lt;b&gt;Запрос: http:&lt;span&gt;//example&lt;/span&gt;.com/news/2010/?page=2&lt;/b&gt; # На входе RewriteRule: &quot;news/2010/&quot; RewriteRule ^news/(.*)$ index.php?act=news&amp;what=$1 &lt;b&gt;[QSA]&lt;/b&gt; # После преобразования: &quot;news/2010/&quot; -&gt; &quot;index.php&quot; # Значение %{QUERY_STRING}: &quot;page=2&quot; -&gt; &quot;act=news&amp;what=2010/&amp;page=2&quot;</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Мы добавили только флаг [QSA], и правило стало работать корректно. <br /><br />Важно понимать, что </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">изменение параметров запроса изменяет %{QUERY_STRING}</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, который может использоваться в дальнейшем в RewriteCond. Это нужно учитывать при составлении последующих правил, проверяющих аргументы.<br /><br /></span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-style:italic;">— Конечно, изменяется, ведь запрос уходит на повторную обработку Apache'м!</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /><br />Нет, %{QUERY_STRING} </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">изменяется сразу же</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Доказательство приводить не буду — про параметры и так уже написано больше, чем интересно читать :)<br /><br />Что же делать, чтобы проверить в RewriteCond именно те параметры запроса, которые передал пользователь, а не модифицированные RewriteRule'ами? Смотрите советы в конце статьи.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">RewriteCond и производительность</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Сначала проверяется совпадение запроса с RewriteRule, а уже потом — дополнительные условия RewriteCond.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Пару слов стоит сказать о том, в каком порядке mod_rewrite выполняет директивы. Так как в .htaccess сначала идут RewriteCond, а потом RewriteRule, кажется, что mod_rewrite сначала проверяет все условия, а потом приступает к выполнению RewriteRule.<br /><br />На самом деле все происходит наоборот. Сначала mod_rewrite проверяет, подходит ли текущее значение запроса под регулярное выражение RewriteRule, а уже потом будет проверять все условия, перечисленные в RewriteCond.<br /><br />Так что если у вас в RewriteRule регулярное выражение на две страницы и вы, задумавшись о производительности, решили ограничить выполнение этого правила дополнительными RewriteCond, знайте — ничего не получится. В этом случае лучше использовать флаги RewriteRule </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">[C]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> или </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">[S]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, чтобы пропустить более сложное правило, если более простые проверки не сработали.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Переменные и флаги RewriteCond, остальные флаги RewriteRule и прочее</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Читайте документацию.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Мы познакомились с принципами работы RewriteRule, RewriteBase, флагов [L], [R] и [QSA], а также разобрали механизм обработки запросов внутри mod_rewrite. Из незатронутого остались: другие флаги RewriteRule, директивы RewriteCond и RewriteMap.<br /><br />К счастью, эти директивы и флаги не таят в себе каких-либо загадок и работают именно так, как описано в большинстве учебников. Для их понимания достаточно почитать официальную документацию. В первую очередь рекомендую изучить список переменных, которые можно проверять в RewriteCond — %{QUERY_STING}, %{THE_REQUEST}, %{REMOTE_ADDR}, %{HTTP_HOST}, %{HTTP:header} и т. д.)<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Разница в работе mod_rewrite в контексте .htaccess и в контексте VirtualHost</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Запомните:</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> в контексте &lt;VirtualHost&gt; mod_rewrite работает с точностью до наоборот!<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Как я говорил в начале статьи, все описанное выше касается применения mod_rewrite в контексте .htaccess. Если же mod_rewrite используется в &lt;VirtualHost&gt;, он будет работать по-другому:<br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В &lt;VirtualHost&gt; в RewriteRule попадает весь путь запроса, начиная от первого слеша, заканчивая началом параметров GET: «http://example.com/some/news/category/post.html?comments_page=3» -&gt; &quot;/news/category/post.html&quot;. Эта строка всегда начинается со /.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Второй аргумент RewriteRule также необходимо начинать со /, иначе будет «Bad Request».</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">RewriteBase не имеет смысла.</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проход правил происходит только один раз. Флаг [L] действительно заканчивает обработку всех правил, описанных в &lt;VirtualHost&gt;, без каких-либо последующих итераций.</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Советы и решения</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Здесь собраны советы, которые можно было бы привести по ходу статьи, но которые были исключены из основного текста для краткости изложения материала.<br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Составление регулярных выражений</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Старайтесь составлять регулярные выражения так, чтобы они наиболее узко определяли именно те запросы, которые вы хотите модифицировать — чтобы правила RewriteRule случайно не сработали для другого запроса. Например:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># Начинайте все регулярные выражения с &quot;^&quot; (признак начала строки) # и заканчивайте &quot;$&quot; (признак конца строки): RewriteRule ^news.php$ index.php # Даже если в этом нет необходимости - для универсальности и лучшего понимания конфигурации: RewriteRule ^news/(.*)$ index.php # Если под маску должны попадать только цифры - укажите это явно. # Если какие-то цифры постоянны, укажите их явно. # Если в оставшейся части запроса не могут присутствовать слеши, ограничьте их присутствие. # Не забывайте экранировать &quot;.&quot; (точки). # Следующее правило нацелено на запросы вида http:&lt;span&gt;//example&lt;/span&gt;.com/news/2009/07/28/b-effect.html RewriteRule ^news/20[0-9]{2}/[0-9]{2}/[0-9]{2}/[^/]+\.html index.php</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Впрочем, о регулярных выражениях на одном известном сайте есть </span><a href="http://habrahabr.ru/blogs/regex/"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">целый раздел</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">.<br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Изменение внешних редиректов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Несмотря на то, что mod_rewrite позволяет изменять с помощью RewriteRule даже внешние редиректы, вплоть до протокола, я крайне не рекомендую делать это. В статье пример с изменением внешних редиректов используется только чтобы отвязаться от таких понятий как «ссылки» и «файлы» и более явно показать, что RewriteRule работает с простой строкой.<br /><br />Не думаю, что разработчики mod_rewrite предполагали, что кто-то будет так делать, поэтому возможны всякие артефакты. Не делайте так, пожалуйста.<br /><br /></span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Как остановить бесконечный цикл</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Иногда логика перенаправлений на сайте такова, что без специальных действий mod_rewrite воспринимает их как бесконечный цикл перенаправлений. Возьмем следующий пример.<br /><br />На сайте была страница /info.html. Специалист по SEO решил, что поисковые системы будут лучше индексировать эту страницу, если она будет называться /information.html и попросил сделать внешний редирект с info.html на information.html. Однако разработчик сайта по каким-то своим соображениям не может просто переименовать info.html в information.html и сделать редирект — ему нужно, чтобы данные обязательно отдавались непосредственно из файла info.html. Он пишет следующее правило:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># сделать внешний редирект RewriteRule ^info.html information.html [R,L] # но по запросу /information.html все равно отдать info.html RewriteRule ^information.html info.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />… и сталкивается с бесконечным циклом. Каждый запрос /information.html получает внешний редирект снова на /information.html.<br /><br />Решить эту проблему можно как минимум двумя способами. На Хабре был уже описан </span><a href="http://habrahabr.ru/blogs/webdev/75885/"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">один из них</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> — нужно установить переменную окружения и на основании ее значения прекращать перенаправления. Код будет выглядеть следующим образом:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">RewriteCond %{ENV:REDIRECT_FINISH} !^$ RewriteRule ^ - [L] RewriteRule ^info.html$ information.html [R,L] RewriteRule ^information.html$ info.html [E=FINISH:1]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />Обратите внимание, что к имени переменной mod_rewrite добавляет 'REDIRECT_'.<br /><br />Второй способ — проверить в THE_REQUEST, что именно было запрошено пользователем:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;"># Внешний редирект происходит только если пользователь запросил info.html. # Если же info.html - это результат внутреннего перенаправления, правило срабатывать не будет. RewriteCond %{THE_REQUEST} &quot;^(GET|POST|HEAD) /info.html HTTP/[0-9.]+$&quot; RewriteRule ^info.html$ information.html [R,L] RewriteRule ^information.html$ info.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Анализ исходного запроса пользователя — борьба с раскрытием ссылок Apache</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />При обработке запроса Apache раскрывает закодированные (URL-encoded) символы из первоначального запроса. В некоторых случаях это может быть нежелательно — разработчик хочет проверять именно первоначальный, немодифицированный запрос пользователя. Сделать это можно, проверяя в RewriteCond переменную %{THE_REQUEST}:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">RewriteCond %{THE_REQUEST} ^GET[\ ]+/tag/([^/]+)/[\ ]+HTTP.*$ RewriteRule ^(.*)$ index.php?tag=%1 [L]</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br />На хабре есть </span><a href="http://habrahabr.ru/blogs/personal/49136/"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">обсуждение одного из таких случаев</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, из него и был взят вышеприведенный пример.<br /><br /></span></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Рекомендуемая документация</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;"><br /></span><a href="http://httpd.apache.org/docs/current/rewrite/"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Официальная документация Apache</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и особенно </span><a href="http://httpd.apache.org/docs/current/rewrite/tech.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Technical details</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Да-да.<br /><br />Большое спасибо за внимание! </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p></body></html>