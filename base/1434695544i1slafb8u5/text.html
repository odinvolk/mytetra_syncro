<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Не секрет, что во многих организациях, использующих Linux наравне с Windows, есть небольшая проблема. Проблема заключается в том, что сообщения, отправляемые привычной для администраторов Windows командой net send, не принимаются компьютерами, на которых установлен Linux. В этом HOWTO описан простой способ создания системы приема сообщений net send на Linux-декстопе под управлением Ubuntu. Принимаемые сообщения будут появляться в небольшом, автоматически появляющемся окне. Способ проверен на <span style=" font-weight:600;">Ubuntu 7.04</span> и на <span style=" font-weight:600;">Ubuntu 7.10</span>, и упешно работает. Так же, без каких либо переделок, он должен подойти и для <span style=" font-weight:600;">Ubuntu 8.04</span>.<br /><br />Далее идет пошаговая инструкция с комментариями.<br /><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-size:14pt; font-weight:600;">1.</span> Убедиться, что установлены пакеты<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">samba<br />samba_common<br />smbclient<br />zenity</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это можно сделать через Synaptic. Если какой-либо пакет не установлен, установить.<br /><span style=" color:#800000;"><br /></span><span style=" font-weight:600; color:#800000;">Комментарий: </span><span style=" color:#800000;">Пакет samba устанавливает samba-сервер, который как раз и отслеживает поступление netsend сообщений. Пакет smbclient устанавливает программу smbclient, которая помимо поддержки работы в Windows-сетях позволяет отправлять с Linux-компьютера netsend сообщения. Как это делать будет написано ниже. Пакет samba_common устанавливает необходимые библиотеки для работы сервера samba и программы smbclient. Пакет zenity содержит программу zenity, которая умеет показывать на экране простые графические интерфейсы. Мы будем ее использовать для того, чтобы вывести красивое окошко с пришедшим сообщением.<br /></span><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-size:14pt; font-weight:600;">2.</span> Под правами рута открыть на редактирование файл /etc/samba/smb.conf, и в начало секции [ global ] добавить строки<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">dos charset = 866<br />unix charset = UTF8<br />display charset = UTF8<br />message command = /bin/sh -c '/usr/bin/getnetsend.sh %s'</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#800000;">Комментарий: </span><span style=" color:#800000;">Данное действие справедливо для свежеустановленного пакета </span><span style=" font-family:'Courier New,courier'; color:#800000;">samba</span><span style=" color:#800000;">. Если пакет samba уже был установлен и подвергался настройке, необходимо убедиться, что каждая из приведенных опций не встречается в тексте файла </span><span style=" font-family:'Courier New,courier'; color:#800000;">/etc/samba/smb.conf</span><span style=" color:#800000;"> где-нибудь еще.<br /><br />В момент прихода сообщения netsend, сервер samba кладет в каталог </span><span style=" font-family:'Courier New,courier'; color:#800000;">/tmp</span><span style=" color:#800000;"> файл с текстом сообщения. Затем выполняет команду, прописанную в опции </span><span style=" font-family:'Courier New,courier'; color:#800000;">message command</span><span style=" color:#800000;">. При вызове данной командной строки, вместо символов %s, будет подставлено имя файла с текстом сообщения.<br /></span><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-size:14pt; font-weight:600;">3.</span> Под правами рута открыть на редактирование файл <span style=" font-family:'Courier New,courier';">/etc/profile</span>, и в конец файла дописать строку<br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">xhost +local:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#800000;">Комментарий: </span><span style=" color:#800000;">Данная команда обязательно должна выполниться после запуска X-сервера. По умолчанию, X-сервер настроен так, что соединяться с ним и открывать окна могут только программы от пользователя, зарегистрированного в данный момент в системе. Сервер </span><span style=" font-weight:600; color:#800000;">samba</span><span style=" color:#800000;"> работает под системаным пользователем </span><span style=" font-family:'Courier New,courier'; color:#800000;">nobody</span><span style=" color:#800000;"> (так же как и, например программа </span><span style=" font-weight:600; color:#800000;">cron</span><span style=" color:#800000;">). Поэтому любые попытки запустить X-приложение из </span><span style=" font-weight:600; color:#800000;">samba</span><span style=" color:#800000;"> (или например из </span><span style=" font-weight:600; color:#800000;">cron</span><span style=" color:#800000;">), будут отвергаться X-сервером<br /><br />Команда </span><span style=" font-family:'Courier New,courier'; color:#800000;">xhost +local:</span><span style=" color:#800000;">, запущенная от текущего пользователя, настраивает X-сервер так, что он начинает принимать локальные (в пределах компьютера) соединения от любого пользователя. Таким образом, X-программа zenity, которая вызывается из скрипта </span><span style=" font-family:'Courier New,courier'; color:#800000;">/usr/bin/getnetsend.sh</span><span style=" color:#800000;"> из-подпользователя </span><span style=" font-family:'Courier New,courier'; color:#800000;">nobody</span><span style=" color:#800000;">, сможет нормально работать.<br /><br />Для систем Ubuntu и Debian, размещать команду </span><span style=" font-family:'Courier New,courier'; color:#800000;">xhost +local:</span><span style=" color:#800000;"> нужно именно в файле </span><span style=" font-family:'Courier New,courier'; color:#800000;">/etc/profile</span><span style=" color:#800000;">. Команды из этого файла выполняются после того, как произошел логин пользователя в оконную систему (справедливо для KDE, GNOME, на других DE не проверялось). По неизвестным причинам, файл </span><span style=" font-family:'Courier New,courier'; color:#800000;">/etc/X11/xinit/xinitrc</span><span style=" color:#800000;">, который специально предназначенн для выполнения команд в момент входа в DE, в системах Ubuntu и Debian не работает.<br /></span><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-size:14pt; font-weight:600;">4.</span> Создать под правами рута в каталоге <span style=" font-family:'Courier New,courier';">/usr/bin</span> файл <span style=" font-family:'Courier New,courier';">getnetsend.sh</span> следующего содержания<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">#!/bin/sh<br /># getnetsend.sh v.1.04<br /><br /># Получаем номера активных дисплеев. <br /># Это нужно, чтобы сообщение открывалось не только на дисплее :0, если в системе<br /># одновременно открыто несколько сессий с разными пользователями<br />disp=`ps -ef | awk '$8 ~ /X$/ {print $9}'`<br /><br />for n in $disp<br />do<br /><br /> export DISPLAY=${n}<br /><br /> zenity --text-info --title=&quot;Net message&quot; --filename $1 &amp;<br /><br />done</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#800000;">Комментарий: </span><span style=" color:#800000;">Не забудьте назначить этому файлу права 755! По-умолчанию такой файл обычно получает права 700, что дает ему право работать только от root, и сообщения не будут видны! Назначить права можно командой </span><span style=" font-family:'Courier New,courier'; color:#800000;">chmod 755 /usr/bin/getnetsend.sh</span><span style=" color:#800000;">.<br /><br /></span><span style=" font-weight:600; color:#800000;">Внимание!</span><span style=" color:#800000;"> На разных Linux-системах чаще всего разные команды запуска X-сервера, в связи с чем имеем разный вывод команды </span><span style=" font-family:'Courier New,courier'; color:#800000;">ps -ef</span><span style=" color:#800000;">, который в нашем скрипте разбирается программой </span><span style=" font-family:'Courier New,courier'; color:#800000;">awk</span><span style=" color:#800000;">.<br /><br />В системе Ubuntu 7.04 строка процесса X-сервера имеет такой формат:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#800000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">root      5458  5432 13 14:29 tty7     00:15:48 /usr/bin/X -br -nolisten tcp :0 vt7 -auth /var/run/xauth/A:0-AKBbhb</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#800000;">то есть номер дисплея (:0) расположен в </span><span style=" font-weight:600; color:#800000;">12</span><span style=" color:#800000;">-м поле данной строки. А в системе Ubuntu 7.10 в строке процесса X-сервера ключи расположены в другой последовательности:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#800000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">root      5458  5432 13 14:29 tty7     00:15:48 /usr/bin/X :0 -br -nolisten tcp vt7 -auth /var/run/xauth/A:0-AKBbhb</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; color:#800000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#800000;">то есть, номер дисплея расположен в </span><span style=" font-weight:600; color:#800000;">9</span><span style=" color:#800000;">-м поле.<br /><br />Таким образом, первая команда в скрипте </span><span style=" font-family:'Courier New,courier'; color:#800000;">getnetsend.sh</span><span style=" color:#800000;"> должна соответсвовать формату, выдаваемому программой </span><span style=" font-family:'Courier New,courier'; color:#800000;">ps</span><span style=" color:#800000;">, иначе сообщения не будут видны.<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; color:#800000;">Ubuntu 7.04:</span><span style=" color:#800000;"> </span><span style=" font-family:'Courier New'; color:#6a1009;">disp=`ps -ef | awk '$8 ~ /X$/ {print $</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a1009;">12</span><span style=" font-family:'Courier New'; color:#6a1009;">}'`</span><span style=" color:#800000;"><br /></span><span style=" font-weight:600; color:#800000;">Ubuntu 7.10:</span><span style=" color:#800000;"> </span><span style=" font-family:'Courier New'; color:#6a1009;">disp=`ps -ef | awk '$8 ~ /X$/ {print $</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a1009;">9</span><span style=" font-family:'Courier New'; color:#6a1009;">}'`</span><span style=" color:#800000;"><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#800000;">Чтобы выяснить, правильно ли написана команда, выполните ее отдельно в консоле (при работающем X-сервере само собой). Если в ответ вы увидите </span><span style=" font-family:'Courier New,courier'; font-weight:600; color:#800000;">:0</span><span style=" color:#800000;"> (или список номеров дисплеев при открытых нескольких сессиях), значит все в порядке.<br /></span><br /><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-size:14pt; font-weight:600;">5.</span> Перезагрузить компьютер, войти под любым пользователем, и убедиться что прием сообщений работает.<br /><br /></p>
<hr />
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-size:14pt; font-weight:600;">Проверка.</span><br /><br />Проверку, как все работает, можно начать с того, чтобы компьютер отправил netsend-сообщение самому себе. Для этого выполните такую команду (это аналог команды net send в Linux)<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">echo &quot;Текст сообщения&quot; | smbclient -M имя_компьютера</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">где <span style=" font-family:'Courier New,courier';">имя_компьютера</span> - это сетевое имя данного компьютера (не IP-адрес!). Обратите внимание, что между командами используется перенаправление потока ( | ), а не файлового ввода ( &gt; ). На экране должно появиться окошечко с текстом сообщения, так же как это происходит и в Windows. Если сообщение не появлятся, значит вы что-то сделали неправильно, и нужно начинать отладку. Например можно включить в начало файла <span style=" font-family:'Courier New,courier';">getnetsend.sh</span> команду<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">echo &quot;Getnetsend running&quot; &gt;&gt; /tmp/getnetsendlog.txt</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">после чего снова отправить сообщение и посмотреть файл /tmp/getnetsendlog.txt, создался ли он вообще и есть ли в нем строка &quot;Getnetsend running&quot;. Если его нет, то скрипт вообще не вызывается самбой. Если он есть, то скрипт не может соединиться с X-сервером чтобы показать окошечко. Дальше думайте сами, что вы сделали неправильно.<br /><br />Если сообщение пришло, значит у нас все работает. Теперь пробуем отправить сообщение с Windows. На Windows-компьютере даем команду <br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">net send имя_компьютера &quot;Текст сообщения&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">и если увидели сообщение, то радуемся. Если не увидели, значит Linux-компьютер и Windows-компьютер находятся в разных рабочих группах или в разных доменах.<br /><br /><br /><span style=" font-weight:600;">Внимание!</span> Сервер samba принимает сообщения, адресуемые только конкретному компьютеру! Samba не принимает сообщения, отправленные &quot;всем&quot;. То есть, если на Windows-компьютере дать команду <br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">net send * &quot;Текст сообщения&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">то такое сообщение получат только Windows-компьютеры. <span style=" font-weight:600;">Linux-компьютеры его проигнорируют</span>. Посему, системный администратор, для рассылки сообщений &quot;для всех&quot;, должен озаботиться поиском или написанием программки, которая получает список компьютеров в сети, и отправиляет net send сообщения по списку.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>