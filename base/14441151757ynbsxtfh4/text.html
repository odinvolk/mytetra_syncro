<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Миф №3: </span><span style=" font-family:'Courier New,courier'; font-size:xx-large; font-weight:600;">32</span><span style=" font-size:xx-large; font-weight:600;">-х разрядное приложение не может выделить </span><span style=" font-family:'Courier New,courier'; font-size:xx-large; font-weight:600;">1.5</span><span style=" font-size:xx-large; font-weight:600;"> Гб памяти за раз</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Несмотря на то, что приложению доступно по умолчанию около <span style=" font-family:'Courier New,courier';">2</span> Гб виртуального адресного пространства, утверждается, что приложение не может выделить <span style=" font-family:'Courier New,courier';">1.5</span> Гб памяти одним куском.<br /><br />Давайте проверим. Изменим код с <span style=" font-family:'Courier New,courier';">AllocMem</span> в нашем тестовом приложении на выделение <span style=" font-family:'Courier New,courier';">1.5</span> Гб и запустим программу. Получаем:<br /><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image11232.png" width="1061" height="51" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Легенда разрушена? <br /><br />Не так быстро. Попробуем сделать это на другой машине:<br /><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image11002.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />(сообщения &quot;Мало виртуальной памяти&quot; нет)<br /><br />Гм, в этот раз нам не удаётся выделить <span style=" font-family:'Courier New,courier';">1.5</span> Гб памяти. <br /><br />Мы получили противоречивые результаты. В чём же дело? <br /><br />Хотя нам действительно доступно около <span style=" font-family:'Courier New,courier';">2</span> Гб одним куском (только в самом начале и в самом конце этого региона откушено по <span style=" font-family:'Courier New,courier';">64</span> Кб на <a href="http://www.gunsmoker.ru/2011/04/windows.html"><span style=" text-decoration: underline; color:#0000ff;">спец. области</span></a>), но нужно вспомнить, что в этом адресном пространстве лежат не только ваши данные, но и ваш код, библиотеки (DLL), их код и так далее. Даже если вы не загружали библиотек явно в вашем коде - они всё равно будут загружены. Как минимум это <span style=" font-family:'Courier New,courier';">kernel32.dll</span> и <span style=" font-family:'Courier New,courier';">user32.dll</span>. И дальше всё зависит от того, как именно они загружены. Обычно системные библиотеки загружаются одним большим компактным регионом, расположенном по старшим адресам - поскольку они загружаются с краю адресного пространства, то в центре у вас получается большой кусок для вашей работы. Но если какая-то DLL загружается в середину адресного пространства, то оно оказывается разбито пополам, и вы уже не сможете выделить память одним куском (но всё ещё можете выделить её в два или три куска).<br /><br />К примеру, вот снимок загруженных DLL в адресном пространстве первого примера (который успешно выделил <span style=" font-family:'Courier New,courier';">1.5</span> Гб памяти) до выделения памяти:<br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image9013.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Как видим, в центре у нас есть большой свободный кусок - от <span style=" font-family:'Courier New,courier';">$2D40000</span> до <span style=" font-family:'Courier New,courier';">$648B0000</span>, т.е. <span style=" font-family:'Courier New,courier';">$648B0000 - $2D40000 = 1'563</span> Мб (примечание: это не значит, что в этом промежутке нет вообще ничего - там могут быть не DLL, а данные). Т.е. у нас есть свободное место.<br /><br />А вот этот же снимок DLL на машине, где выделить память не удалось:<br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image4891.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Как видите, в этом случае в середине большого свободного промежутка у нас разместилась DLL от FileBox Extender - это небольшая утилита, которая добавляет полезные кнопки в заголовки окон. Поскольку она меняет поведение каждого окна, то она должна быть загружена в каждую программу. Но из-за того, что она оказалась неграмотно спроектированной, её базовый адрес оказался в неудачном месте. Такая ситуация называется <span style=" font-weight:600;">фрагментацией адресного пространства</span>.<br /><br />Мораль истории: либо ставьте поменьше &quot;расширителей оболочки&quot;, либо следите, чтобы они были грамотно спроектированы.<br /><br />Статус мифа: <span style=" font-weight:600; color:#008000;">plausible</span>.<br /></p></body></html>