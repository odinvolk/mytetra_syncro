<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Sans Serif'; font-size:9pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Автор оригинала Иван Н. Песин. Но так как статья морально устарела, то она будет взята лишь за основу. (Претензии автора принимаются). </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-style:italic;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-style:italic;"><br /><span style=" font-weight:600; font-style:normal;">Маскарадинг (masquerading) и трансляции ip-адресов (NAT)</span><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Проблема маскарада (masquerading) и трансляции ip-адресов в Линуксе. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Что это такое,что там можно и что нельзя.<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Каждому Linux админу рано или поздно приходится сталкиваться с проблемой маскарада (masquerading) и трансляции ip-адресов на Линуксе (кроме тех у кого есть куча реальных адресов и они раздают их всем компам в локальной сети :-)). Если у Вас есть локальная сеть, подключенная к сети Интернет через linux сервер, то без маскарада не обойтись.<br /><br />Начнем, пожалуй, с определений.<br /></p>
<ul style="-qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Маскарад</span> (masquerade) и трансляция адресов (NAT) в мире Linux не являются синонимами.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Маскарад</span> - замена адреса на адрес машины, выполняющей маскарад.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Трансляция адресов</span> - замена адреса на любой указанный.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если вы используете ОС Linux с ядром 2.0 или 2.2, Вам нужно будет опустить глаза<br />вниз - в конце этой статьи находится авторское описание настроек ipfwadm и ipchains.<br />Я же опишу настройку NAT, masquerading для ОС Linux с ядром 2.4- 2.6, где используются<br />iptables. Для чего это вообще нужно? Вы имеете сеть с адресами:<br /><br />10.0.0.0-10.255.255.255 - сеть класса А<br />172.16.0.0 - 172.31.255.255 - сеть класса B<br />192.168.0.0-192.168.255.255 - сеть класса С<br /><br />Эти сети зарезервированы для использования в локальных сетях (intranet) и в сети<br />Интернет не используются. Допустим ваш компьютер в локальной сети с ip 192.168.0.2<br />получает доступ к Интернет через сервер с внутренним ip адресом 192.168.0.1 (eth1)<br />и внешним адресом 111.111.111.111 (eth0). Если пакет с вашего компьютера будет иметь<br />ваш адрес источника (192.168.0.2), то он просто не придет обратно, так как<br />удаленный хост не будет знать по какому маршруту отослать его обратно.<br />Для того, чтобы этого не случилось и придуманы NAT и masquerading.<br /><br /><br />Итак как работает маскарад.<br /><br />Ваш пакет (например на www.ibm.com) проходит через сервер и в нем сервер меняет<br />адрес источника НА СВОЙ АДРЕС, через который как раз и раздается интернет в локальной<br />сети (111.111.111.111). Пакет приходит на www.ibm.com и хост отвечает по адресу<br />в пакете (111.111.111.111). Так как Ваш сервер запомнил, что пакет для www.ibm.com<br />посылали вы, то он принимает пакет и отдает его вашему компьютеру. Вот и все, пакет<br />ушел и вернулся.<br /><br />Включается маскарад в iptables очень просто:<br /><br />iptables -A FORWARD -s 192.168.0.0/24 -j ACCEPT<br />(этой командой вы разрешили прохождение пакетов между сетевыми интерфейсами<br />из локальной сети 192.168.0.0/24)<br /><br />iptables -A FORWARD -d 192.168.0.0/24 -j ACCEPT<br />(этой командой вы разрешили прохождение пакетов между сетевыми интерфейсами<br />в локальную сеть 192.168.0.0/24)<br /><br />iptables -t nat -A POSTROUTING -o eth0 -s 192.168.0.0/24 -j MASQUERADE<br />(и последняя команда - ей вы включили маскарад для сети 192.168.0.0/24).<br /><br />Еще вам нужно проверить чтобы был включен forward ip в вашем ядре. Сделать это<br />можно командой<br /><br />cat /proc/sys/net/ipv4/ip_forward<br /><br />если Вы получили 1 на выходе значит все в порядке, если 0, тогда вам нужно<br />включить ip forward командой<br /><br />echo 1 &gt;/proc/sys/net/ipv4/ip_forward<br /><br /><br />Как работает NAT ?<br /><br />Ваш пакет (например на www.ibm.com) проходит через сервер и в нем адрес источника<br />меняется НА УКАЗАННЫЙ АДРЕС (мы же укажем адрес сервера 111.111.111.111, и тогда).<br />Пакет приходит на www.ibm.com и хост отвечает по адресу в пакете (111.111.111.111).<br />Пакет приходит на Ваш сервер и происходит обратная замена.<br /><br />Включается NAT в iptables так:<br /><br />iptables -A FORWARD -s 192.168.0.0/24 -j ACCEPT<br />(этой командой вы разрешили прохождение пакетов между сетевыми интерфейсами<br />из локальной сети 192.168.0.0/24)<br /><br />iptables -A FORWARD -d 192.168.0.0/24 -j ACCEPT<br />(этой командой вы разрешили прохождение пакетов между сетевыми интерфейсами<br />в локальную сеть 192.168.0.0/24)<br /><br />iptables -t nat -A POSTROUTING -o eth0 -s 192.168.0.0/24 -j SNAT --to-source 111.111.111.111<br />(и последняя команда - ей вы включили трансляцию адресов сети 192.168.0.0/24<br />на адрес 111.111.111.111).<br /><br />Еще вам нужно проверить чтобы был включен forward ip в вашем ядре. Сделать это<br />можно командой<br /><br />cat /proc/sys/net/ipv4/ip_forward<br /><br />если Вы получили 1 на выходе значит все в порядке, если 0, тогда вам нужно<br />включить ip forward командой<br /><br />echo 1 &gt;/proc/sys/net/ipv4/ip_forward<br /><br />Вот собственно и все.<br /><br /><br />Дальше идет статья Ивана Песина<br /><br />Решение проблемы маскарада, на ядрах разных версий отличается, и потому<br />мы разделим нашу повесть на две части, ядра версии от, если не ошибаюсь,<br />2.0.29 до 2.2.9ас, и от 2.2.10 до 2.4.0. Ядра версии 2.4.х я обсуждать не буду,<br />потому как там имеется вполне сносное описание. Итак,<br /><br />Ядра версий 2.0.29 - 2.2.9<br /><br />Для функции маскарада в этих версиях необходим пакет ipfwadm либо ipchains,<br />зависит от версии. Установив их можно приступать к осмысленным действиям.<br />Очень тривиальная задача решается следующим образом:<br /><br />ipchains -A forward -i ethX -s 192.168.1.0/24 -j MASQ<br /><br />результатом этой команды будет замена исходных адресов пакетов из сети<br />192.168.1.0 класса С, при маршрутизации их через интерфейс ethX, на адрес машины<br />на которой выполнены команды.<br /><br />Перейдем теперь к более сложным случаям. Допустим, вам необходимо, в зависимости<br />от адреса источника/назначения маскарадить под разными адресами. Как же это выполнить?<br />Тут нам придется обратиться к нестандартным средствам.<br /><br />Для начала посмотрим урл<br /><br />http://www.suse.de/~mha/HyperNews/get/linux-ip-nat.html.<br /><br />Хотя там написано не очень много, зато содержательно. После прочтения остается лишь<br />вытащить соответствующий архив с программой и патчем ядра. Пропатчив ядро, его надо<br />перекомпилировать (прочитать почитайки обязательно!) с соответствующими изменениями<br />в конфигурации. Устанавливаем скомпилированное ядро, при этом не забываем про "ядро<br />на всякий случай" (рабочее ядро, которое вы будете загружать, если новое ядро<br />не загрузится). После перезагрузки станет возможным использование команды ipnatadm.<br />Название говорит само за себя ;). Теперь легко можно изобразить команды вроде:<br /><br />ipnatadm -O -i -b -S 192.168.1.1/24 -M 207.46.230.219<br />ipnatadm -O -i -b -S 192.168.1.2/24 -M 207.46.230.229<br /><br />ну и так далее, думаю, разобраться можно. Есть еще полезная опция -W, позволяющая<br />задавать интерфейс. Да, не забудьте, что псевдонимы интерфейсов не понимаются ни<br />ipchains, ни ipfwadm, ни ipnatadm. Перейдем теперь к теме<br /><br /><br />Ядра версий 2.2.10 - 2.4.0<br /><br />На этих версиях, к сожаленью, программа ipnatadm предательски перестает функционировать.<br />Почему предательски? Потому что удается пропатчить ядро, скомпилировать, загрузиться<br />и даже приконнектиться с помощью telnet, например. Но при попытке выполнить, допустим,<br />даже вышеописанные команды, интерфейс подвисает. Ну что ж, значит нужно искать другие<br />ходы.<br /><br />Внимательно прочитав информацию, размещенную на сайте с ipnatadm, можно обнаружить<br />любопытный факт. А именно то, что один наш земляк Алексей Кузнецов, пишет часть ядра,<br />которая, в том числе, ведает маршрутизацией и маскарадом. Из этого прямо следует,<br />что функциональность этого кода огромна, а документация - м-да, хромает, мягко<br />выражаясь. Сам Кузнецов советует разбирать исходники ядра - для тех, кто сможет,<br />захочет, имеет время, и т.д. и т.п.<br /><br />Ну а я попробую, насколько это возможно, сжато рассмотреть стандартный и нестандартные<br />методы маскарада, и NAT. Стандартный случай: необходимо маскарадить исходящие пакеты<br />хоста 192.168.1.1 в 207.46.230.219. Подход к решению этой задачи полностью аналогичен<br />случаю с более ранними ядрами. Необходимо лишь учесть, что в системах с этими ядрами<br />утилиты ipfwadm нет, вместо нее используется ipchains. Сразу перейдем к рассмотрению<br />более сложных случаев. Допустим, как и в предыдущем примере, пакеты с разных машин,<br />необходимо транслировать в разные адреса.<br /><br />Тут придется прибегнуть к утилите ip из пакета iproute. Изобразим следующие команды:<br /><br />ip rule add from 192.168.1.1 nat 207.46.230.219<br />ip rule add from 192.168.1.2 nat 207.46.230.229<br /><br />кроме того:<br /><br />ip route add nat 207.46.230.219 via 192.168.1.1<br />ip route add nat 207.46.230.229 via 192.168.1.2<br /><br />Результатом этих действий будет маскарад и демаскарад адресов 192.168.1.1<br />и 192.168.1.2, соответственно в 207.46.230.219 и 229.<br /><br />Вот такие пирожки. Это все теория и стандартные случаи, давайте рассмотрим более<br />интересный и совсем реальный пример. Имеется сеть на ~250 машин, линукс красная<br />шапочка версии 6.2, в роли маршрутизатора, и выполняющий маскарад внутренних машин<br />под адрес, допустим, 207.46.230.219. Линукс включен в машину провайдера витой парой,<br />из сетевой в сетевую. Кроме того, провайдер, естественно, не желает тратить отдельный<br />ip-адрес на сетевую в которую включен наш линукс.<br /><br />Вопрос: как это реализовать на линуксе? Вообще-то весьма просто. Для начала объясним<br />линуксу, как посылать пакеты на машину провайдера. Она находиться не в одной<br />логической сети с нами, а потому изначально линукс не знает как туда попасть.<br />Для этого укажем:<br /><br />route add -host 192.168.100.1 eth1<br /><br />что означает: машина 192.168.100.1 подсоединена непосредственно к интерфейсу eth1.<br />Далее, укажем, что все пакеты, предназначенные для интернета отсылать через машину<br />провайдера:<br /><br />route add default gw 192.168.100.1<br /><br />и остается лишь прописать правила маскарада. Допустим, я хочу, что бы машины<br />с адресами 192.168.1.101-105 ходили в интернет, а другие нет:<br /><br />ipchains -A forward -s 192.168.1.101 -j MASQ<br />ipchains -A forward -s 192.168.1.102 -j MASQ<br />ipchains -A forward -s 192.168.1.103 -j MASQ<br />ipchains -A forward -s 192.168.1.104 -j MASQ<br />ipchains -A forward -s 192.168.1.105 -j MASQ<br /><br />ipchains -A forward -j REJECT -l<br /><br />Ну вот, в общем, на сегодня и все.<br /><br /></p></body></html>