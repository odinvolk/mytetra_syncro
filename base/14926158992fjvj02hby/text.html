<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Когда использовать двойников в тестах</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как уже упоминалось в первой части данной серии статей, одной из мощнейших возможностей phpunit являются &quot;двойники&quot; для тестов. Очень часто в нашем коде функция одного класса вызывает функцию другого класса. В этом случае, мы имеем зависимость в этих двух классах. В частности, вызывающий класс имеет зависимость от вызываемого класса. Но как мы уже знаем из первой части, юнит-тест должен тестировать функциональную единицу, в этом случае, он должен проверить только в вызывающую функцию. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы решить эту проблему, мы можем использовать &quot;двойника&quot; для подмены вызываемого класса. Так как двойник может быть настроен возвращать предопределенные результаты, мы можем сосредоточиться на тестировании в вызывающей функции.</p>
<hr />
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Типы тестовых &quot;двойников&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Тестовый &quot;двойник&quot; — это общий термин для объектов, которые мы используем, чтобы заменить реальные объекты. На наш взгляд, это очень полезно для классификации тестовых &quot;двойников&quot; по их назначению. Это не только облегчит нам понимание описанного тестируемого случая, но и сделает наш код более дружелюбным и читаемым для других.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Опираясь на <a href="http://www.martinfowler.com/bliki/TestDouble.html"><span style=" text-decoration: underline; color:#0000ff;">пост Мартина Фаулера</span></a>, есть пять типов тестовых &quot;двойников&quot;:</p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Dummy</span> (манекены/заглушки) предназначены для работы в обход, но фактически никогда не используются. Обычно они просто используются чтобы заполнять список параметров. </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Fake</span> (фальшивки) действительно имеют работающие реализации, но обычно имеют некоторое упрощение, которое делает их непригодными для боевого применения. </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Stubs</span> (заглушки/огрызки) обеспечивают консервированные ответы на вызовы, сделанные во время теста, как правило, не отвечают вообще ни на что извне, кроме того, что запрограммировано для теста. </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Spies</span> (шпионы) являются заглушками (stub-ом), которые, кроме того, регистрируют определенную информацию, основываясь на том, как они назывались. Одним из примеров этого может быть почтовый сервис, который записывает, сколько сообщений было отправлено. </li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Mocks</span> (подражатели/притворщики) запрограммированы с ожиданиями, которые формируют спецификацию вызова, который они ожидали получить. Они могут выбросить исключение, если они были вызваны не так, как они ожидали, и выполняют проверки, чтобы убедиться, что они получили все вызовы, которые они ожидали.</li></ol>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Как создать тестового &quot;двойника&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В PhpUnit метод <span style=" font-family:'Courier New,courier'; font-weight:600;">getMockBuilder</span> может быть использован для создания любых подобных объектов, определяемых пользователем. В сочетании с настраиваемым интерфейсом, мы можем использовать его, чтобы создать, по сути, все <span style=" font-weight:600;">пять</span> типов тестовых &quot;двойников&quot;.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Добавление &quot;двойника&quot; в наш первый unit-тест</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Не имеет смысла использовать &quot;двойника&quot; для тестов нашего калькулятора, поскольку в настоящее время калькулятор класса не имеет зависимостей от других классов. Однако, чтобы продемонстрировать, как использовать &quot;двойников&quot; с помощью PhpUnit, мы создадим stub для класса <span style=" font-family:'Courier New,courier';">Calculator</span> и протестируем его.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Давайте добавим тест под названием <span style=" font-family:'Courier New,courier';">testWithStub</span> в наш существующий класс:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">public function testWithStub()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">    // Create a stub for the Calculator class.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">    $calculator = $this-&gt;getMockBuilder('Calculator')</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">                       -&gt;getMock();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans Mono'; color:#6a0e07;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">    // Configure the stub.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">    $calculator-&gt;expects($this-&gt;any())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">               -&gt;method('add')</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">               -&gt;will($this-&gt;returnValue(6));</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans Mono'; color:#6a0e07;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">    $this-&gt;assertEquals(6, $calculator-&gt;add(100,100));</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#6a0e07;">}</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">getMockBuilder()</span> метод создает заглушку (stub), похожую на объект нашего класса <span style=" font-family:'Courier New,courier';">Calculator</span>. </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">getMock()</span> возвращает объект этой заглушки. </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">expects()</span> говорит, что stub будет вызываться любое число раз. </li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">method()</span> определяет, какой метод будет вызван. </li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">will()</span> настраивает возвращаемое значение в stub.</li></ol>
<p style="-qt-paragraph-type:empty; margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Заключение</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы должны были накопить достаточно знаний о PhpUnit, чтобы начать реализовывать unit-тесты в своём коде. Если вам требуется больше информации, можете обратиться к <a href="https://phpunit.de/documentation.html"><span style=" text-decoration: underline; color:#0000ff;">официальной документации</span></a> и конкретно к <a href="https://phpunit.de/manual/current/en/test-doubles.html"><span style=" text-decoration: underline; color:#0000ff;">разделу о &quot;двойниках&quot;</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Надеюсь, это простое руководство помогло вам в понимании тестирования приложений.<br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>