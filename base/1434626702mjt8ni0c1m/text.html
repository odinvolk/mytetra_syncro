<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Поиск неиспользуемых аккаутов пользователей и компьютеров в AD c помощью PowerShell и другие примеры</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Начнем с вопроса, который часто волнует сисадминов: как узнать какие аккаунты AD уже не используются? Для определения задачи уточним формулировку: какие аккаунты не  используются долгое время (например полгода)?</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод списка компьютеров, не имевших входа в домен более 6 месяцев:<br /><span style=" color:#b22222;">get-adcomputer -properties lastLogonDate -filter * | where { $_.lastLogonDate -lt (get-date).addmonths(-6) } | FT Name,LastLogonDate</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Отсортируем немного вывод для удобочитаемости:<br /><span style=" color:#b22222;">get-adcomputer -properties lastLogonDate -filter * | where { $_.lastLogonDate -lt (get-date).addmonths(-6) } | sort Name | FT Name,LastLogonDate</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление всех учетных записей компьютеров с отсутствием входа более 6 месяцев (мой совет, не копипастите этот командлет без осознания содеянного):<br /><span style=" color:#b22222;">get-adcomputer -properties lastLogonDate -filter * | where { $_.lastLogonDate -lt (get-date).addmonths(-6) } | Remove-ADComputer</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поиск отключенных аккаунтов пользователей с выводом примерной даты отключения (последнего входа этого пользователя в домен)<br /><span style=" color:#b22222;">Search-ADAccount -accountdisabled | where {$_.lastlogondate -lt (get-date).addmonths(-12)} | FT Name,LastLogonDate</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Другие полезные примеры</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просмотр всех учетных записей компьютеров в домене:<br /><span style=" color:#b22222;">Get-ADComputer –Filter {Name –Like &quot;*&quot;}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просмотр всех компьютеров не имевших вход 90 дней:<br /><span style=" color:#b22222;">Search-ADaccount -AccountInactive -Timespan 90 -ComputersOnly</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">или</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#b22222;">$lastLogon = (get-date).adddays(-90).ToFileTime()<br />Get-ADComputer -filter {lastLogonTimestamp -gt $lastLogon}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поиск и удаление всех отключенных аккаунтов компьютеров в AD<br /><span style=" color:#b22222;">Search-ADAccount -AccountDisabled -ComputersOnly | Sort-Object | Remove-ADComputer</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поиск и удаление отключенных аккаунтов компьютеров в определенном OU<br /><span style=" color:#b22222;">Search-ADAccount -AccountDisabled -Searchbase &quot;OU=IT,DC=Contoso,DC=Com&quot; -ComputersOnly | Sort-Object | Remove-ADComputer</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поиск и удаление всех компьютеров из AD не имеющих входа с 18.12.2011<br /><span style=" color:#b22222;">Search-ADAccount -AccountInactive -DateTime &quot;18.12.2011&quot; –ComputersOnly | Sort-Object | Remove-ADComputer</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод списка отключенных учетных записей компьютеров<br /><span style=" color:#b22222;">Search-ADAccount -AccountDisabled -ComputersOnly | Format-Table Name</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перемещение объекта &quot;Компьютер&quot; в другой OU (например: Computer=CLIENT1 в OU=IT )<br /><span style=" color:#b22222;">Get-ADComputer CLIENT1 | Move-ADObject -TargetPath &quot;OU=IT,DC=Contoso,DC=Com&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просмотреть детали учетной записи компьютера (для примера Computer=CLIENT1)<br /><span style=" color:#b22222;">Get-ADComputer -Filter {Name -Like &quot;CLIENT1&quot;}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод всех свойств учетной записи компьютера (для примера Computer=CLIENT1)<br /><span style=" color:#b22222;">Get-ADComputer &quot;CLIENT1&quot; -Properties *</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод списка компьютеров (Имя, Операционная система, Сервис-Пак, Версия ОС)<br /><span style=" color:#b22222;">Get-ADComputer -Filter * -Property * | Format-Table Name,OperatingSystem,OperatingSystemServicePack,OperatingSystemVersion -Wrap –Auto</span><br /><br />Экспорт списка комьютеров  (Имя, Операционная система, Сервис-Пак, Версия ОС) в CSV-файл<br /><span style=" color:#b22222;">Get-ADComputer -Filter * -Property * | Select-Object Name,OperatingSystem,OperatingSystemServicePack,OperatingSystemVersion | Export-CSV AllWindows.csv -NoTypeInformation -Encoding UTF8</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получение DNS имени и IP-адреса<br /><span style=" color:#b22222;">Get-ADComputer -Filter {Name -Like &quot;Computer-Name&quot;} -Properties IPv4Address | Format-List Name,DnsHostName,IPv4Address</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список всех компьютеров в определенном (для примера OU=IT, Domain=domain.com)<br /><span style=" color:#b22222;">Get-ADComputer -SearchBase &quot;OU=IT,DC=domain,DC=Com&quot; -filter *</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получение списка всех компьютеров без DNS суффикса<br /><span style=" color:#b22222;">Get-ADComputer -filter &quot;DnsHostName -notlike '*.domain.Com'&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получение SPNs (Service Principal Name) компьютера<br /><span style=" color:#b22222;">Get-ADComputer &quot;Computer-Name&quot; –Properties ServicePrincipalNames | Select-Object –Expand ServicePrincipalNames</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получение Сида (SIDs) компьютера<br /><span style=" color:#b22222;">Get Computers Security Identifiers (SIDs)<br />Get-ADComputer -Filter {Name -like &quot;*&quot;} | Select Name,SID | Format-Table -Auto</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список компьютеров созданных за последние 90 дней<br /><span style=" color:#b22222;">Get-ADComputer -Filter * -Properties whenCreated | ? { ((Get-Date) - $_.whenCreated).Days -lt 90} | Format-Table Name,WhenCreated,Name,DistinguishedName -Autosize -Wrap</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список компьютеров созданных 1 декабря 2011 (12/01/2011)<br /><span style=" color:#b22222;">Get-ADComputer -LDAPFilter &quot;(&amp;(objectCategory=person)(whenCreated&gt;=20111201000000.0Z))&quot; -Properties whenCreated | Format-Table Name,whenCreated,distinguishedName -Autosize -Wrap</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список компьютеров созданных в интервал времени, например между 10/01/2011 и 12/01/2011<br /><span style=" color:#b22222;">$Start = Get-Date -Day 01 -Month 10 -Year 2011 -Hour 00<br />$End = Get-Date -Day 01 -Month 12 -Year 2011 -Hour 23 -Minute 59<br />Get-ADComputer -Filter * -Properties whenCreated | ? { ($_.whenCreated -gt $Start) -and ($_.whenCreated -le $End) } | Format-Table Name,WhenCreated,DistinguishedName -Autosize -Wrap</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Работа с группами</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просмотра всех участников группы (для примера: Group=Experts)<br /><span style=" color:#b22222;">Get-ADGroupMember Experts | Format-Table Name</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вывод списка свойств для группы (для примера: Group=IT)<br /><span style=" color:#b22222;">Get-ADGroup IT -Properties *</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список только универсальных групп (Universal Security groups)<br /><span style=" color:#b22222;">Get-ADGroup –LDAPFilter &quot;(&amp;(objectCategory=group)(groupType:1.2.840.113556.1.4.803:=-2147483640))&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список глобальных групп (Global Security groups)<br /><span style=" color:#b22222;">Get-ADGroup –LDAPFilter &quot;(&amp;(objectCategory=group)(groupType:1.2.840.113556.1.4.803:=-2147483646))&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список локальных групп в домене (Local Security groups)<br /><span style=" color:#b22222;">Get-ADGroup –LDAPFilter &quot;(&amp;(objectCategory=group)(groupType:1.2.840.113556.1.4.803:=-2147483644))&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Узнать список групп в которые включен пользоатель (для примера: User=EdPrice)<br /><span style=" color:#b22222;">Get-ADAccountAuthorizationGroup EdPrice</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перемещение группы в другой OU (для примера: Group=Experts, Old-OU=IT, New-OU=Service, Domain=Contoso.com)<br /><span style=" color:#b22222;">Move-ADObject &quot;CN=Experts,OU=IT,DC=Contoso,DC=com&quot; -TargetPath &quot;OU=Service,DC=Contoso,DC=com&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Добавление пользователя в группу (для примера: Group=Experts, User=EdPrice)<br /><span style=" color:#b22222;">Add-ADGroupmember Experts -Member EdPrice</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление группы (для примера: Group=Experts)<br /><span style=" color:#b22222;">Remove-ADGroup Experts</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление пользоателя из группы (для примера Group=Experts, User=EdPrice)<br /><span style=" color:#b22222;">Remove-ADGroupMember Experts -Member EdPrice</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Установить описание для группы (для примера  Group=JoinPC, Description=This group is allowed join PCs to Domain)<br /><span style=" color:#b22222;">Set-ADGroup JoinPC -Description &quot;This group is allowed join PCs to Domain&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Работа с OU</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все OU (Organization Unit или Подразделение) в домене<br /><span style=" color:#b22222;">Get-ADOrganizationalUnit -Filter {Name -like „*“} | FT Name, DistinguishedName -A</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создание OU (для примера OU=IT, Domain=domain.com)<br /><span style=" color:#b22222;">New-ADOrganizationalUnit -Name IT -Path &quot;DC=Domain,DC=Com&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Содержание определенного OU (для примера: OU=IT, Domain=Contoso.com)<br /><span style=" color:#b22222;">Get-ADObject -Filter {Name -Like &quot;*&quot;} -Searchbase &quot;OU=IT,DC=Contoso,DC=Com&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление OU (для примера: Old-Name=IT, New-Name=Admin, Domain=Contoso.com)<br /><span style=" color:#b22222;">Rename-ADObject &quot;OU=IT,DC=Contoso,DC=Com&quot; -NewName Admin</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление содержимого OU (для примера: OU=IT, Domain=Contoso.com)<br />Delete OU including contents (example: OU=IT, Domain=Contoso.com)<br /><span style=" color:#b22222;">Remove-ADOrganizationalUnit IT -Recursive</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление пользователя из определенного OU (для примера: User=EdPrice, OU=IT, Domain=Contoso.com )<br /><span style=" color:#b22222;">Remove-ADObject &quot;CN=EdPrice,OU=IT,DC=Contoso,DC=Com&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перемещение всех объектов из одного OU в другой (для примера: Old-OU=IT, New-OU=Manager, Domain=Contoso.com)<br /><span style=" color:#b22222;">Get-ADObject -Filter {Name -Like &quot;*&quot;} -Searchbase &quot;OU=IT,DC=Contoso,DC=Com&quot; -SearchScope OneLevel | Move-ADObject -TargetPath &quot;OU=Manager,DC=Contoso,DC=Com&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Работа с пользователями</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список всех пользователей домена<br /><span style=" color:#b22222;">Get-ADUser –Filter *</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список пользователей определенного OU (для примера: OU=IT, Domain=Contoso.com)<br /><span style=" color:#b22222;">Get-ADUser –Filter * -Searchbase &quot;OU=IT,DC=Contoso,DC=Com&quot; | FT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список всех пользователей из определенного города (поле City)<br /><span style=" color:#b22222;">Get ADUser -Filter {city - like &quot;NewYork&quot;} | FT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список отключенных аккаунтов пользователей домена</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#b22222;">Search-ADAccount –AccountDisabled –Usersonly | FT Name</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список всех пользователей, чье имя начинается на Ed<br /><span style=" color:#b22222;">Get-ADUser –Filter {givenName –Like &quot;Ed&quot;} | FT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список пользователей, чья фамилия Prince<br /><span style=" color:#b22222;">Get-ADUser –Filter {Surname –Like &quot;Price&quot;} | FT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список аккаунтов пользоатлей определенного департамента (поле Department)<br /><span style=" color:#b22222;">Get-ADUser –Filter {Department –Like &quot;Support&quot;} | FT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Список членства в группах определенного пользователя (для примера:<br /><span style=" color:#b22222;">Get-ADPrincipalGroupMembership -Identity Richard</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поиск пользователей входящих в определенную группу и перемещение их в другой OU (для примера: Group=People, Target OU=NewYork, Domain=Contoso.com)<br /><span style=" color:#b22222;">Get-ADGroupMember People -Recursive | Move-ADObject  –TargetPath &quot;OU=NewYork,DC=Contoso,DC=Com&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаление всех пользователей OU в определенную группу (для примера: Group=People, OU=NewYork, Domain=Contoso.com)<br /><span style=" color:#b22222;">$Users = Get-ADUser -Filter * -Searchbase &quot;OU=NewYork,DC=Contoso,DC=Com&quot;<br />Remove-ADGroupMember -Identity People -Member $Users -Confirm:0</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#b22222;"><br /></p></body></html>