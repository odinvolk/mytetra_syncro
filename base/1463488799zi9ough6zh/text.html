<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="content"></a><span style=" font-family:'DejaVu Sans'; font-size:10pt; color:#000000;">Р</span><span style=" font-family:'DejaVu Sans'; font-size:10pt; color:#000000;">уководство для начинающих</span></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" width="100%" cellspacing="2" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">В этом руководстве рассматироваются темы:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Запуск, остановка, перезагрузка конфигурации</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Структура конфигурационного файла</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Раздача статического содержимого</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройка простого прокси-сервера</li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Настройка проксирования FastCGI</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt; color:#000000;"><br /></p></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">В этом руководстве даётся начальное введение в nginx и описываются некоторые простые задачи, которые могут быть решены с его помощью. Предполагается, что nginx уже установлен на компьютере читателя. Если нет, см. </span><a href="http://nginx.org/ru/docs/install.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Установка nginx</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. В этом руководстве описывается, как запустить и остановить nginx и перезагрузить его конфигурацию, объясняется, как устроен конфигурационный файл, и описывается, как настроить nginx для раздачи статического содержимого, как настроить прокси-сервер на nginx, и как связать nginx с приложением FastCGI. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">У nginx есть один главный и несколько рабочих процессов. Основная задача главного процесса — чтение и проверка конфигурации и управление рабочими процессами. Рабочие процессы выполняют фактическую обработку запросов. nginx использует модель, основанную на событиях, и зависящие от операционной системы механизмы для эффективного распределения запросов между рабочими процессами. Количество рабочих процессов задаётся в конфигурационном файле и может быть фиксированным для данной конфигурации или автоматически устанавливаться равным числу доступных процессорных ядер (см. </span><a href="http://nginx.org/ru/docs/ngx_core_module.html#worker_processes"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">worker_processes</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Как работают nginx и его модули, определяется в конфигурационном файле. По умолчанию, конфигурационный файл называется </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">nginx.conf</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и расположен в каталоге </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/usr/local/nginx/conf</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/etc/nginx</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> или </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/usr/local/etc/nginx</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Запуск, остановка, перезагрузка конфигурации</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Чтобы запустить nginx, нужно выполнить исполняемый файл. Когда nginx запущен, им можно управлять, вызывая исполняемый файл с параметром </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">-s</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Используйте следующий синтаксис: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">nginx -s </span><span style=" font-family:'Courier New,courier'; font-size:10pt; font-style:italic;">сигнал</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Где </span><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-style:italic;">сигнал</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> может быть одним из нижеследующих: </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">stop</span> — быстрое завершение </li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">quit</span> — плавное завершение </li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">reload</span> — перезагрузка конфигурационного файла </li>
<li style=" font-family:'DejaVu Sans'; font-size:10pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">reopen</span> — переоткрытие лог-файлов </li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Например, чтобы остановить процессы nginx с ожиданием окончания обслуживания текущих запросов рабочими процессами, можно выполнить следующую команду: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">nginx -s quit</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Команда должна быть выполнена под тем же пользователем, под которым был запущен nginx.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Изменения, сделанные в конфигурационном файле, не будут применены, пока команда перезагрузить конфигурацию не будет вручную отправлена nginx’у или он не будет перезапущен. Для перезагрузки конфигурации выполните: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">nginx -s reload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Получив сигнал, главный процесс проверяет правильность синтаксиса нового конфигурационного файла и пытается применить конфигурацию, содержащуюся в нём. Если это ему удаётся, главный процесс запускает новые рабочие процессы и отправляет сообщения старым рабочим процессам с требованием завершиться. В противном случае, главный процесс откатывает изменения и продолжает работать со старой конфигурацией. Старые рабочие процессы, получив команду завершиться, прекращают принимать новые запросы и продолжают обслуживать текущие запросы до тех пор, пока все такие запросы не будут обслужены. После этого старые рабочие процессы завершаются. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Посылать сигналы процессам nginx можно также средствами Unix, такими как утилита </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">kill</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. В этом случае сигнал отправляется напрямую процессу с данным ID. ID главного процесса nginx записывается по умолчанию в файл </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">nginx.pid</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> в каталоге </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/usr/local/nginx/logs</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> или </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/var/run</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Например, если ID главного процесса равен 1628, для отправки сигнала QUIT, который приведёт к плавному завершению nginx, нужно выполнить: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">kill -s QUIT 1628</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Для просмотра списка всех запущенных процессов nginx может быть использована утилита </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">ps</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, например, следующим образом: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">ps -ax | grep nginx</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Дополнительную информацию об отправке сигналов процессам nginx можно найти в </span><a href="http://nginx.org/ru/docs/control.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">Управление nginx</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p align="center" style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Структура конфигурационного файла</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">nginx состоит из модулей, которые настраиваются директивами, указанными в конфигурационном файле. Директивы делятся на простые и блочные. Простая директива состоит из имени и параметров, разделённых пробелами, и оканчивается точкой с запятой (</span><span style=" font-family:'Courier New,courier'; font-size:10pt;">;</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">). Блочная директива устроена так же, как и простая директива, но вместо точки с запятой после имени и параметров следует набор дополнительных инструкций, помещённых внутри фигурных скобок (</span><span style=" font-family:'Courier New,courier'; font-size:10pt;">{</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">). Если у блочной директивы внутри фигурных скобок можно задавать другие директивы, то она называется контекстом (примеры: </span><a href="http://nginx.org/ru/docs/ngx_core_module.html#events"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">events</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#http"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">http</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#server"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">server</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#location"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">location</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Директивы, помещённые в конфигурационном файле вне любого контекста, считаются находящимися в контексте </span><a href="http://nginx.org/ru/docs/ngx_core_module.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">main</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Директивы </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">events</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">http</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> располагаются в контексте </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">main</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> — в </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">http</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, а </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> — в </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Часть строки после символа </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">#</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> считается комментарием. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Раздача статического содержимого</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Одна из важных задач конфигурации nginx — раздача файлов, таких как изображения или статические HTML-страницы. Рассмотрим пример, в котором в зависимости от запроса файлы будут раздаваться из разных локальных каталогов: </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/www</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, который содержит HTML-файлы, и </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, содержащий файлы с изображениями. Для этого потребуется отредактировать конфигурационный файл и настроить блок </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#server"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">server</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> внутри блока </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#http"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">http</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> с двумя блоками </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#location"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">location</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Во-первых, создайте каталог </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/www</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и положите в него файл </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">index.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> с любым текстовым содержанием, а также создайте каталог </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и положите в него несколько файлов с изображениями. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Далее, откройте конфигурационный файл. Конфигурационный файл по умолчанию уже включает в себя несколько примеров блока </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, большей частью закомментированных. Для нашей текущей задачи лучше закомментировать все такие блоки и добавить новый блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">http {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">В общем случае конфигурационный файл может содержать несколько блоков </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><a href="http://nginx.org/ru/docs/http/request_processing.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">различаемых</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> по портам, на которых они </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#listen"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">слушают</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, и по </span><a href="http://nginx.org/ru/docs/http/server_names.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">имени сервера</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Определив, какой </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> будет обрабатывать запрос, nginx сравнивает URI, указанный в заголовке запроса, с параметрами директив </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, определённых внутри блока </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">В блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> добавьте блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> следующего вида: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    root /data/www;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Этот блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> задаёт “</span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">” в качестве префикса, который сравнивается с URI из запроса. Для подходящих запросов добавлением URI к пути, указанному в директиве </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#root"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">root</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, то есть, в данном случае, к </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/www</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, получается путь к запрашиваемому файлу в локальной файловой системе. Если есть совпадение с несколькими блоками </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, nginx выбирает блок с самым длинным префиксом. В блоке </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> выше указан самый короткий префикс, длины один, и поэтому этот блок будет использован, только если не будет совпадения ни с одним из остальных блоков </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Далее, добавьте второй блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">location /images/ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    root /data;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Он будет давать совпадение с запросами, начинающимися с </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/images/</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> (</span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location /</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> для них тоже подходит, но указанный там префикс короче). </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Итоговая конфигурация блока </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> должна выглядеть следующим образом: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        root /data/www;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location /images/ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        root /data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Это уже работающая конфигурация сервера, слушающего на стандартном порту 80 и доступного на локальном компьютере по адресу </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">http://localhost/</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. В ответ на запросы, URI которых начинаются с </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/images/</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, сервер будет отправлять файлы из каталога </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Например, на запрос </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">http://localhost/images/example.png</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> nginx отправит в ответ файл </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images/example.png</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Если же этот файл не существует, nginx отправит ответ, указывающий на ошибку 404. Запросы, URI которых не начинаются на </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/images/</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, будут отображены на каталог </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/www</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Например, в результате запроса </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">http://localhost/some/example.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> в ответ будет отправлен файл </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/www/some/example.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Чтобы применить новую конфигурацию, запустите nginx, если он ещё не запущен, или отправьте сигнал </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">reload</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> главному процессу nginx, выполнив: </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">nginx -s reload</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">В случае если что-то работает не как ожидалось, можно попытаться выяснить причину с помощью файлов </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">access.log</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">error.log</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> из каталога </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/usr/local/nginx/logs</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> или </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/var/log/nginx</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Настройка простого прокси-сервера</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Одним из частых применений nginx является использование его в качестве прокси-сервера, то есть сервера, который принимает запросы, перенаправляет их на проксируемые сервера, получает ответы от них и отправляет их клиенту. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Мы настроим базовый прокси-сервер, который будет обслуживать запросы изображений из локального каталога и отправлять все остальные запросы на проксируемый сервер. В этом примере оба сервера будут работать в рамках одного экземпляра nginx. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Во-первых, создайте проксируемый сервер, добавив ещё один блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> в конфигурационный файл nginx со следующим содержимым: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    listen 8080;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    root /data/up1;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Это будет простой сервер, слушающий на порту 8080 (ранее директива </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">listen</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> не указывалась, потому что использовался стандартный порт 80) и отображающий все запросы на каталог </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/up1</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> в локальной файловой системе. Создайте этот каталог и положите в него файл </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">index.html</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Обратите внимание, что директива </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">root</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> помещена в контекст </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">server</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Такая директива </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">root</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> будет использована, когда директива </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, выбранная для выполнения запроса, не содержит собственной директивы </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">root</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Далее, используйте конфигурацию сервера из предыдущего раздела и видоизмените её, превратив в конфигурацию прокси-сервера. В первый блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> добавьте директиву </span><a href="http://nginx.org/ru/docs/http/ngx_http_proxy_module.html#proxy_pass"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">proxy_pass</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, указав протокол, имя и порт проксируемого сервера в качестве параметра (в нашем случае это </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">http://localhost:8080</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">): </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        proxy_pass http://localhost:8080;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location /images/ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        root /data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Мы изменим второй блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, который на данный момент отображает запросы с префиксом </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/images/</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> на файлы из каталога </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> так, чтобы он подходил для запросов изображений с типичными расширениями файлов. Изменённый блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> выглядит следующим образом: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">location ~ \.(gif|jpg|png)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    root /data/images;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Параметром является регулярное выражение, дающее совпадение со всеми URI, оканчивающимися на </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">.gif</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">.jpg</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> или </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">.png</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Регулярному выражению должен предшествовать символ </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">~</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Соответствующие запросы будут отображены на каталог </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Когда nginx выбирает блок </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, который будет обслуживать запрос, то вначале он проверяет директивы </span><a href="http://nginx.org/ru/docs/http/ngx_http_core_module.html#location"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">location</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, задающие префиксы, запоминая </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> с самым длинным подходящим префиксом, а затем проверяет регулярные выражения. Если есть совпадение с регулярным выражением, nginx выбирает соответствующий </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, в противном случае берётся запомненный ранее </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">location</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Итоговая конфигурация прокси-сервера выглядит следующим образом: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        proxy_pass http://localhost:8080/;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location ~ \.(gif|jpg|png)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        root /data/images;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Этот сервер будет фильтровать запросы, оканчивающиеся на </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">.gif</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">.jpg</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> или </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">.png</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, и отображать их на каталог </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">/data/images</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> (добавлением URI к параметру директивы </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">root</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">) и перенаправлять все остальные запросы на проксируемый сервер, сконфигурированный выше. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Чтобы применить новую конфигурацию, отправьте сигнал </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">reload</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> nginx’у, как описывалось в предыдущих разделах. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Существует </span><a href="http://nginx.org/ru/docs/http/ngx_http_proxy_module.html"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">множество</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> других директив для дальнейшей настройки прокси-соединения. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Настройка проксирования FastCGI</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">nginx можно использовать для перенаправления запросов на FastCGI-серверы. На них могут исполняться приложения, созданные с использованием разнообразных фреймворков и языков программирования, например, PHP. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Базовая конфигурация nginx для работы с проксируемым FastCGI-сервером включает в себя использование директивы </span><a href="http://nginx.org/ru/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">fastcgi_pass</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> вместо директивы </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">proxy_pass</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, и директив </span><a href="http://nginx.org/ru/docs/http/ngx_http_fastcgi_module.html#fastcgi_param"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">fastcgi_param</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> для настройки параметров, передаваемых FastCGI-серверу. Представьте, что FastCGI-сервер доступен по адресу </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">localhost:9000</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Взяв за основу конфигурацию прокси-сервера из предыдущего раздела, замените директиву </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">proxy_pass</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> на директиву </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">fastcgi_pass</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> и измените параметр на </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">localhost:9000</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. В PHP параметр </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">SCRIPT_FILENAME</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> используется для определения имени скрипта, а в параметре </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">QUERY_STRING</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> передаются параметры запроса. Получится следующая конфигурация: </span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        fastcgi_pass  localhost:9000;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        fastcgi_param QUERY_STRING    $query_string;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:10pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    location ~ \.(gif|jpg|png)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">        root /data/images;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:10pt;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Таким образом будет настроен сервер, который будет перенаправлять все запросы, кроме запросов статических изображений, на проксируемый сервер, работающий по адресу </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">localhost:9000</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, по протоколу FastCGI. </span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p></body></html>