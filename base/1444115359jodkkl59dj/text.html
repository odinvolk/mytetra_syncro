<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Миф №5: ключ </span><span style=" font-family:'Courier New,courier'; font-size:xx-large; font-weight:600;">/3GB</span><span style=" font-size:xx-large; font-weight:600;"> расширяет пользовательское адресное пространство для всех программ</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ну, давайте включим режим <span style=" font-family:'Courier New,courier';">/3GB</span> и запустим нашу программу пример, где <span style=" font-family:'Courier New,courier';">AllocMem</span> выделяет <span style=" font-family:'Courier New,courier';">100</span> Мб. Будем нажимать на кнопку, пока не возникнет сообщение о нехватке памяти и посмотрим, сколько же памяти нам удалось выделить:<br /><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23192.png" width="1060" height="51" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Как видим, это существенно меньше ожидаемых <span style=" font-family:'Courier New,courier';">3</span> Гб памяти.<br /><br />На самом деле, режим <span style=" font-family:'Courier New,courier';">/3GB</span> влияет только на программы с <a href="http://msdn.microsoft.com/en-us/library/wz223b1z(VS.80).aspx"><span style=" text-decoration: underline; color:#0000ff;">флагом </span></a><a href="http://msdn.microsoft.com/en-us/library/wz223b1z(VS.80).aspx"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">IMAGE_FILE_LARGE_ADDRESS_AWARE</span></a>.<br /><br />По соображениям совместимости, только программы, которые явно пометили себя, что они умеют обрабатывать виртуальное адресное пространство больше <span style=" font-family:'Courier New,courier';">2</span> Гб, получат большее адресное пространство. Не помеченные программы получат свои обычные <span style=" font-family:'Courier New,courier';">2</span> Гб, а адресное пространство между <span style=" font-family:'Courier New,courier';">2</span> Гб и <span style=" font-family:'Courier New,courier';">3</span> Гб не будет использоваться вовсе. <br /><br />Почему? <br /><br />Потому что слишком много программ предполагают, что старший бит адреса в пользовательском режиме всегда очищен (т.е. равен <span style=" font-family:'Courier New,courier';">0</span>), часто делая это невольно. В MSDN есть <a href="http://msdn.microsoft.com/en-us/library/bb613473(VS.85).aspx"><span style=" text-decoration: underline; color:#0000ff;">страничка</span></a>, на которой перечисленны несколько способов использования такого предположения. Например, вы можете захотеть найти средний адрес между двумя другими - используя для этого формулу <span style=" font-family:'Courier New,courier';">(a + b) / 2</span>. Но если <span style=" font-family:'Courier New,courier';">a</span> и <span style=" font-family:'Courier New,courier';">b</span> будут больше <span style=" font-family:'Courier New,courier';">2</span> Гб, то их сумма не влезет в <span style=" font-family:'Courier New,courier';">4</span>-х байтное целое - следовательно, вы получите неверный результат (для верного вычисления надо использовать выражение <span style=" font-family:'Courier New,courier';">a + (b - a) / 2</span>). Соответственно, вы не можете просто взять программу, которую вы не писали, пометить её флагом <span style=" font-family:'Courier New,courier';">IMAGE_FILE_LARGE_ADDRESS_AWARE</span> и объявить, что дело сделано. Вам вместе с авторами программы надо проверить, что код не делает никаких предположений насчёт этих <span style=" font-family:'Courier New,courier';">2</span> Гб (а тот факт, что программа не была помечена, как совместимая с <span style=" font-family:'Courier New,courier';">3</span> Гб, означает, что никаких проверок не было сделано. В самом деле - в противном случае она была бы уже помечена флагом <span style=" font-family:'Courier New,courier';">IMAGE_FILE_LARGE_ADDRESS_AWARE</span>!).<br /><br />Пометка вашей программы флагом <span style=" font-family:'Courier New,courier';">IMAGE_FILE_LARGE_ADDRESS_AWARE</span> указывает операционной системе: &quot;давай, дай мне доступ к этой дополнительной памяти пользовательского адресного пространства&quot;, в результате адреса выше <span style=" font-family:'Courier New,courier';">2</span>-х Гб становятся возможными возвращаемыми значениями в функциях выделения памяти. <a href="http://msdn.microsoft.com/en-us/windows/hardware/gg487503.aspx#EFHAC"><span style=" text-decoration: underline; color:#0000ff;">Если вы установите флаг &quot;Top down&quot; в предпочтениях менеджера памяти</span></a>, вы можете указать менеджеру памяти выделять память сначала по старшим адресам, таким образом, вы заставите свою программу работать на высоких адресах сразу же, а не когда заполнится остальное место. Это очень удобный режим для проверки вашей программы в конфигурации <span style=" font-family:'Courier New,courier';">/3GB</span>, посольку он заставляет скорее, чем в обычном режиме, использовать проблемные адреса.<br /><br />Итак, давайте включим <span style=" font-family:'Courier New,courier';">IMAGE_FILE_LARGE_ADDRESS_AWARE</span> для нашей программы: <br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="0" cellpadding="0">
<tr>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">2</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">6</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">7</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">8</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">9</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">10</span></p></td>
<td>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">project Project1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">uses</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">  Windows; // для определения IMAGE_FILE_LARGE_ADDRESS_AWARE</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">{$SetPEFlags IMAGE_FILE_LARGE_ADDRESS_AWARE}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">end.</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Или (<span style=" font-family:'Courier New,courier';">IMAGE_FILE_LARGE_ADDRESS_AWARE = $20</span> или <span style=" font-family:'Courier New,courier';">32</span>):<br /><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image31106.png" /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />...и посмотрим, как это изменит ситуацию:<br /><br /></p>
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image10362.png" width="1062" height="52" /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Больше <span style=" font-family:'Courier New,courier';">2</span> Гб - что и требовалось показать (кстати, это же является примером и к предыдущему мифу).<br /><br />Статус мифа: <span style=" font-weight:600; color:#ff0000;">busted</span>.<br /></p></body></html>