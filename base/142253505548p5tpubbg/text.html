<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:600;">Начало работы с PostgreSQL</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> </span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">PostgreSQL — это кроссплатформенная объектно-реляционная СУБД с открытым исходным кодом. Из этой статьи вы узнаете, как установить PostgreSQL в Ubuntu Linux, подключиться к нему и выполнить пару простых SQL-запросов, а также о том, как настроить резервное копирование. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Чтобы установить PostgreSQL 9.2 в Ubuntu 12.10, выполните следующие команды:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">sudo apt-add-repository ppa:pitti/postgresql<br />sudo apt-get update<br />sudo apt-get install postgresql-9.2</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Попробуем поработать с СУБД через оболочку:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">sudo -u postgres psql</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Создадим тестовую базу данных и тестового пользователя:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">postgres=# CREATE DATABASE test_database;<br />CREATE DATABASE<br /><br />postgres=# CREATE USER test_user WITH password 'qwerty';<br />CREATE ROLE<br /><br />postgres=# GRANT ALL privileges ON DATABASE test_database TO test_user;<br />GRANT</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Для выхода из оболочки введите команду </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">\q</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Теперь попробуем поработать с созданной базой данных от имени test_user:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">psql -h localhost test_database test_user</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Создадим новую таблицу:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">test_database=&gt; CREATE SEQUENCE user_ids;<br />CREATE SEQUENCE<br /><br />test_database=&gt; CREATE TABLE users (</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">id INTEGER PRIMARY KEY DEFAULT NEXTVAL('user_ids'), </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">login CHAR(64), </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">password CHAR(64)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">);<br />NOTICE:  CREATE TABLE / PRIMARY KEY will CREATE implicit INDEX &quot;users_pkey&quot; FOR TABLE &quot;users&quot;<br />CREATE TABLE</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Обратите внимание, что в отличие от некоторых других СУБД, в PostgreSQL нет столбцов со свойством auto_increment. Вместо этого в постгресе используются последовательности (sequences). На данный момент достаточно знать, что с помощью функции nextval мы можем получать уникальные числа для заданной последовательности:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">test_database=&gt; SELECT NEXTVAL('user_ids');<br /> NEXTVAL <br />---------<br />       1<br />(1 ROW)<br /><br />test_database=&gt; SELECT NEXTVAL('user_ids');<br /> NEXTVAL <br />---------<br />       2<br />(1 ROW)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Прописав в качестве значения по умолчанию для поля id таблицы users значение </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">NEXTVAL('user_ids')</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">, мы добились того же эффекта, что дает auto_increment. При добавлении новых записей в таблицу мы можем не указывать id, потому что уникальный id будет сгенерирован автоматически. Несколько таблиц могут использовать одну и ту же последовательность. Таким образом мы сможем гарантировать, что значения некоторых полей у этих таблиц не пересекаются. В этом смысле последовательности более гибки, чем auto_increment.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Точно такую же таблицу можно создать и при помощи всего лишь одной команды:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">test_database=&gt; CREATE TABLE users2 (id SERIAL PRIMARY KEY, login CHAR(64), password CHAR(64));<br />NOTICE:  CREATE TABLE will CREATE implicit SEQUENCE &quot;users2_id_seq&quot; FOR serial COLUMN &quot;users2.id&quot;<br />NOTICE:  CREATE TABLE / PRIMARY KEY will CREATE implicit INDEX &quot;users2_pkey&quot; FOR TABLE &quot;users2&quot;<br />CREATE TABLE</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Как видите, последовательность для поля id была создана автоматически.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Теперь с помощью команды </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">\d</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> можно ознакомиться со списком всех доступных таблиц, а с помощью </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">\d users</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> — увидеть описание таблицы users. Если вы не получили интересующую вас информацию, попробуйте </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">\d+</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;"> вместо </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">\d</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. Для отображения справки по командам скажите </span><span style=" font-family:'Courier New,courier'; font-size:10pt;">\h</span><span style=" font-family:'DejaVu Sans'; font-size:10pt;">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Важно отметить, что в PostgreSQL по умолчанию имена таблиц и столбцов приводятся к нижнему регистру. Если это поведение нежелательно, можно воспользоваться двойными кавычками:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">test_database=&gt; CREATE TABLE &quot;anotherTable&quot; (&quot;someValue&quot; VARCHAR(64));<br />CREATE TABLE<br /><br />test_database=&gt; SELECT * FROM anotherTable;<br />ERROR:  relation &quot;anothertable&quot; does NOT exist<br />LINE 1: SELECT * FROM anotherTable;<br />                      ^<br /><br />test_database=&gt; SELECT * FROM &quot;anotherTable&quot;;<br /> someValue <br />-----------<br />(0 ROWS)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">В остальном работа с PostgreSQL мало чем отличается от работы с любой другой реляционной СУБД:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">test_database=&gt; INSERT INTO users (login, password) VALUES ('afiskon', '123456');<br />INSERT 0 1<br /><br />test_database=&gt; SELECT * FROM users;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Если сейчас вы попытаетесь подключиться к постгресу с другой машины, то потерпите неудачу:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">psql -h 192.168.0.1 test_database test_user<br /><br />psql: could not connect to server: Connection refused<br />  Is the server running on host &quot;192.168.0.1&quot; and accepting<br />  TCP/IP connections on port 5432?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Чтобы исправить это, добавьте строку:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">listen_addresses = 'localhost,192.168.0.1'</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">… в файл /etc/postgresql/9.2/main/postgresql.conf, а также:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">host    all    all    192.168.0.1/16    md5</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">… в файл /etc/postgresql/9.2/main/pg_hba.conf и скажите:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">sudo service postgresql restart</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Теперь все должно работать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Резервное копирование в PostgreSQL выглядит примерно так:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">pg_dump -c -h 192.168.0.1 -U test_user test_database &gt; ./dump.sql</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Если у вас большая база данных, обратите также внимание на поддержку утилитой pg_dump </span><a href="http://www.opennet.ru/man.shtml?topic=pg_dump"><span style=" font-family:'DejaVu Sans'; font-size:10pt; text-decoration: underline; color:#0000ff;">флага -Fc</span></a><span style=" font-family:'DejaVu Sans'; font-size:10pt;">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Восстановление из резервной копии:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">cat dump.sql | psql -h 192.168.0.1 test_database test_user</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Во время создания резервной копии вы можете получить ошибку вроде такой:</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-size:10pt; color:#6a1009;">pg_dump: server version: 9.2.4; pg_dump version: 9.1.9<br />pg_dump: aborting because of server version mismatch</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Насколько мне известно, единственное нормальное решение этой проблемы — честно держать всюду одну и ту же версию PostgreSQL. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans'; font-size:10pt;">Учтите, что настройки PostgreSQL по умолчанию предполагают, что вы пытаетесь запустить его на микроволновке. Перед использованием PostgreSQL в боевых условиях эти настройки обязательно нужно изменить под ваше железо и ваше приложение.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'DejaVu Sans'; font-size:10pt;"><br /></p></body></html>