<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Всем привет. Рассмотрев в </span><a href="http://www.ap-impulse.ru/podklyuchaem-knopki-k-avr-shag-12/"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; text-decoration: underline; color:#0000ff;">прошлой статье</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"> взаимодействие кнопок с контроллером, в этой записи разберем память МК AVR</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; font-weight:600; font-style:italic;"> EEPROM</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"> (электрически стираемая ППЗУ), которая является энергонезависимой и имеет ресурс примерно в 100 000 циклов записи/чтения. Зачем нам нужна такая память с ограниченным числом обращений к ней? Такая память идеально подходит для хранения констант и исходных параметров, которые мы можем задать в начале программы, при помощи тех же кнопок.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="reclama1"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">С</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">ледует отметить, что некоторые производители комбинируют память типа EEPROM с SRAM. При прекращении подачи рабочего напряжения содержимое памяти переносится с SRAM в EEPROM, благодаря чему достигают короткого цикла записи не приводящему к износу.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Теперь рассмотрим как обращаться к ней. Для программирования памяти EEPROM используются три регистра, расположенные в области ввода/вывода памяти SRAM: восьмиразрядный регистр адреса EEAR или два регистра EEARH и EEARL; восьмиразрядный регистр данных EEDR; восьмиразрядный регистр управления EECR.  когда происходит процесс записи, байт данных адресуется регистром адреса и заносится  в регистр данных. В процессе чтения из памяти в регистр данных записывается содержимое ячейки EEPROM, адресуемой регистром адреса.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">В книге Евстифеева, справочнике по микроконтроллерам (литературу я приводил в статье №1), описаны программные примеры для записи/чтения. Давайте разберем программу:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#808080;">Реализация функции записи:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">void EEPROM_write (unsigned int uiAddress, unsigned char uoData)</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">{</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     while ( EECR &amp; (1&lt;&lt;EEWE)); </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#339966;">//ждем завершения предыдущей записи</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     EEAR = uiAddress; </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#339966;">//Проинициализировать регистр адресса</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     EEDR = uoData ;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#339966;"> //Проинициализировать регитр данных</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     EECR |= (1&lt;&lt;EEMWE);</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#339966;"> //Установить флаг EEMWE</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     EECR |= (1&lt;&lt; EEWE); </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#339966;">//Начать запись в EEPROM</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Разберем программу.<br />1. EEWE является разрядом регистра (рисунок ниже)  EECR и отвечает за разрешение записи в EEPROM, если установлен в 1, то происходит запись в EEPROM, при условии что EEMWE установлен в 1.<br />2. Загружаем адрес в регистр адреса EEAR<br /></span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image22265.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#808080;">Разряды регистра управления EECR:</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br />EERIE — разрешение прерывания от EEPROM;<br />EEMWE — управлене разрешением записи в EEPROM;<br />EEWE — разрешение записи в  EEPROM;<br />EERE —  разрешение чтения из EEPROM.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">3. Загружаем байт данных  в регистр данных EEDR.<br />4. EEMWE – управление разрядом разрешения записи в EEPROM. Этот флаг отвечает за функционирование разряда разррешения записи EEWE. При установке в 1запись разрешается, если 0, то при установке EEWE в 1 запись в память не произойдет. После программной установки EEMWE сбрасывается через 4 машинных цикла.<br />5. Записываем данные в память.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#808080;">!!!Здесь есть один ньюанс</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">. Если планируется переодическая запись данных в EEPROM во время выполнения программы, при самопрограммировании микроконтроллера,  то необходимо знать, что запись в EEPROM не может одновременно выполняться с записью во Flash память , поэтому выше после первого пункта необходимо добавить следующий пункт:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#808080;">— дождаться завершения записи во Flash-память прграмм, т.е. ждать пока не сбпроситься флаг SPMEN регистра SPMCR, тогда после этой строки необходимо добавить еще одно циклическое условие:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#3366ff;">while (SPMCR &amp;(1&lt;&lt;SPMEN));</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008000;">// Завершение записи во Flash память</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#808080;">Теперь разберем функцию чтения:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;"> unsigned char EEPROM_write (unsigned int uiAddress)</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">{</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     while ( EECR &amp; (1&lt;&lt;EEWE)); </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008000;">//ждем завершения предыдущей записи</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     EEAR = uiAddress;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008000;"> //Проинициализировать регистр адресса</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     EECR |= (1&lt;&lt;EERE);</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008000;"> //Выполнить чтение</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     return EEDR;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;"> }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Здесь все почти также, только в функцию передается адресс переменной, инициализируем его и разрешаем чтение по этому адрессу. Возвращаем данные.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Но прежде, чем использовать алгоритм записи или чтения  EEPROM, необходимо объявить переменную, которая будет распределена в пределах области EEPROM. Для этого в библиотеке  eeprom.h программной среды WinAVR определен специальный атрибут EEMEM. Например объявим переменную безнакового целочисленого типа с атрибутом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">EEMEM uint8_t eeprom_х ; </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008000;">// объявим переменную.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br />х –переменная;<br />uint8_t – целочисленный безнаковый тип, имеющие точно указанную разрядность, в данном случае 8 бит и предназначен для переносимости программ.<br />EEMEM – атрибут, заставляющий переменную быть распределенной в пределах раздела .eeprom. Данный атрибут определен в файле eeprom.h и выглядит он следующим образом.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">#ifndef EEMEM</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">#define EEMEM__attribute__ ((section («.eeprom»)))</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;"> #endif</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Для работы с данными в библиотеке уже прописаны функции:<br />для чтения<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">uint8_t  eeprom_read_byte (const uint8_t *addr)</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br />Аргументом функций eeprom_read_... является адрес переменной в EEPROM, а результатом — значение переменной в EEPROM.<br />для записи<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">void  eeprom_write_byte (uint8_t *addr, uint8_t value)</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br />Аргументами функций eeprom_write_... являются адрес в EEPROM, куда записать данные и значение которое нужно записать.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Ну что ж все это пережевав на последок программный пример в целом. Передадим в EEPROM данные и считаем.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">#include &lt;eeprom.h&gt;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;"> #include &lt;stdio.h&gt;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">#include &lt;avr/io.h&gt;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">#include «lcd.h»</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">uint8_t EEMEM eepro_х;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"> </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008000;">/* такая переменная должна быть всегда глобальной и служит для передачи своего адресса в область EEPROM*/</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">char word[]=&quot;Hello&quot;;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">main ()</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;"> {</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     uint8_t eepro_х1 = 100; </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008080;">/*вторая переменная для передачи данных*/</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008080;">     /*Давайте запишем переменную в память*/</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">     eeprom_write_byte (&amp;eeprom_x, eeprom_x1); </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008080;">/*передаем в функцию адресс переменной и значение которое запишем                                                                   по этому адрессу*/</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008080;">     /*теперь убедимся, что в памяти у нас хранится значение 100, для этого обнулим текущее значение     пременной х и присвоим считанное значение сз памяти*/</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">      eeprom_х1 = 0;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008080;">      /*считаем содержимое памяти*/</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">      x1 = eeprom_read_byte (&amp;eeprom_x);   </span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#008080;">// взятие адресса переменной</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">      sprintf (word,&quot;V_eeprom x1=%3d&quot;,eeprom_x1);</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">      PrintString (word);</span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; color:#0000ff;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">Ниже на рисунке представлен результат:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24316.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br />Выше представленный код взят из статьи №4, в который вставлены выше приведенные строки.<br />Если в программе изначально передаются какието константы для хранения в памяти EEPROM, то при прошивке необходимо залить файл с расширением .eep, который будет создан компилятоором и размещен в той же директории что и рабочие файлы.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;">На этом пока все. Здесь дан краткий обзор для работы с такой памятью.  Конечно есть куча ньюансов, но это уже тонокости. В следующей статье </span><a href="http://www.ap-impulse.ru/shim-upravlenie-shag-14/"><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt; text-decoration: underline; color:#0000ff;">расмотрим ШИМ</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:7.8pt;"> (широтно-имульсную модуляцию) и плавно перейдем к следующиму проекту попробуем сконструировать «мозги» для любительского станка ЧПУ. Всем пока.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:7.8pt;"><br /></p></body></html>