<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для удобства разработки веб-приложений я с недавнего времени использую <a href="http://www.vagrantup.com/"><span style=" text-decoration: underline; color:#0000ff;">Vagrant</span></a>. Это просто готовый инструмент для быстрого развертывания и настройки виртуальной машины. В качестве эмулятора можно использовать и VMWare и VirtualBox (я использую второе).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Голый «исходник» виртуалки называется «box». Их можно делать самому, но есть <a href="http://www.vagrantbox.es/"><span style=" text-decoration: underline; color:#0000ff;">куча готовых</span></a>. Я выбрал Ubuntu 12.04 LTS и скачал бокс:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">vagrant box add НАЗВАНИЕ_БОКСА URL_БОКСА</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier 10 Pitch'; color:#6a0e07;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Название — любое, это просто идентификатор. Вагрант скачивает бокс в папку ~/.vagrant.d/boxes по умолчанию, но расположение можно поменять задав значение переменной окружения VAGRANT_HOME. Я недавно перешел на ССД в качестве системного диска, поэтому в .bash_profile у меня стоит:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#000000;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">export VAGRANT_HOME=«/Volumes/Mac HDD/freetonik/.vagrantboxes»</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь можно создавать виртуальную машину на основе этого бокса. Делается это очень просто:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">vagrant init НАЗВАНИЕ_БОКСА</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Эта команда создаст в текущей директории файл Vagrantfile, а в Виртуалбоксе появится новая виртуальная машина на основе образа из бокса. С самим боксом ничего не произойдет, он останется лежать в том же месте словно установочный пакет.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Виртуалбокс запустится в «безголовом» режиме, то есть вы не увидите никакого пользовательского интерфейса. Виртуальная машина на базе бокса сохранится там, где по умолчанию хранятся виртуальные машины Виртуалбокса. Поэтому я заранее запустил Виртуалбокс и сменил путь (чтобы не держать виртуалку на ССД).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Vagrantfile, созданный командой vagrant init — это конфигурация вашей виртуальной машины. В ней можно настроить перенаправление портов, общие папки и провизию: автоматическую установку приложений. Вот как выглядит мой Vagrantfile:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">Vagrant.configure(«2») do |config|<br />config.vm.box = «ubuntu»<br />config.vm.network :forwarded_port, guest: 80, host: 8080<br />config.vm.synced_folder «/Users/freetonik/project/XXX», «/usr/share/nginx/www/»<br />end</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">80й порт виртуальной машины перенаправляется на порт 8080 хост-машины. Папка с репозиторием в моей домашней директории синхронизирована с той папкой, которую использует nginx.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Провизия позволяет устанавливать приложения и осуществлять автоматическую настройку конфигурации прямо при запуске виртуалки. Это удобная штука если у вас сложная конфигурация. Самый простой вариант — написать скрипт для последовательной установки нужных вам приложений. Но можно использовать puppet или chef. Со скриптом бывают проблемы (например, у меня никак не хотел устанавливаться nginx), а puppet/chef показался избыточным — у меня примитивная конфигурация nginx+php-fpm+postgres+redis. Так что я просто поставил все вручную несколькими короткими командами уже в самой виртуалке.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Что-ж, осталось лишь запустить виртуальную машину:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">vagrant up</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Через несколько секунд (если в Vagrantfile нет ошибок) виртуальная машина запустится. К ней можно сразу же подключиться через ssh:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">vagrant ssh</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы попадете в учетную запись пользователя vagrant, который может пользоваться sudo без пароля. Теперь можно установить сервер и другие пакеты (если вы не пользовались провизией). После запуска сервера веб-страницы доступны по адресу localhost:8080. Хост, конечно, можно поменять, но вот с портом незадача: OS X не позволяет использовать порт до 1024 если вы не root. Чтобы не извращаться я просто сделал еще одно перенаправление, но уже на хост-машине с помощью встроенного в OS X <a href="http://en.wikipedia.org/wiki/Ipfirewall"><span style=" text-decoration: underline; color:#0000ff;">ipfirewall</span></a>:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">sudo ipfw add 100 fwd 127.0.0.1,8080 tcp from any to me 80</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь все, что идет на порт 8080 перенаправляется на 80. Получилось так:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">nginx:80 — vagrant: 80—&gt;8080 — ipfirewall: 8080—&gt;80</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier 10 Pitch'; color:#6a0e07;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" color:#000000;">Чтобы это правило работало и после перезагрузки нужно добавить сервис:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1) Создать файл <a href="https://gist.github.com/freetonik/6010314"><span style=" text-decoration: underline; color:#0000ff;">/Library/LaunchDaemons/org.dmuth.ipfw.plist</span></a> который будет искать конфигурацию фаерволла в /etc/ipfw.conf.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2) Создать файл /etc/ipfw.conf</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">flush<br />add 100 fwd 127.0.0.1,8080 tcp from any to me 80</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">3) Включить наш новый сервис</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">sudo launchctl load -w /Library/LaunchDaemons/org.dmuth.ipfw.plist</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поставить виртуалку на паузу: vagrant suspend<br />Остановить: vagrant halt<br />Перезагрузить конфигурацию (например, изменили порты или провизию): vagrant reload<br />Уничтожить: vagrant destroy (с боксом ничего не случится).</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">nginx не любит VirtualBox и иногда странно кеширует css-файлы. Это я исправил отключив sendfile в конфигурации nginx:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier 10 Pitch'; color:#6a0e07;">location ~ \.css {<br />add_header Content-Type text/css;<br />sendfile off;<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier 10 Pitch'; color:#6a0e07;"><br /></p></body></html>