<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Использование моделей в Qt</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">За последний год пришлось довольно много работать с Model/View фреймворком Qt. Приходилось как писать собственные модели, так и переделывать существующие. И вот, после созерцания очередного творения, решил представить общественности некоторые наработки. <br /><br />Начнем с очевидного.<br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Не используйте виджеты</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все эти <span style=" font-family:'Courier New,courier';">QTableWidget</span>, <span style=" font-family:'Courier New,courier';">QListWidget </span>и <span style=" font-family:'Courier New,courier';">QTreeWidget </span>— не для вас.<br /><br />Использование MVC фреймворка не составляет проблемы. В простейшем случае, можно использовать готовые модели, которые предоставляет Qt. Количество кода и его сложность при этом не растет, зато удается избежать всевозможных проблем роста. Разделение модели и отображения с самого начала позволяет с легкостью добавлять такие вещи как сортировка или фильтрация, не переписывая при этом половину кода. <br /><br />Одни плюсы, а минусов, при этом, не замечено.<a name="habracut"></a><br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Используйте стандартный интерфейс работы с моделями</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В общем, второй пункт вытекает напрямую из первого. <br /><br />Посмотрите, какие функции предоставляет вам <a href="http://qt-project.org/doc/qt-5.0/qtcore/qabstractitemmodel.html"><span style=" text-decoration: underline; color:#0000ff;">QAbstractItemModel</span></a>. Только их и должен использовать ваш код, работающий с моделью. Этого интерфейса более чем достаточно. Никакой самодеятельности. <a href="http://qt-project.org/doc/qt-4.8/qstandarditemmodel.html"><span style=" text-decoration: underline; color:#0000ff;">QStandardItemModel</span></a>, например, содержит такую замечательную функцию, как<br /></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">QStandardItem * item ( int row, int column = 0 ) const </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-style:italic;">Не пользуйтесь ей.</span> Все операции, в которых фигурируют <span style=" font-family:'Courier New,courier';">Item</span>-ы, должны быть только операциями заполнения модели данными. <br /><br />Если вы собираетесь узнать текст элемента <span style=" font-family:'Courier New,courier';">5</span>й строки <span style=" font-family:'Courier New,courier';">3</span>го столбца, не надо писать<br /></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">QString text = model-&gt;item(5, 3)-&gt;text();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Используйте для этого стандартный интерфейс моделей:<br /></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">QModelIndex index = model-&gt;index(5, 3);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">QString text = index.data(Qt::DisplayRole).toString();</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier';"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Это сэкономит кучу усилий в дальнейшем, когда вы захотите поставить между моделью и компонентом отображения прокси-модель (proxy model), выполняющую сортировку, и внезапно обнаружите, что она не содержит такой замечательной функции <span style=" font-family:'Courier New,courier';">item()</span>.<br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Избегайте QStandardItemModel !</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пожалуй, это самый сложный и неочевидный пункт для объяснения. <br /><br />Модель <span style=" font-family:'Courier New,courier';">QStandardItemModel </span>предоставляет универсальный интерфейс, так что с его помощью можно достаточно быстро сделать какую угодно структуру представления данных. <br /><br />Однако есть в ее использовании и существенные недостатки. <br /><br />Во-первых, Qt предоставляет несколько готовых простых моделей для некоторых случаев: <a href="http://qt-project.org/doc/qt-5.0/qtcore/qstringlistmodel.html"><span style=" text-decoration: underline; color:#0000ff;">QStringListModel</span></a>, <a href="http://qt-project.org/doc/qt-5.0/qtwidgets/qdirmodel.html"><span style=" text-decoration: underline; color:#0000ff;">QDirModel</span></a>, <a href="http://qt-project.org/doc/qt-5.0/qtwidgets/qfilesystemmodel.html"><span style=" text-decoration: underline; color:#0000ff;">QFileSystemModel</span></a>, <a href="http://qt-project.org/doc/qt-5.0/qtsql/qsqlquerymodel.html"><span style=" text-decoration: underline; color:#0000ff;">QSqlQueryModel</span></a> с ее родственниками — к вашим услугам!<br /><br />К сожалению, в большинстве случаев они не очень подходят. <span style=" font-style:italic;">Что же, разрабатывать собственные модели для каждого случая?</span><br /><br />Действительно, на первый взгляд эта задача выглядит довольно сложной. На самом деле все не так страшно. Но перед тем, как перейти к практической части написания модели, давайте рассмотрим несколько концептуальных вопросов.<br /><br />Как выглядит работа с данными при использовании <span style=" font-family:'Courier New,courier';">QStandardItemModel</span>?<br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Получаем данные из внешнего источника.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Заполняем модель полученными данными.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После того, как этот процесс завершен, можно отобразить модель.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Чтобы синхронизировать изменения, внесенные пользователем, подписываемся на сигналы (например, <span style=" font-family:'Courier New,courier';">itemChanged()</span>)</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /><span style=" font-style:italic;">Выглядит не так уж плохо? Не тут-то было!</span><br /><br />Во-первых, если объем данных большой, то построение модели займет достаточно много времени. Более того, поскольку модель должна быть готова полностью до того, как мы сможем показать ее пользователю, придется прочитать все данные.<br /><br />Во-вторых, мы получаем, фактически, две модели данных – одна – источник данных и вторая – стандартная модель Qt. И эти модели нужно синхронизировать. Эта задача не такая простая, как кажется на первый взгляд.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">К примеру, пользователь изменил некоторое значение в ячейке. Мы пробуем записать это значение в источник, но ничего не выходит (например, с источником данных потеряна связь). Теперь необходимо вернуть старое значение, чтобы не нарушить согласованность данных. Но его еще надо откуда-то взять! То есть, приходится хранить еще один, резервный, набор данных.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; color:#808080;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Фактически, все многообразие возникающих проблем проистекает из одного печального факта: <span style=" font-style:italic;">как только вы начинаете использовать стандартную модель, вы больше не контролируете ваши данные</span>. Вы встречаетесь уже со случившимися фактами, <span style=" font-style:italic;">вы вынуждены исправлять ошибки, внесенные в структуру ваших данных, но вы не можете избежать их</span>. Вы не можете навесить какие либо ограничения целостности.<br /><br />Поэтому я предлагаю отказаться от стандартной модели для большинства случаев. На самом деле, вам не нужно даже разрабатывать свою модель. П<span style=" font-style:italic;">отому что ваши данные – это и есть ваша модель. Она уже готова.</span> Вам нужно только написать тонкую обертку, которая согласовывала бы интерфейс вашей модели с интерфейсом моделей Qt MVC.<br /><br />В этом вам помогут стандартные заготовки Qt: <a href="http://qt-project.org/doc/qt-5.0/qtcore/qabstractlistmodel.html"><span style=" text-decoration: underline; color:#0000ff;">QAbstractListModel</span></a>, <a href="http://qt-project.org/doc/qt-5.0/qtcore/qabstracttablemodel.html"><span style=" text-decoration: underline; color:#0000ff;">QAbstractTableModel</span></a>. Адаптация их для конкретных случаев, как правило, очень проста. Вам нужно реализовать всего несколько функций, и их реализация, обычно, тривиальна.<br /><br />При этом вы разом избавляетесь от множетва проблем.<br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Не нужно «строить» модель. Модель уже готова после того, как создана. Для того, чтобы начать с ней работать, вам даже не нужны данные. Вам необходима только метаинформация, которую вы внесли в модель еще на этапе разработки. Все остальное вам понадобится только тогда, когда об этом спросят. <br /><span style=" color:#808080;">При этом, если количество данных в модели велико, то большую часть их не спросят, вероятно, никогда.</span></li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы можете использовать все возможность технологии Qt MVC, вроде динамической подгрузки данных или быстрого перемещения строк.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы можете наложить ограничения целостности на ваши данные и не дать пользователю их разрушить.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы можете использовать автоматически вычислимые данные и значения по умолчанию.<br /><span style=" color:#808080;">Просто попробуйте сделать с использованием </span><span style=" font-family:'Courier New,courier'; color:#808080;">QStandardItemModel</span><span style=" color:#808080;"> так, чтобы ячейки с нечетными значениями отображались с зеленым цветом фона, а ячейки с четными значениями – с красным. Данные ячеек, естественно, могут быть изменены пользователем.</span></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Совет напоследок</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Как вы думаете, какая функция модели будет вызываться чаще всего? Правильно, это функция <span style=" font-family:'Courier New,courier';">index()</span>.Она вызывается действительно часто. Нет, не так часто, как вы подумали. На порядок чаще. А функция <span style=" font-family:'Courier New,courier';">index()</span>, скорее всего, будет вызывать функции <span style=" font-family:'Courier New,courier';">rowCount()</span> и <span style=" font-family:'Courier New,courier';">columnCount()</span>. Эта тройка должна работать быстро, особенно если данных в модели будет много. <br /><br />А вот запрос на актуализацию данных, вызов <span style=" font-family:'Courier New,courier';">data()</span>, будет происходить только тогда, когда эти данные действительно нужны. Например, для того, чтобы показать их пользователю. Если часть данных не видна в окне, то и запрашиваться она не будет.<br /><br /><br /></p></body></html>