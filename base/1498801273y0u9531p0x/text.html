<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Arduino-совместимые платы имеют небольшое ПЗУ (EEPROM), размер которого зависит от используемого микроконтроллера. Для ATmega168 это 512 байт, для ATmega328 – 1024 байта.</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Библиотека EEPROM </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для работы с EEPROM существует стандартная библиотека EEPROM, позволяющая записать байт в EEPROM по нужному адресу, и прочесть его оттуда. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рассмотрим простой пример. Пусть в самом первом байте EEPROM (по адресу 0) хранится счетчик числа сбросов микроконтроллера. При каждом сбросе будет вызываться функция setup(), в которой мы будем считывать счетчик, увеличивать его на единицу и записывать обратно. Также, чтобы увидеть значение счетчика в мониторе последовательного порта, будем выводить число туда.</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">#include &lt;EEPROM.h&gt; //подключаем заголовочный файл библиотеки EEPROM<br /><br />void setup()<br />{<br />  uint8_t counter; //Здесь будем хранить счетчик<br />  //uint8_t - тип данных, занимающий 1 байт,<br />  //и хранящий значение от 0 до 255<br /><br />  //Инициализируем последовательный порт на 9600бит/сек:<br />  Serial.begin(9600);<br /><br />  //Читаем счетчик из EEPROM:<br />  counter = EEPROM.read(0);<br /><br />  counter++;  // увеличиваем его на единицу<br /><br />  //Записываем значение счетчика<br />  EEPROM.write(0, counter);<br /><br />  //Выводим счетчик в порт:<br />  Serial.print(&quot;It's reset #&quot;);<br />  Serial.println(counter, DEC);<br />}<br /><br />void loop()<br />{<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Поэкспериментируйте с программой, и убедитесь, что значение счетчика сохраняется и после пропадания питания. Фирма ATMEL – производитель микроконтроллеров ATmega, декларирует порядка 100’000 (ста тысяч) успешных циклов записи в EEPROM и хранение данных до 100 лет при температуре 25 градусов по Цельсию. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Библиотека EEPROM2</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рассмотренная программа имеет один недостаток, связанный с тем, что для хранения счетчика используется всего один байт. После достижения счетчиком значения 255 следующее увеличение даст значение 0, из-за переполнения разрядной сетки. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Таким образом, требуется применение счетчика большего размера – 2 байта дадут верхнюю границу в 65’535, а 4 байта – 4’294’967’295. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Стандартная библиотека имеет функции только для работы с однобайтными данными типа uint8_t, и чтение 4-байтного числа будет выглядеть примерно так:</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"> *((uint8_t*)&amp;counter + 0) = EEPROM.read(0);<br /> *((uint8_t*)&amp;counter + 1) = EEPROM.read(1);<br /> *((uint8_t*)&amp;counter + 2) = EEPROM.read(2);<br /> *((uint8_t*)&amp;counter + 3) = EEPROM.read(3);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a1009;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Такой исходный код, конечно, будет понятен компилятору, но далеко не каждому начинающему программисту, и поэтому мы написали свою версию библиотеки для работы с EEPOM: </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://www.freeduino.ru/arduino/files/EEPROM2.zip"><span style=" text-decoration: underline; color:#0000ff;">http://www.freeduino.ru/arduino/files/EEPROM2.zip</span></a> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как и в большинстве случаев, установка библиотеки сводится к распаковке архива в подпапку \hardware\libraries\ папки с ПО Arduino. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь рассмотрим аналогичную первому примеру программу, хранящую счетчик в 4-байтном числе с помощью библиотеки EEPROM2:</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">#include &lt;EEPROM2.h&gt;<br />//подключаем заголовочный файл библиотеки EEPROM2<br /><br />void setup()<br />{<br />  unsigned long counter; //Здесь будем хранить счетчик<br />  //unsigned long - тип данных, занимающий 4 байта,<br />  //и хранящий значение от 0 до 4'294'967'295<br /><br />  //следующие 2 строчки нужны только при первом запуске,<br />  //чтобы обнулить значение счетчика:<br />  counter = 0;  <br />  EEPROM_write(0, counter);<br /><br />  //Инициализируем последовательный порт на 9600бит/сек:<br />  Serial.begin(9600);<br /><br />  //Читаем счетчик из EEPROM:<br />  EEPROM_read(0, counter);<br /><br />  counter++;  // увеличиваем его на единицу<br /><br />  //Записываем значение счетчика<br />  EEPROM_write(0, counter);<br /><br />  //Выводим счетчик в порт:<br />  Serial.print(&quot;It's reset #&quot;);<br />  Serial.println(counter, DEC);<br />}<br /><br />void loop()<br />{<br />}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Загрузите программу в микроконтроллер, удалите строчки, обнуляющие счетчик, и загрузите программу еще раз. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Комментариев в исходном коде вполне достаточно для понимания программы, а синтаксис работы с библиотекой отличается от оригинальной незначительно. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Работа с EEPROM через boot-loader </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Процесс старта Arduino-совместимой платы начинается со старта загрузчика, часто называемого boot-loader. Он занимает последние 2 К памяти программ (начиная с UNO - 512 байт), и именно из-за него Ваши проекты ограничены размером 14 К для ATmega168 и 30 K для ATmega328, при объеме памяти программ у микроконтроллеров 16 К и 32 К соответственно. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После старта загрузчик некоторое время ожидает, что управляющий ПК начнет передачу новой программы, и если этот процесс начинается, то именно загрузчик и «прошивает» Вашу программу в микроконтроллер. Если загрузка программы не началась, то загрузчик передает управление на ранее загруженную Вами в микроконтроллер программу, в результате чего выполняется функция setup(), а затем в бесконечном цикле функция loop(). </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Кстати, именно загрузчик мигает светодиодом на 13 выводе при сбросе микроконтроллера. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">При обмене данными с ПК загрузчик использует протокол stk500v1, и может работать, в том числе и с EEPROM. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для чтения содержимого EEPROM в файл &quot;0.bin&quot; необходимо в командной строке </p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перейти в подпапку \hardware\tools\avr\bin\ папки с ПО Arduino; </li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выполнить команду (в одну строку):</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">avrdude -q -C ..\etc\avrdude.conf -p m168 -c stk500v1 -P COM3 -b 19200 -U eeprom:r:0.bin:r</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для записи содержимого файла 0.bin в EEPROM команда такая:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">avrdude -q -C ..\etc\avrdude.conf -p m168 -c stk500v1 -P COM3 -b 19200 -U eeprom:w:0.bin</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Параметр «COM3» нужно заменить на Ваш номер порта. </p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>