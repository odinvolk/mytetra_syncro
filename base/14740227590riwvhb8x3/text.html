<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'Arial'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Доброго времени, читатели и гости </span><a href="http://www.k-max.name/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">моего блога</span></a><span style=" font-family:'MS Shell Dlg 2';">. C этой статьи начну серию статей о </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">подсистеме Netfilter/iptables в Linux</span><span style=" font-family:'MS Shell Dlg 2';">. В данной статье приведу </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">основные понятия работы netfilter в Linux</span><span style=" font-family:'MS Shell Dlg 2';">. Для понимания данной темы, обязательно советую ознакомиться со статьями </span><a href="http://www.k-max.name/linux/osnovnye-ponyatiya-setej/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">Основные понятия сетей</span></a><span style=" font-family:'MS Shell Dlg 2';">, </span><a href="http://www.k-max.name/linux/network-in-linux/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">Настройка сети в Linux, диагностика и мониторинг</span></a><span style=" font-family:'MS Shell Dlg 2';"> и </span><a href="http://www.k-max.name/linux/nastrojka-i-upravlenie-setevoj-podsistemoj-linux-paket-iproute2/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">Настройка и управление сетевой подсистемой Linux (iproute2)</span></a><span style=" font-family:'MS Shell Dlg 2';">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Введение и история</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Netfilter</span><span style=" font-family:'MS Shell Dlg 2';"> — межсетевой экран (он же, брандмауэр, он же файерволл, он же firewall...) встроен в ядро Linux с версии 2.4. Netfilter управляется утилитой </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">iptables</span><span style=" font-family:'MS Shell Dlg 2';"> (Для IPv6 — ip6tables). До </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">netfilter/iptables</span><span style=" font-family:'MS Shell Dlg 2';"> был </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Ipchains</span><span style=" font-family:'MS Shell Dlg 2';">, который входил в состав ядер Linux 2.2. До ipchains в Linux был так называемый </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">ipfw</span><span style=" font-family:'MS Shell Dlg 2';"> </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">(IPV4 firewal)</span><span style=" font-family:'MS Shell Dlg 2';">, перенесенный из BSD. Утилита управления - ipfwadm. Проект netfilter/iptables был основан в 1998. Автором является Расти Расселл (он же руководил и прошлыми разработками). В 1999 г. образовалась команда Netfilter Core Team (сокращено coreteam). Разработанный межсетевой экран получил официальное название netfilter. В августе 2003 руководителем coreteam стал Харальд Вельте (Harald Welte).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Проекты </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">ipchains</span><span style=" font-family:'MS Shell Dlg 2';"> и </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">ipfwadm</span><span style=" font-family:'MS Shell Dlg 2';"> изменяли работу стека протоколов ядра Linux, поскольку до появления </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">netfilter</span><span style=" font-family:'MS Shell Dlg 2';"> в архитектуре ядра не существовало возможностей для подключения дополнительных модулей управления пакетами. </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">iptables</span><span style=" font-family:'MS Shell Dlg 2';"> сохранил основную идею </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">ipfwadm</span><span style=" font-family:'MS Shell Dlg 2';"> — список правил, состоящих из критериев и действия, которое выполняется если пакет соответствует критериям. В </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">ipchains</span><span style=" font-family:'MS Shell Dlg 2';"> была представлена новая концепция — возможность создавать новые цепочки правил и переход пакетов между цепочками, а в iptables концепция была расширена до четырёх таблиц (в современных netfilter - более четырех), разграничивающих цепочки правил по задачам: </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">фильтрация, NAT, и модификация пакетов</span><span style=" font-family:'MS Shell Dlg 2';">. Также iptables расширил возможности Linux в области определения состояний, позволяя создавать межсетевые экраны работающие на сеансовом уровне.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Архитектура Netfilter/iptables</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Предварительные требования (</span><a href="http://www.bog.pp.ru/work/iptables.html#pre"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">с</span></a><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Как уже говорилось выше, для работы Netfilter необходимо ядро версии 2.6 (ну или хотя бы 2.3.15). Кроме того, при </span><a href="http://www.k-max.name/linux/upravlenie-yadrom-linux-sborka-kompilirovanie-konfigurirovanie/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">сборке и настройке ядра</span></a><span style=" font-family:'MS Shell Dlg 2';"> необходимо наличие настроек CONFIG_NETFILTER, CONFIG_IP_NF_IPTABLES, CONFIG_IP_NF_FILTER (таблица filter), CONFIG_IP_NF_NAT (таблица nat), CONFIG_BRIDGE_NETFILTER, а также многочисленные дополнительные модули: CONFIG_IP_NF_CONNTRACK (отслеживание соединений), CONFIG_IP_NF_FTP (вспомогательный модуль для отслеживания FTP соединений), CONFIG_IP_NF_MATCH_* (дополнительные типы шаблонов соответствия пакетов: LIMIT, MAC, MARK, MULTIPORT, TOS, TCPMSS, STATE, UNCLEAN, OWNER), CONFIG_IP_NF_TARGET_* (дополнительные действия в правилах: REJECT, MASQUERADE, REDIRECT, LOG, TCPMSS), CONFIG_IP_NF_COMPAT_IPCHAINS для совместимости с ipchains, CONFIG_BRIDGE_NF_EBTABLES и CONFIG_BRIDGE_EBT_* для работы в режиме моста, прочие CONFIG_IP_NF_* и CONFIG_IP6_NF_*. Полезно также указать CONFIG_PACKET.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Файлы в каталоге </span><a href="http://www.k-max.name/linux/fajlovaya-sistema-linux-i-struktura-katalogov/#proc"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">/proc</span></a><span style=" font-family:'MS Shell Dlg 2';">, отображающие информацию о работе netfilter (о некоторых из них - ниже по тексту):</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">/proc/net/ip_tables_names</span> - список используемых <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" text-decoration: underline; color:#0000ff;">таблиц</span></a></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">/proc/net/ip_tables_targets </span>- список используемых действий</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">/proc/net/ip_tables_matches </span>- список используемых протоколов</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">/proc/net/nf_conntrack</span> (или <span style=" font-weight:600;">/proc/net/ip_conntrack</span>) - список установленных соединений и их <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#conn"><span style=" text-decoration: underline; color:#0000ff;">состояний</span></a></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">/proc/sys/net/ipv4/netfilter/*</span> - cодержит множество настроек системы <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#conn"><span style=" text-decoration: underline; color:#0000ff;">conntrack</span></a>, например: </li></ul>
<ul type="circle" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">ip_conntrack_tcp_be_liberal</span> </li>
<ul type="circle" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">0 - все пакеты, не попадающие в окно, считаются INVALID</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1 - только RST пакеты, не попадающие в окно, считаются INVALID (пришлось поставить)</li></ul>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">ip_conntrack_log_invalid</span> - выводить в журнал INVALID пакеты</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">ip_conntrack_tcp_loose</span> - при &quot;подхватывании&quot; уже установленного соединения сколько пакетов требуется в обоих направлениях для подтверждения; если 0, то установленное соединение не подхватывается вовсе; по умолчанию - 3</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">ip_conntrack_max_retrans</span> - число повторных пакетов без подтверждения ACK, которое требуется для удаления соединения из таблицы после дополнительного ожидания ip_conntrack_timeout_max_retrans секунд; по умолчанию - 3</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Функциональность netfilter может расширяться с помощью </span><a href="http://www.k-max.name/linux/yadro-linux-poluchenie-informacii-i-upravlenie/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">модулей ядра</span></a><span style=" font-family:'MS Shell Dlg 2';">. Головной модуль ядра называется iptable_filter, модуль поддержки утилиты iptables называется ip_tables, вспомогательные модули обычно имеют префикс &quot;ipt_&quot; (например: ipt_state, ipt_REJECT, ipt_LOG; хотя - ip_conntrack/nf_conntrack). Большинство модулей загружается автомагически, но некоторые всё же приходиться загружать вручную (ip_conntrack_ftp - иначе может не работать в режиме Active; ip_conntrack_irc - иначе может не работать отсылка файлов по DCC; ip_nat_ftp; ip_nat_irc; ip_conntrack_tftp/nf_conntrack_tftp на клиенте - иначе не будет работать TFTP).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Схема работы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Для начального понимания </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">архитектуры Netfilter/iptables</span><span style=" font-family:'MS Shell Dlg 2';"> отлично подойдет иллюстрация из википедии, которую я несколько модифицировал для большей прозрачности и понимания материала:</span></p>
<p align="center" style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23965.png" /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-weight:600; color:#ff0000;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Итак, давайте разберем данную </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">схему работы netfilter</span><span style=" font-family:'MS Shell Dlg 2';">. </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-style:italic; color:#ff0000;">Ахтунг! Ниже в трех абзацах изложена основная мысль статьи и принцип работы сетевого фильтра, поэтому желательно вчитаться как можно внимательнее!</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Сетевые пакеты поступают в сетевой интерфейс, настроенный на стек TCP/IP и после некоторых простых проверок ядром (например, контрольная сумма) проходят  последовательность </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#chain"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">цепочек (chain)</span></a><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> </span><span style=" font-family:'MS Shell Dlg 2';">(обозначены пунктиром). Пакет </span><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline;">обязательно</span><span style=" font-family:'MS Shell Dlg 2';"> проходит первоначальную цепочку </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">PREROUTING</span><span style=" font-family:'MS Shell Dlg 2';">. После цепочки </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">PREROUTING</span><span style=" font-family:'MS Shell Dlg 2';">, в соответствии с таблицей маршрутизации, проверяется кому принадлежит пакет и, в зависимости от назначения пакета, определяется куда он дальше попадет (в какую </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#chain"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">цепочку</span></a><span style=" font-family:'MS Shell Dlg 2';">). Если пакет </span><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline;">НЕ адресован</span><span style=" font-family:'MS Shell Dlg 2';"> (в TCP пакете поле адрес получателя - НЕ локальная система) локальной системе, то он направляется в цепочку </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">FORWARD</span><span style=" font-family:'MS Shell Dlg 2';">, если пакет </span><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline;">адресован</span><span style=" font-family:'MS Shell Dlg 2';"> локальной системе, то направляется в цепочку </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">INPUT</span><span style=" font-family:'MS Shell Dlg 2';"> и после прохождения </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">INPUT</span><span style=" font-family:'MS Shell Dlg 2';"> отдается локальным демонам/процессам. После обработки локальной программой, при необходимости формируется ответ. Ответный пакет пакет отправляемый локальной системой в соответствии с правилами маршрутизации направляется на соответствующий маршрут (хост из локальной сети или адрес маршрутизатора) и направляется в цепочку </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">OUTPUT</span><span style=" font-family:'MS Shell Dlg 2';">. После цепочки </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">OUTPUT</span><span style=" font-family:'MS Shell Dlg 2';"> (или </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">FORWARD</span><span style=" font-family:'MS Shell Dlg 2';">, если пакет был проходящий) пакет снова сверяется с правилами маршрутизации и отправляется в цепочку </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">POSTROUTING</span><span style=" font-family:'MS Shell Dlg 2';">. Может возникнуть резонный вопрос: </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">почему несколько раз пакет проходит через таблицу маршрутизации?</span><span style=" font-family:'MS Shell Dlg 2';"> (об этом - </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#nat"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">ниже</span></a><span style=" font-family:'MS Shell Dlg 2';">).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Каждая </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#cain"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">цепочка</span></a><span style=" font-family:'MS Shell Dlg 2';">, которую проходит пакет состоит из набора </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">таблиц (table)</span></a><span style=" font-family:'MS Shell Dlg 2';"> (обозначены овалами). </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">Таблицы</span></a><span style=" font-family:'MS Shell Dlg 2';"> в разных цепочках имеют одинаковое наименование, но тем не менее никак между собой </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">не связаны</span><span style=" font-family:'MS Shell Dlg 2';">. Например</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> таблица nat</span><span style=" font-family:'MS Shell Dlg 2';"> в цепочке </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">PREROUTING</span><span style=" font-family:'MS Shell Dlg 2';"> никак не связана с </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">таблицей nat</span><span style=" font-family:'MS Shell Dlg 2';"> в цепочке </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">POSTROUTING</span><span style=" font-family:'MS Shell Dlg 2';">. </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">Каждая таблица </span></a><span style=" font-family:'MS Shell Dlg 2';">состоит из упорядоченного  набора (списка)</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#rule"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">правил</span></a><span style=" font-family:'MS Shell Dlg 2';">. </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#rule"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">Каждое правило</span></a><span style=" font-family:'MS Shell Dlg 2';"> содержит </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#match"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">условие</span></a><span style=" font-family:'MS Shell Dlg 2';">, которому должен соответствовать проходящий пакет и </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#jump"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">действия</span></a><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> к пакету</span><span style=" font-family:'MS Shell Dlg 2';">, подходящему данному условию.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Проходя через серию </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#chain"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">цепочек</span></a><span style=" font-family:'MS Shell Dlg 2';"> пакет последовательно проходит </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">каждую </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">таблицу</span></a><span style=" font-family:'MS Shell Dlg 2';"> (в указанном на иллюстрации порядке) и в </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">каждой </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">таблице</span></a><span style=" font-family:'MS Shell Dlg 2';"> последовательно сверяется с</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> каждым </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#rule"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">правилом</span></a><span style=" font-family:'MS Shell Dlg 2';"> (точнее сказать - с каждым набором условий/критериев в правиле), и если пакет соответствует какому-либо </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#match"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">критерию</span></a><span style=" font-family:'MS Shell Dlg 2';">, то выполняется </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">заданное </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#jump"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">действие</span></a><span style=" font-family:'MS Shell Dlg 2';"> над пакетом. При этом, в </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">каждой таблице</span><span style=" font-family:'MS Shell Dlg 2';"> (кроме пользовательских) существует заданная </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">по-умолчанию политика</span><span style=" font-family:'MS Shell Dlg 2';">. Данная политика определяет действие над пакетом, в случае, если пакет не соответствует ни одному из правил в таблице. Чаще всего - это действие </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">ACCEPT</span><span style=" font-family:'MS Shell Dlg 2';">, чтобы принять пакет и передать в следующую таблицу или </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">DROP</span><span style=" font-family:'MS Shell Dlg 2';"> - чтобы отбросить пакет. В случае, если пакет не был отброшен, он завершает свое путешествие по ядру системы и отправляется в сетевую карту сетевой интерфейс, которая подходит по правилам маршрутизации.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">Очень часто о таблицах и цепочках говорят в плоскости &quot;таблицы содержат  в себе наборы цепочек&quot;, но я считаю, что это неудобно и непонятно.</span></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Цепочки netfilter: </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">PREROUTING</span> — для изначальной обработки <span style=" font-weight:600;">входящих</span> пакетов</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">INPUT</span> — для входящих пакетов, адресованных непосредственно <span style=" font-weight:600;">локальному компьютеру</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">FORWARD</span> — для <span style=" font-weight:600;">проходящих</span> (маршрутизируемых) пакетов</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">OUTPUT</span> — для пакетов, <span style=" font-weight:600;">создаваемых</span> локальным компьютером (исходящих)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">POSTROUTING</span>— для окончательной обработки <span style=" font-weight:600;">исходящих</span> пакетов</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также можно создавать и уничтожать собственные цепочки при помощи утилиты iptables.</li></ul>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Цепочки организованны в 4 таблицы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">raw</span> — пакет проходит данную таблицу до передачи <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#conn"><span style=" text-decoration: underline; color:#0000ff;">системе определения состояний</span></a>. Используется редко, например для маркировки пакетов, которые НЕ должны обрабатываться системой определения состояний. Для этого в правиле указывается действие <span style=" font-style:italic;">NOTRACK</span>. Содержитcя в цепочках <span style=" font-style:italic;">PREROUTING</span> и<span style=" font-style:italic;"> OUTPUT</span>.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">mangle</span> — содержит правила модификации (обычно полей заголовка) IP‐пакетов. Среди прочего, поддерживает действия <span style=" font-style:italic;">TTL</span>, <span style=" font-style:italic;">TOS</span>, и <span style=" font-style:italic;">MARK</span> (для изменения полей TTL и TOS, и для изменения маркеров пакета). Редко необходима и может быть опасна. Содержится во всех пяти стандартных цепочках.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">nat</span> — предназначена для подмены адреса отправителя или получателя. Данную таблицу проходят только первый пакет из потока, трансляция адресов или маскировка (подмена адреса отправителя или получателя) применяются ко всем последующим пакетам в потоке <span style=" font-weight:600;">автоматически</span>. Поддерживает действия <span style=" font-style:italic;">DNAT</span>, <span style=" font-style:italic;">SNAT</span>, <span style=" font-style:italic;">MASQUERADE</span>,<span style=" font-style:italic;"> REDIRECT</span>. Содержится в цепочках <span style=" font-style:italic;">PREROUTING</span>, <span style=" font-style:italic;">OUTPUT</span>, и <span style=" font-style:italic;">POSTROUTING</span>.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">filter</span> — <span style=" font-weight:600;">основная таблица</span>, используется по умолчанию если название таблицы не указано. Используется для фильтрации пакетов. Содержится в цепочках <span style=" font-style:italic;">INPUT</span>, <span style=" font-style:italic;">FORWARD</span>, и <span style=" font-style:italic;">OUTPUT</span>.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Как я уже отметил, непосредственно для фильтрации пакетов используются таблицЫ filter. Поэтому в рамках данной темы важно понимать, что для пакетов, предназначенных данному узлу необходимо модифицировать </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">таблицу filter цепочки INPUT</span><span style=" font-family:'MS Shell Dlg 2';">, для проходящих пакетов — цепочки </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">FORWARD</span><span style=" font-family:'MS Shell Dlg 2';">, для пакетов, созданных данным узлом — </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">OUTPUT</span><span style=" font-family:'MS Shell Dlg 2';">.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Примеры прохождения цепочек</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Последовательность обработки </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline;">входящего</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> пакета, предназначенного для локального процесса</span><span style=" font-family:'MS Shell Dlg 2';">:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">цепочка PREROUTING</span> </li>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица raw</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается  <span style=" font-weight:600;">таблица mangle</span>, далее происходит отслеживание соединений</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица nat</span> (используется для <span style=" font-weight:600;">DNAT </span>- модификация адреса получателя)</li></ol>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">маршрутизация</span>: если пакет надо маршрутизовать мимо локального хоста, то переходим к обработке <span style=" font-weight:600;">проходящего пакета, </span>если для он предназначен локальному хосту, то обрабатывается как локальный</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается<span style=" font-weight:600;"> цепочка INPUT </span> </li></ol>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица mangle</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица filter</span></li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Последовательность обработки пакета, </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline;">уходящего</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> с нашего хоста:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Маршрутизация: определение исходящего адреса, адреса назначения, используемого интерфейса; если пакет маршрутизируется внутрь (для локального хоста), то переходим к <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#input"><span style=" text-decoration: underline; color:#0000ff;">предыдущей процедуре</span></a></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается цепочка OUTPUT </li>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица raw</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица mangle</span>, фильтровать здесь не стоит, здесь же происходит отслеживание локально создаваемых соединений</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица nat</span> (NAT для локально сгенерированных пакетов)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается<span style=" font-weight:600;"> таблица filter</span></li></ol>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Повторная <span style=" font-weight:600;">маршрутизация</span>, т.к. в таблицах mangle и nat пакет мог быть изменён; если пакет маршрутизируется внутрь (для локального хоста), то переходим к <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#input"><span style=" text-decoration: underline; color:#0000ff;">предыдущей процедуре</span></a></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">цепочка POSTROUTING </span> </li></ol>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица mangle</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица nat</span> (используется для SNAT - модификация адреса источника, фильтровать здесь не стоит)</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Последовательность обработки </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline;">проходящего</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> пакета</span><span style=" font-family:'MS Shell Dlg 2';"> (начинается от п.2 </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#input"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">первой процедуры</span></a><span style=" font-family:'MS Shell Dlg 2';">):</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">цепочка FORWARD</span> </li>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица mangle</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица filter</span></li></ol>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">повторная <span style=" font-weight:600;">маршрутизация</span>, т.к. в таблице mangle пакет мог быть изменён; если пакет маршрутизируется внутрь (для локального хоста), то переходим к <a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#input"><span style=" text-decoration: underline; color:#0000ff;">первой процедуре</span></a></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается<span style=" font-weight:600;"> цепочка POSTROUTING</span> </li></ol>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица mangle</span></li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просматривается <span style=" font-weight:600;">таблица nat</span> (используется для SNAT и Masquerading, фильтровать здесь не стоит)</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="nat"></a><span style=" font-family:'MS Shell Dlg 2';">К</span><span style=" font-family:'MS Shell Dlg 2';">ак видно, </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">таблица nat</span><span style=" font-family:'MS Shell Dlg 2';"> и </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">mangle</span><span style=" font-family:'MS Shell Dlg 2';"> может модифицировать получателя или отправителя сетевого пакета. Именно поэтому сетевой пакет несколько раз сверяется с таблицей маршрутизации.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Механизм определения состояний (conntrack)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Выше в тексте несколько раз указывалось понятие &quot;определение состояний&quot;, оно заслуживает отдельной темы для обсуждения, но тем не менее я кратко затрону данный вопрос в текущем посте. В общем, механизм определения состояний (он же state machine, он же </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">conn</span><span style=" font-family:'MS Shell Dlg 2';">ection </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">track</span><span style=" font-family:'MS Shell Dlg 2';">ing, он же </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">conntrack</span><span style=" font-family:'MS Shell Dlg 2';">) является частью пакетного фильтра и позволяет определить определить к какому соединению/сеансу принадлежит пакет. </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Conntrack</span><span style=" font-family:'MS Shell Dlg 2';"> анализирует состояние всех пакетов, кроме тех, которые помечены как </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">NOTRACK в таблице raw</span><span style=" font-family:'MS Shell Dlg 2';">. На основе этого состояния определяется принадлежит пакет </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">новому</span><span style=" font-family:'MS Shell Dlg 2';"> соединению (состояние </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">NEW</span><span style=" font-family:'MS Shell Dlg 2';">), уже </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">установленному </span><span style=" font-family:'MS Shell Dlg 2';">соединению (состояние </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">ESTABLISHED</span><span style=" font-family:'MS Shell Dlg 2';">), </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">дополнительному</span><span style=" font-family:'MS Shell Dlg 2';"> к уже существующему (</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">RELATED</span><span style=" font-family:'MS Shell Dlg 2';">), либо к &quot;</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">другому</span><span style=" font-family:'MS Shell Dlg 2';">&quot; (неопределяемому) соединению (состояние </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">INVALID</span><span style=" font-family:'MS Shell Dlg 2';">). Состояние пакета определяется на основе анализа заголовков передаваемого TCP-пакета. </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Модуль conntrack</span><span style=" font-family:'MS Shell Dlg 2';"> позволяет реализовать межсетевой экран сеансового уровня (пятого </span><a href="http://www.k-max.name/linux/osnovnye-ponyatiya-setej/#osi"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">уровня модели OSI</span></a><span style=" font-family:'MS Shell Dlg 2';">). Для управления данным механизмом используется утилита </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">conntrack,</span><span style=" font-family:'MS Shell Dlg 2';"> а так же параметр утилиты iptables: </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">-m conntrack</span><span style=" font-family:'MS Shell Dlg 2';"> или </span><span style=" font-family:'Courier New,courier'; font-style:italic;">-m state </span><span style=" font-family:'MS Shell Dlg 2';">(устарел). Состояния текущих соединений conntrack хранит в ядре. Их можно просмотреть в файле </span><span style=" font-family:'Courier New,courier';">/proc/net/nf_conntrack (или /proc/net/ip_conntrack)</span><span style=" font-family:'MS Shell Dlg 2';">.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Чтобы мысли не превратились в кашу, думаю данной краткой информации для понимания дальнейшего материала будет достаточно.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Управление правилами сетевой фильтрации Netfilter (использование команды iptables)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Утилита iptables</span><span style=" font-family:'MS Shell Dlg 2';"> является интерфейсом для управления </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">сетевым экраном netfilter</span><span style=" font-family:'MS Shell Dlg 2';">. Данная команда позволяет редактировать правила таблиц, таблицы и цепочки. Как я уже говорил - </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">каждое правило</span><span style=" font-family:'MS Shell Dlg 2';"> представляет собой запись/строку, содержащую в себе </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#match"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">критерии</span></a><span style=" font-family:'MS Shell Dlg 2';"> отбора сетевых пакетов и </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#jump"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">действие</span></a><span style=" font-family:'MS Shell Dlg 2';"> над пакетами, которые соответствуют заданному правилу. </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Команда iptables</span><span style=" font-family:'MS Shell Dlg 2';"> требует для своей работы прав root.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">В общем случае формат команды следующий:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">iptables [-t </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">таблица</span></a><span style=" font-family:'Courier New,courier';">] </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#command"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">команда</span></a><span style=" font-family:'Courier New,courier';"> [</span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#match"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">критерии</span></a><span style=" font-family:'Courier New,courier';">] [</span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#jump"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">действие</span></a><span style=" font-family:'Courier New,courier';">]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Все параметры в квадратных скобках - </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">необязательны</span><span style=" font-family:'MS Shell Dlg 2';">. По умолчанию используется </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">таблица filter</span><span style=" font-family:'MS Shell Dlg 2';">, если же необходимо указать другую таблицу, то следует использовать ключ </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">-t</span><span style=" font-family:'MS Shell Dlg 2';"> с указанием</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;"> имени </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#table"><span style=" font-family:'MS Shell Dlg 2'; font-style:italic; text-decoration: underline; color:#0000ff;">таблицы</span></a><span style=" font-family:'MS Shell Dlg 2';">. После имени таблицы указывается </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#command"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">команда</span></a><span style=" font-family:'MS Shell Dlg 2';">, определяющая действие (</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">например</span><span style=" font-family:'MS Shell Dlg 2';">: вставить правило, или добавить правило в конец цепочки, или удалить правило). </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#match"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">&quot;критерии&quot;</span></a><span style=" font-family:'MS Shell Dlg 2';"> задает параметры отбора. </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#jump"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">&quot;действие&quot;</span></a><span style=" font-family:'MS Shell Dlg 2';"> указывает, какое действие должно быть выполнено при условии совпадения критериев отбора в правиле (</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">например</span><span style=" font-family:'MS Shell Dlg 2';">: передать пакет в другую цепочку правил, &quot;сбросить&quot; пакет, выдать на источник сообщение об ошибке...).</span></p>
<p style="-qt-paragraph-type:empty; margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Ниже приведены команды и параметры утилиты iptables:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2';"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="1" cellpadding="2">
<tr>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="id_77"></a><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">П</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">араметр</span></p></td>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">Описание</span></p></td>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">Пример</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Команды</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--append (-A)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Добавить в указанную цепочку и указанную таблицу заданное правило в КОНЕЦ списка.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A FORWARD критерии -j действие</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--delete (-D)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Удаляет заданное номером(ами) или правилом(ами) правило(а). Первый пример удаляет все правила с номерами 10,12 во всех цепочках, в таблицах filter, второй пример удаляет заданное правило из таблицы mangle в цепочке PREROUTING.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -D 10,12</span><span style=" font-family:'MS Shell Dlg 2';"><br />iptables -t mangle -D PREROUTING критерии -j действие</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--rename-chain (-E)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Изменить имя цепочки.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -E OLD_CHAIN NEW_CHAIN</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--flush (-F)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Очистка всех правил текущей таблицы. Ко всем пакетам, которые относятся к уже установленным соединениям, применяем терминальное действие ACCEPT — пропустить</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -F</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--insert (-I)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Вставляет заданное правило в место, заданное номером.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -I FORWARD 5 критерии -j действие</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--list (сокр. -L)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Просмотр существующих правил (без явного указания таблицы - отображается таблица filter всех цепочек).</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -L</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--policy (-P)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Устанавливает стандартную политику для заданной цепочки.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -t mangle -P PREROUTING DROP</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--replace (-R)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Заменяет заданное номером правило на заданное в критериях.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -R POSROUTING 7 | критерии -j действие</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--delete-chain (-X)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Удалить ВСЕ созданные вручную цепочки (оставить только стандартные INPUT, OUTPUT, FORWARD, PREROUTING и POSTROUTING).</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -X</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--zero (-Z)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Обнуляет счетчики переданных данных в цепочке.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -Z INPUT</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Параметры</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--numeric (-n)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Не резолвит адреса и протоколы при выводе.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;"></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--line-numbers</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Указывать номера правил при выводе (может использоваться совместно с -L).</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -L --line-numbers</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--help (-h)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">куда же без нее </span><img src="image3394.png" style="vertical-align: top;" /><span style=" font-family:'MS Shell Dlg 2';"> </span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;"></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-t таблица</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Задает название таблицы, над которой необходимо совершить действие. В примере сбрасывается таблица nat во всех цепочках.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -t nat -F</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--verbose (-v)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Детальный вывод.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -L -v</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Критерии (параметры) отбора сетевых пакетов команды iptables</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Критерии отбора сетевых пакетов</span><span style=" font-family:'MS Shell Dlg 2';"> негласно делятся на несколько групп: Общие критерии, Неявные критерии, Явные критерии. </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#obchie"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">Общие критерии</span></a><span style=" font-family:'MS Shell Dlg 2';"> допустимо употреблять в любых правилах, они не зависят от типа протокола и не требуют подгрузки модулей расширения. </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#neyav"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">Неявные критерии</span></a><span style=" font-family:'MS Shell Dlg 2';"> (я бы из назвал </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">необщие</span><span style=" font-family:'MS Shell Dlg 2';">),  те критерии, которые подгружаются неявно и становятся доступны, например при указании общего критерия </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">--protocol tcp|udp|icmp</span><span style=" font-family:'MS Shell Dlg 2';">. Перед использованием </span><a href="http://www.k-max.name/linux/netfilter-iptables-v-linux/#yavnie"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; text-decoration: underline; color:#0000ff;">Явных критериев</span></a><span style=" font-family:'MS Shell Dlg 2';">, необходимо подключить </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">дополнительное расширение</span><span style=" font-family:'MS Shell Dlg 2';"> (это своеобразные </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">плагины</span><span style=" font-family:'MS Shell Dlg 2';"> для netfilter). </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Дополнительные расширения</span><span style=" font-family:'MS Shell Dlg 2';"> подгружаются с помощью параметра </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">-m</span><span style=" font-family:'MS Shell Dlg 2';"> или</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;"> --match</span><span style=" font-family:'MS Shell Dlg 2';">. Так, например, если мы собираемся использовать критерии </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">state</span><span style=" font-family:'MS Shell Dlg 2';">, то мы должны явно указать это в строке правила:</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;"> -m state</span><span style=" font-family:'MS Shell Dlg 2';"> левее используемого критерия. Отличие между </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">явными</span><span style=" font-family:'MS Shell Dlg 2';"> и </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">неявными необщими</span><span style=" font-family:'MS Shell Dlg 2';"> критериями заключается в том, что явные нужно подгружать явно, а неявные подгружаются автоматически.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Во всех критериях можно использовать </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">знак !</span><span style=" font-family:'MS Shell Dlg 2';"> перед значением критерия. Это будет означать, что под данное правило подпадают все пакеты, которые</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;"> не соответствуют данному параметру</span><span style=" font-family:'MS Shell Dlg 2';">. </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">Например</span><span style=" font-family:'MS Shell Dlg 2';">: критерий </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">--protocol !</span><span style=" font-family:'MS Shell Dlg 2';"> </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">tcp</span><span style=" font-family:'MS Shell Dlg 2';"> будет обозначать, что все пакеты, которые </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">не</span><span style=" font-family:'MS Shell Dlg 2';"> являются TCP-протоколом подходят под действие правила. Однако последние версии iptables (в частности, 1.4.3.2 и выше), уже не поддерживают этот синтаксис и требуют использования не </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">--protocol ! tcp</span><span style=" font-family:'MS Shell Dlg 2';">, а</span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;"> ! --protocol tcp</span><span style=" font-family:'MS Shell Dlg 2';">,  выдавая следующую ошибку:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">Using intrapositioned negation (`--option ! this`) is deprecated in favor of extrapositioned (`! --option this`).</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Ниже в виде таблицы приведены </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">часто используемые параметры отбора пакетов:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2';"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="1" cellpadding="2">
<tr>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="id_77"></a><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">П</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">араметр</span></p></td>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">Описание</span></p></td>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">Пример</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Общие параметры</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="obchie"></a><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-</span><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-protocol</span><span style=" font-family:'MS Shell Dlg 2';"><br />(сокр. -p)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Определяет протокол </span><a href="http://www.k-max.name/linux/osnovnye-ponyatiya-setej/#osi"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">транспортного уровня</span></a><span style=" font-family:'MS Shell Dlg 2';">. Опции tcp, udp, icmp, all или любой другой протокол определенный в /etc/protocols</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT -p tcp</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--source</span><span style=" font-family:'MS Shell Dlg 2';"><br />(-s, --src)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">IP адрес источника пакета. Может быть определен несколькими путями:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Одиночный хост: host.domain.tld, или IP адрес: 10.10.10.3</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пул-адресов (подсеть): 10.10.10.3/24 или 10.10.10.3/255.255.255.0</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Настойчиво не рекомендуется использовать доменные имена, для разрешения (резольва) которых требуются DNS-запросы, так как на этапе конфигурирования netfilter DNS может работать некорректно. Также, заметим, имена резольвятся всего </span><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline;">один раз</span><span style=" font-family:'MS Shell Dlg 2';"> — при добавлении правила в цепочку. Впоследствии соответствующий этому имени IP-адрес может измениться, но на уже записанные правила это никак не повлияет (в них останется старый адрес). Если указать доменное имя, которое резольвится в несколько IP-адресов, то для каждого адреса будет добавлено отдельное правило.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT -s 10.10.10.3</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--destination</span><span style=" font-family:'MS Shell Dlg 2';"><br />(-d)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">IP адрес назначения пакета. Может быть определен несколькими путями (см. --source).</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT --destination 192.168.1.0/24</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--in-interface</span><span style=" font-family:'MS Shell Dlg 2';"><br />(-i)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Определяет интерфейс, на который прибыл пакет. Полезно для NAT и машин с несколькими сетевыми интерфейсами. Применяется в цепочках INPUT, FORWARD и PREROUTING. Возможно использование знака &quot;+&quot;, тогда подразумевается использование всех интерфейсов, начинающихся на имя+ (например eth+ - все интерфейсы eth).</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -t nat -A PREROUTING --in-interface eth0</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--out-interface</span><span style=" font-family:'MS Shell Dlg 2';"><br />(-o)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Определяет интерфейс, с которого уйдет пакет. Полезно для NAT и машин с несколькими сетевыми интерфейсами. Применяется в цепочках OUTPUT, FORWARD и POSTROUTING. Возможно использование знака &quot;+&quot;.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -t nat -A POSTROUTING --in-interface eth1</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Неявные (необщие) параметры</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="neyav"></a><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-</span><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">p proto -h</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">вывод справки по неявным параметрам протокола proto.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -p icmp -h</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--source-port</span><span style=" font-family:'MS Shell Dlg 2';"><br />(--sport)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Порт источник, возможно только для протоколов --protocol tcp, или --protocol udp</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT --protocol tcp --source-port 25</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--destination-port</span><span style=" font-family:'MS Shell Dlg 2';"><br />(--dport)</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Порт назначения, возможно только для протоколов --protocol tcp, или --protemocol udp</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT --protocol udp --destination-port 67</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Явные параметры</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="yavnie"></a><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-</span><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">m state --state (устарел)</span><span style=" font-family:'MS Shell Dlg 2';"><br />он же<br />-m conntrack --ctstate</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="id_103"></a><span style=" font-family:'MS Shell Dlg 2';">С</span><span style=" font-family:'MS Shell Dlg 2';">остояние соединения. Доступные опции:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">NEW</span> (Все пакеты устанавливающие новое соединение)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">ESTABLISHED</span> (Все пакеты, принадлежащие установленному соединению)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RELATED</span> (Пакеты, не принадлежащие установленному соединению, но связанные с ним. Например - FTP в активном режиме использует разные соединения для передачи данных. Эти соединения связаны.)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">INVALID</span> (Пакеты, которые не могут быть по тем или иным причинам идентифицированы. Например, ICMP ошибки не принадлежащие существующим соединениям)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">и др. (более подробно в документации)</li></ul></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT -m state --state NEW,ESTABLISHEDiptables -A INPUT -m conntrack --ctstate NEW,ESTABLISHED</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-m mac --mac-source</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Задает MAC адрес сетевого узла, передавшего пакет. MAC адрес должен указываться в форме XX:XX:XX:XX:XX:XX.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">-m mac --mac-source 00:00:00:00:00:0</span></p></td></tr></table>
<p style="-qt-paragraph-type:empty; margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Действия над пакетами</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="id_122"></a><span style=" font-family:'MS Shell Dlg 2';">Д</span><span style=" font-family:'MS Shell Dlg 2';">анный заголовок правильнее будет перефразировать в &quot;</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Действия над пакетами, которые совпали с критериями отбора</span><span style=" font-family:'MS Shell Dlg 2';">&quot;. Итак, для совершения какого-либо </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">действия над пакетами</span><span style=" font-family:'MS Shell Dlg 2';">, необходимо задать ключ </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">-j (--jump)</span><span style=" font-family:'MS Shell Dlg 2';"> и указать, какое конкретно действие совершить.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Действия над пакетами могут принимать следующие значения:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">ACCEPT </span>- пакет покидает данную <span style=" text-decoration: underline;">цепочку</span> и передается в следующую (дословно - ПРИНЯТЬ).</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">DROP </span>- отбросить удовлетворяющий условию пакет, при этом пакет не передается в другие таблицы/цепочки.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">REJECT </span>- отбросить пакет, отправив отправителю ICMP-сообщение, при этом пакет не передается в другие таблицы/цепочки.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RETURN </span>- возвратить пакет в предыдущую цепочку и продолжить ее прохождение начиная со следующего правила.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">SNAT </span>- применить трансляцию адреса <span style=" font-weight:600;">источника</span> в пакете. Может использоваться только в цепочках <span style=" font-weight:600;">POSTROUTING и OUTPUT</span> в таблицах nat.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">DNAT </span>- применить трансляцию адреса <span style=" font-weight:600;">назначения</span> в пакете. Может использоваться в цепочке <span style=" font-weight:600;">PREROUTING</span> в таблице nat. (в исключительных случаях - в цепочке OUTPUT)</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">LOG </span>- протоколировать пакет (отправляется демону <a href="http://www.k-max.name/linux/syslogd-and-logrotate/"><span style=" text-decoration: underline; color:#0000ff;">syslog</span></a>) и обработать остальными правилами.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">MASQUERADE </span>— используется вместо <span style=" font-weight:600;">SNAT</span> при наличии соединения с динамическим IP (допускается указывать только в цепочке <span style=" font-style:italic;">POSTROUTING</span> таблицы nat).</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">MARK </span>— используется для установки меток на пакеты, передается для обработки дальнейшим правилам.</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">и др.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Кроме указанных действий, существуют и другие, с которыми можно ознакомиться в документации (возможно, в скором времени я дополню статью в ходе освоения темы). У некоторых действий есть дополнительные параметры.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">В таблице ниже приведены примеры и описания дополнительных параметров:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2';"><br /></p>
<table border="0" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px;" cellspacing="1" cellpadding="2">
<tr>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="id_77"></a><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">П</span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">араметр</span></p></td>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">Описание</span></p></td>
<td bgcolor="#d8d8d8">
<p align="center" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600; background-color:#d8d8d8;">Пример</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">DNAT (Destination Network Address Translation)</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--to-destination</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">указывает, какой IP адрес должен быть подставлен в качестве адреса места назначения. В примере во всех пакетах протокола tcp, пришедших на адрес 1.2.3.4, данный адрес будет заменен на 4.3.2.1.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -t nat -A PREROUTING -p tcp -d 1.2.3.4 -j DNAT --to-destination 4.3.2.1</span></p></td></tr>
<tr>
<td colspan="3" bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">LOG</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--log-level</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Используется для задания уровня журналирования (</span><a href="http://www.k-max.name/linux/syslogd-and-logrotate/#level"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">log level</span></a><span style=" font-family:'MS Shell Dlg 2';">). В примере установлен максимальный уровень логирования для всех tcp пакетов в таблице filter цепочки FORWARD.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A FORWARD -p tcp -j LOG --log-level debug</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--log-prefix</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Задает текст (префикс), которым будут предваряться все сообщения </span><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">iptables</span><span style=" font-family:'MS Shell Dlg 2';">. (очень удобно для дальнейшего </span><a href="http://www.k-max.name/linux/osnovnye-komandy-linux-ili-shpargalka-nachinayushhego-linuksojda/#find"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">парсинга</span></a><span style=" font-family:'MS Shell Dlg 2';">) Префикс может содержать до 29 символов, включая и пробелы. В примере отправляются в syslog все tcp пакеты в таблице filter цепочки INPUT с префиксом INRUT-filter.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A INPUT -p tcp -j LOG --log-prefix &quot;INRUT-filter&quot;</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">--log-ip-options</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">Позволяет заносить в </span><a href="http://www.k-max.name/linux/syslogd-and-logrotate/"><span style=" font-family:'MS Shell Dlg 2'; text-decoration: underline; color:#0000ff;">системный журнал</span></a><span style=" font-family:'MS Shell Dlg 2';"> различные сведения из заголовка IP пакета.</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">iptables -A FORWARD -p tcp -j LOG --log-ip-options</span></p></td></tr>
<tr>
<td bgcolor="#eaeaea" style=" vertical-align:top;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; background-color:#eaeaea;">и др...</span></p></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;"></td>
<td bgcolor="#eaeaea" style=" vertical-align:top;"></td></tr></table>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">На этом закончим теорию о сетевом фильтре netfilter/iptables. В следующей статье я приведу практические примеры для усвоения данной теории.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Резюме</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">В данной статье мы рассмотрели очень кратко основные понятия сетевого фильтра в Linux. Итак, подсистема netfilter/iptables является частью ядра Linux и используется для организации различных схем фильтрации и манипуляции с сетевыми пакетами. При этом, каждый пакет проходит от сетевого интерфейса, в который он прибыл и далее по определенному маршруту цепочек, в зависимости от того, предназначен он локальной системе или &quot;нелокальной&quot;. Каждая цепочка состоит из набора таблиц, содержащих последовательный набор правил. Каждое правило состоит из определенного критерия/критериев отбора сетевого пакета и какого-то действия с пакетом, соответствующего данным критериям. В соответствии с заданными правилами над пакетом может быть совершено какое-либо действие (Например, передача следующей/другой цепочке, сброс пакета, модификация содержимого или заголовков и др.).  Каждая цепочка и каждая таблица имеет свое назначение, функциональность и место в пути следования пакета. Например для фильтрации пакетов используется таблица filter, которая содержится в трех стандартных цепочках и может содержаться в цепочках, заданных пользователем. Завершается путь пакета либо в выходящем сетевом интерфейсе, либо доставкой локальному процессу/приложению.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-weight:600;">Литература</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Довольно много интересной информации на русском содержится тут:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">http://www.opennet.ru/docs/RUS/iptables/</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">http://ru.wikibooks.org/wiki/Iptables</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';">Более глубоко материал доступен на буржуйском вот тут:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">http://www.frozentux.net/documents/ipsysctl-tutorial/</li>
<li style=" font-family:'MS Shell Dlg 2';" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">http://www.netfilter.org/documentation/index.html</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2';"> </span><span style=" font-family:'MS Shell Dlg 2'; font-style:italic;">С Уважением, Mc.Sim!</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-style:italic;"><br /></p></body></html>