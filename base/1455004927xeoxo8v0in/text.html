<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После переезда в новый офис, дабы не расслаблять сотрудников, было решено установить систему видеонаблюдения. Но, как обычно, основным условием было: дешево и сердито :) После обдумывания и подсчетов было решено остановиться на следующем: IP-камеры и компьютер в качестве регистратора.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Для начала попробовали небезызвестный ZoneMinder. Но отчего-то с 9 камерами он грузил систему нещадно. После некоторой борьбы с ним, было решено отказаться от него. Поискав на просторах Internet была найдена программка под названием motion (http://www.lavrsen.dk/twiki/bin/view/Motion/WebHome). Почитав немного про нее, было решено остановиться на ней.<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, у нас были IP камеры, компьютер в качестве регистратора, motion в качестве софта и желание подружить весь этот колхоз. И что же умеет motion из того, что нам надо? :)</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Работа с камерами, подключенными через карты захвата либо с IP камерами.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выполнять скрипты при наступлении и окончании события.</li></ol>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ну чтож, приступим. Для начала попробуем с одной камерой. Устанавливаем motion.<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, в папке <span style=" font-family:'Courier New'; color:#6a1009;">/etc/motion/</span> копируем файл с конфигурацией (<span style=" font-family:'Courier New'; color:#6a1009;">motion.conf</span>) в файл для нашей камеры, например motion1.conf. А теперь начинаем его править под себя:</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />1. закомментируем строчку </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">videodevice /dev/video0</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">2. в строке <span style=" font-family:'Courier New'; color:#6a1009;">netcam_url</span> прописываем URL для доступа к нашей камере. Мы использовали IP камеры Axis, модель 207 (со встроенным микрофоном).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для нашего случая выглядело так:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">netcam_url </span><a href="http://http"><span style=" font-family:'Courier New'; text-decoration: underline; color:#6a1009;">http</span></a><span style=" font-family:'Courier New'; color:#6a1009;">://camera_ip/axis-cgi/mjpg/video.cgi?resolution=640x480</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">где camera_ip — IP адрес камеры.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />3. далее находим строку <span style=" font-family:'Courier New'; color:#6a1009;">target_dir</span> — здесь указываем путь к папке, где будемхранить данные с камеры.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">4. а теперь начинается самое интересное. Находим строку <span style=" font-family:'Courier New'; color:#6a1009;">on_event_start</span>. Здесь мы прописываем команду, которая будет выполняться при наступлении события, то есть при движении. Что нам это дает? А дает нам это то, что мы не будем постояно вести запись, а только по необходимости — есть движение, идет запись, закончилось, остановились и мы. Таким образом получается экономия. Для сравнения — у нас ведется запись с 10 камер — цветная картинка 640х480 со звуком, записи хранятся 21 день и все это дело занимает на диске в среднем 135GB, а всесте с фото, которые делает motion около 200 GB. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">5. следующая строка: <span style=" font-family:'Courier New'; color:#6a1009;">on_event_end</span> — это для команды, отрабатывающей по окончанию события.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">6. И еще один нюанс, motion поднимает небольшой http сервер, а так как для каждой камеры запускается своя инстанция программы с отдельным конфигом, то важно, чтобы он слушал на разных портах. Для этого проверяем, чтобы следующие строки отличались в каждом файле:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">webcam_port и control_port<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Для примера: для первой камеры ставим значения</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">webcam_port 8081<br />control_port 8080<br />для второй<br />webcam_port 8083<br />control_port 8082<br />и так далее.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это в принципе основные изменения. Думаю при внимательном прочтении конфига вы сами найдете нужные вам параметры, так как там все довольно хорошо задокументировано.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь вернемся к скриптам, которые отрабатывают при начале и окончании события. Так как нам надо писать видео с камеры, то для этого я использовал mencoder. В папке <span style=" font-family:'Courier New'; color:#6a1009;">/root/bin/</span> создаем скрипты <span style=" font-family:'Courier New'; color:#6a1009;">recordstart.sh</span> и <span style=" font-family:'Courier New'; color:#6a1009;">recordstop.sh</span>, которые будут запускаться при наступлеии и окончании события соответсвенно. Давайте заглянем внутрь <span style=" font-family:'Courier New'; color:#6a1009;">recordstart.sh</span>:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">[root@video bin]# cat /root/bin/recordstart.sh<br />#!/bin/bash<br /><br /># We are using two variables<br /># 1 — camera name<br /># 2 — directory name (where file will be stored)<br /><br /># Generate filename<br />start=«cam${1}»<br />dt=`date +%Y%m%d%H%M%S`<br />FILENAME=&quot;${start}-${dt}.avi&quot;<br />echo $FILENAME<br /><br />if [ &quot;$1&quot; -eq 218 ]<br />then<br />`/usr/bin/mencoder -ovc copy -oac pcm -delay 1.5 -mc 10 -o<br />/video/motion/$2/$FILENAME rtsp://192.168.95.218/mpeg4/media.amp &gt; /dev/null`<br />elif [ &quot;$1&quot; -eq 219 ]<br />then<br />`/usr/bin/mencoder -ovc copy -oac pcm -delay 1.5 -mc 10 -o<br />/video/motion/$2/$FILENAME rtsp://192.168.95.219/mpeg4/media.amp &gt; /dev/null`<br />else<br />`/usr/bin/mencoder -ovc copy -oac pcm -mc 10 -o /video/motion/$2/$FILENAME<br />rtsp://192.168.95.$1/mpeg4/media.amp &gt; /dev/null`<br />fi</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Скрипт принимает два параметра:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">1 — имя камеры, хотя имя не совсем верно, так как это последний октет из IP адреса камеры. То есть, как в нашем случае (мы используем 95 подсеть — <span style=" font-family:'Courier New'; color:#6a1009;">192.168.95.0/24</span>). Таким образом, при передаче значения <span style=" font-family:'Courier New'; color:#6a1009;">211</span> — будет ясно, что хотим обратиться к камере с IP <span style=" font-family:'Courier New'; color:#6a1009;">192.168.95.211</span><br />2 — директория, где будет храниться записанный файл. Сделано для того, чтобы легче было искать. Опять же в нашем случае: имеется папка <span style=" font-family:'Courier New'; color:#6a1009;">/video/motion</span> в которой хранятся записи, но для того, чтобы не мешать все в кучу, она содержит поддиректории зон: <span style=" font-family:'Courier New'; color:#6a1009;">kuhnya</span>, <span style=" font-family:'Courier New'; color:#6a1009;">balkon</span> и т.д. Значит при передаче значения <span style=" font-family:'Courier New'; color:#6a1009;">balcon</span> — запись будеть производиться в директорию <span style=" font-family:'Courier New'; color:#6a1009;">/video/motion/balkon</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Итак, при вызове скрипта в виде <span style=" font-family:'Courier New'; color:#6a1009;">/root/bin/recordstart.sh 211 balkon</span> — скрипт будет писать с камеры с IP <span style=" font-family:'Courier New'; color:#6a1009;">192.168.95.211</span> в директорию <span style=" font-family:'Courier New'; color:#6a1009;">/video/motion/balkon</span>. Надеюсь тут все более-неменее ясно.<br /><br />Как видно, вначале мы генерируем уникальное имя для файла, в который будем писать, которое состоит из следующих частей:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">start — номер камеры, вернее последний октет из ее IP с предшествующим ей cam.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">dt — текущая дата в формате ГГГГММДДччммсс.</li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример имени файла: <span style=" font-family:'Courier New'; color:#6a1009;">cam218-20090924131847.avi</span> — то есть, пишется с камеры с IP <span style=" font-family:'Courier New'; color:#6a1009;">192.168.95.218</span>, дата начала: 2009 год, 09 месяц, 24 число, 13 часов, 18 минут, 47 секунд.<br /><br />Небольшое пояснение: так уж оказалось, что у нас разные модели камер, которые предоставляют разные способы доступа к потоку видео данных, из-за этого пришлось ввести в скрипте проверки.</p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Теперь пройдемся по mencoder-у:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">-ovc copy — означает, что видеоряд копируем, так как с камеры сразу идет в mpeg4</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">-oac pcm — какой кодек использовать для звуковой дорожки, если камера позволяет писать звук.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">-mc 10 — Максимальная величина корректировки A-V синхронизации на один кадр (в секундах)</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">-delay 1.5 — Задержка в мс, которая должна вноситься в каждый канал</li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Если у вас проблемы с синхронизацией видео и звукового ряда, тогда надо менять значения для последних двух параметров — mc и delay. Для теста можно использовать mplayer.<br /><br />Ну вот, теперь при наступлении события, мы можем запускать данный скрипт. Таким образом в конфиге для motion для нашей камеры прописываем в строке on_event_start что-то похожее: </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">on_event_start &quot;/root/bin/recordstart.sh 210 koridor1&quot;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">И он начнет писать. Но ведь это все еще надо остановить. Для этого используем второй скрипт /root/bin/recordstop.sh.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">[root@video bin]# cat /root/bin/recordstop.sh<br />#!/bin/bash<br /><br /># We are using one variable<br /># 1 — camera name<br /><br /># Get string with mencoder process PID<br />MPID=`ps ax | grep mencoder | grep cam${1} | awk '{ print $1 }'`<br /><br /># Kill process<br />`kill -15 $MPID`</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Скрипт принимает один параметр — все тот же последний октет из IP адреса камеры.<br /><br />Соответсвенно в строке <span style=" font-family:'Courier New'; color:#6a1009;">on_event_end</span> файла конфигурации прописываем что-то вроде:<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">on_event_end &quot;/root/bin/recordstop.sh 210&quot;Ну вот примерно и все, что касается конфигурации.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Теперь перейдем к рутинным операциям. У меня используются две, которые отрабатывают по крону.<br /></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Удаляет устаревшие файлы, которые страрше 21 дня.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Объединяет все файлы за день в один.</li></ol>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Рассмотрим скрипт для чистки. У меня он располагается в директории <span style=" font-family:'Courier New'; color:#6a1009;">/root/sbin</span> и, для того, чтобы враги не догадались, называется <span style=" font-family:'Courier New'; color:#6a1009;">clean.sh</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">[root@video ~]# cat /root/sbin/clean.sh<br />#!/bin/sh<br /><br />/bin/find /video/balkon -name &quot;*.*&quot; -mtime +21 -delete<br />/bin/find /video/motion/balkon -name &quot;*.*&quot; -mtime +21 -delete</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />В первой директории хранятся фотографии, сделанные motion — это параметр из файла конфигурации в строке target_dir. Вторая директория — куда пишется видео, запущенное из скрипта recordstart.sh</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">А вот второй скрипт посложнее.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">[root@video ~]# cat /root/sbin/concatfiles.py<br />import os, stat, types, commands<br /><br />workDir = '/video/motion/'<br />dirs = os.listdir(workDir)<br />oldDate = summaryFile = summaryFileTmp = ''<br />for dir in dirs:<br />  filesList = os.listdir(workDir + dir)<br />filesList.sort()<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">for file in filesList:<br />  tmpN = file.split('.')<br />  nm = tmpN[0]<br />  tmpN = nm.split('-')<br />  if tmpN[0] != 'S':<br />    nm = tmpN[1]<br />    year = nm[0:4]<br />    month = nm[4:6]<br />    day = nm[6:8]<br />    date = year + month + day<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">  if oldDate != date:<br />    summaryFile = workDir + dir + '/S-' + tmpN[0] + '-' + year +month + day + '.avi'<br />    summaryFileTmp = workDir + dir + '/S-' + tmpN[0] + '-' + year +month + day + '-tmp.avi'<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">  #conactenate files<br />  command = '/usr/bin/mencoder -oac copy -ovc copy ' + workDir + dir + '/' + tmpN[0] + '-' + date + '*.avi -o ' + summaryFileTmp<br />  os.system(command)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"><br />  #fix key frame<br />  command = 'ffmpeg -i ' + summaryFileTmp + ' -ss 0.04 -vcodec<br />  copy -acodec copy -vcodec copy -acodec copy ' + summaryFile<br />  os.system(command)<br />  </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">  #remove tmp file<br />  command = '/bin/rm -f ' + summaryFileTmp<br />  os.system(command)<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">  #remove old files<br />  command = '/bin/rm -f ' + workDir + dir + '/'+ tmpN[0] + '-' +<br />  date + '*.avi'<br />  os.system(command)<br />  oldDate = date</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это для объединения коротких роликов за день в один суммарный. (Для тех кто не в курсе — он на питоне). Единственное, что нужно менять — это переменная workDir — путь, куда mencoder пишет свои файлы, все из того же recordstart.sh<br /><br />Прописываем их в крон на выполнение раз в сутки, желательно ночью, пока карета не превратится в тыкву :)<br /><br />Запускаем motion следующим образом:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">motion -c /path/to/config/file</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">где<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">/path/to/config/file</span> — путь к нашему файлу с конфигом :)<br /><br />А далее запускаем их при загрузке системы.<br /><br />Ну вот наверное и все. Если будут вопросы — задавайте.<br /><br /><span style=" font-weight:600;">UPD:</span> будьте внимательны с скриптом на питоне, так как сбилась вся табуляция, что для него очень критично.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">UPD2:</span> отступы восстановлены, но не факт что правильно.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>