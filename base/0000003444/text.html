<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Всех приветсвую. Давно хотел написать что-то подобное, но все не хотел =). Решил полазить интернет, нашол только 1 пример рабочих конфигов, но они были направлены на защиту какого-то самописного сервера. Я раскажу, как защитить сайт, с помощью iptables. Рекомендую ознакомится со следущим небольщим справочником: <a href="http://bkmz.org/77"><span style=" text-decoration: underline; color:#0057ae;">Iptables FAQ</span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="more-425"></a>Далее, немного расскажу, про основные виды защиты не только сайтов.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Защита на уровне PHP. Не понимаю логики. Нам необходимо не пустить ботов к этому уровню, так как изза него очень большая нагрузка. Очень нерабочии варианты.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Защита на уровне Apache. mod_evasive когдато пользовал, толку с него не намного больше чем от PHP</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Защита на уровне nginx. Вот этот этап в проходе запроса уже более менеее нормальный. Можно закешировать страницы и nginx их будет отдавать практически без загрузки проца. Только канал будет использоваться гораздо более. Также можно настроить limit_req. Что это – читаем сайт sysoev.ru</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Защита на уровне iptables. Этот этап мы будем сегодня рассматривать, так как это один из самых эффективных способов защиты сервера.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Я знаю, а точнее использую два способа защиты сервера от атак.</p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Использование ipset для хранения IP зомби машин, и занос этих IP с использованием коммандлайнера раз в 60 секунд.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Динамически с использованием модуля recent ограничивать запросы.</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Также для начала необходимо немного настроить сам сервер, чтобы он не загибался при 5к запросов.</p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># Enables source route verification</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.conf.all.rp_filter = 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># Enables the magic-sysrq key</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">kernel.sysrq = 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># TCP Explict Congestion Notification</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;">#net.ipv4.tcp_ecn = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># we do not want all our interfaces to send redirects</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.conf.default.send_redirects = 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.conf.all.send_redirects = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.ip_forward = 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.ip_dynaddr = 1</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># Controls the maximum size of a message, in bytes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">kernel.msgmnb = 65536</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># Controls the default maxmimum size of a mesage queue</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">kernel.msgmax = 65536</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># Controls the maximum shared segment size, in bytes</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">kernel.shmmax = 4294967295</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-style:italic; color:#6a0e07;"># Controls the maximum number of shared memory segments, in pages</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">kernel.shmall = 268435456</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_keepalive_time = 15</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_keepalive_intvl = 10</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_keepalive_probes = 5</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_fin_timeout = 30</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_window_scaling = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_sack = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.tcp_timestamps = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_max = 224000</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_close = 30</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait = 30</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_last_ack = 120</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait = 30</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait = 60</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_established = 190</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_recv = 30</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">net.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_sent = 30</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Эти значения подобраны потом и кровью и используются на сервере с 14 гигами памяти. Вам я рекомендую поуменьшать некоторые из них.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">iptables -I INPUT 1 -p tcp -m tcp --dport 80 --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 15 --connlimit-mask 32 -j DROP</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Устанавливаем число одновременных запросов на IP с префиксом/32 – максимум 15, остальное в DROP.</p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">ipset -N blacklist iphash</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">iptables -A INPUT -p tcp -m tcp --dport 80 -m </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">set</span><span style=" font-family:'Courier New'; color:#6a0e07;"> --set blacklist src -j DROP</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Создаем специальный сет для хранения IP. При больших потоках запросов, а также over 100 правил вида:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">iptables -A INPUT -s x.x.x.x -j DROP</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы будете иметь колосальную нагрузку на свой сервер, но это единственный вариант для OpenVZ виртуализации, все экзотические правила, требуют специальных модулей, просите свой саппорт чтобы они на вашу ВМ их подключили.<br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Преимущества ipset:</p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В одном списке, не может быть одинаковых записей. В iptables это не запрещено, поэтому ухудшается отклик сетевой подсистемы.</li>
<li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Один списко позволяет хранить до MAX_INT(65k) записей.</li>
<li style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Хранятся они в виде бинарного дерева(может быть и не так =) ), что позволяет снизить кол-во проверок до log(кол-во записей) в худшем случае.</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все мои коммандлайнеры предназначены для глобального access.log’а nginx’а. Если у вас другой вид записей, то тут уже правьте сами (:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Давайте рассмотрим ситуацию, когда ддосят на / сайта. В принципе особой разницы нет что и как ддосят ,просто правим немного grep запрос и все (:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">256.256.256.256 - - </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">[</span><span style=" font-family:'Courier New'; color:#6a0e07;">07</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">Mar</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">2011:06:23:16 +0300</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">]</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot;GET / HTTP/1.1&quot; 200 2437 &quot;-&quot; &quot;Mozilla/5.0 (X11; U; Linux i686; en-US) AppleWebKit/534.10 (KHTML, like Gecko) Chrome/8.0.552.224 Safari/534.10&quot; &quot;example.com&quot; &quot;2437&quot;  &quot;0.019&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В момент атаки на сервер сыпятся кучи таких запросов. Что нам нужно определить?</p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Нужно найти IP который лезет на атакующий URL.(в данном случае на / сайта, хотя могут быть и /index.php /captcha.php и др.)</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Нашли, проверить что за последнии N записей в логе, он обратился к любому из этих URL более K раз. Тогда это наш клиент и мы его благополучно шлем по дальше.</li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Начинаем по маленьку парситть логи. Так как tail -f нам дает большую задержку с использованием grep, awk, cut пока не заполнятся их буферы на чтение, будем использовать tail -n N (кол-во строк которые смотрим)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Не забудьте в конечном варианте испроваить K на сколько вам нужно. На средних атаках, до 1к ботов я использую 15 на 10к строк логов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">while</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">true</span><span style=" font-family:'Courier New'; color:#6a0e07;">; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">do</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">tail</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -n 1000 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">var</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">log</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">nginx</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">access.log </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot;example\.org&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot; GET / HTTP&quot; ; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sleep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> 60; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">done</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Все. Можете запустить на своем сервере, ессно сменив example.org на ваш домен, и хотя вообще можете полностью выкинуть этот греп, на этапе создания коммандлайнера он не нужен. Далее выдергиваем IP адрес клиента.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">while</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">true</span><span style=" font-family:'Courier New'; color:#6a0e07;">; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">do</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">tail</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -n 1000 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">var</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">log</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">nginx</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">access.log </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot;example\.org&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot; GET / HTTP&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">cut</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -d &quot; &quot; -f1 ; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sleep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> 60; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">done</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На выходе получаем:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">256.256.256.256</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это всего лиш гипотетический пример, поэтому смотрите в оба (:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее, нам нужно проверить, что все ипы у нас встречаются не более К раз, если такое случилось сразу его в магадан =)</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">while</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">true</span><span style=" font-family:'Courier New'; color:#6a0e07;">; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">do</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">tail</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -n 1000 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">var</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">log</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">nginx</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">access.log </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot;example\.org&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot; GET / HTTP&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">cut</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -d &quot; &quot; -f1 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sort</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">uniq</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -c; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sleep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> 60; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">done</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Выход такой:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">1 256.256.256.256</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Первое число, кол-во повторений, второе сам IP. Далее awk выдергиваем то что нам нужно (:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">while</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">true</span><span style=" font-family:'Courier New'; color:#6a0e07;">; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">do</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">tail</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -n 1000 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">var</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">log</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">nginx</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">access.log </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot;example\.org&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot; GET / HTTP&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">cut</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -d &quot; &quot; -f1 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sort</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">uniq</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -c </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">awk</span><span style=" font-family:'Courier New'; color:#6a0e07;"> '{if($1&gt;K){print $2}}'; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sleep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> 60; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">done</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вот и все. Мы получили IP тех, кто встретился нам более К раз. Осталось только его забанить.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">while</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">true</span><span style=" font-family:'Courier New'; color:#6a0e07;">; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">do</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">tail</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -n 1000 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">var</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">log</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">nginx</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">access.log </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot;example\.org&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> &quot; GET / HTTP&quot; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">cut</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -d &quot; &quot; -f1 </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sort</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">uniq</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -c </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">awk</span><span style=" font-family:'Courier New'; color:#6a0e07;"> '{if($1&gt;K){print $2}}' </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">|</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">xargs</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -tl -I _ ipset -A blacklist _; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">sleep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> 60; </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">done</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">На выходе увидете всякое разное (: .<br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перед началом написания коммандлайнера, нужно проверить какие запросы шлются на сервер:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">tail</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -f </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">var</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">log</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">nginx</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">access.log</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Если по какойто причине у вас атакующих ссылок несколько, а может быть что в конце ссылки стоит рандомное число, то вот тут нужно по другому делать</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">grep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -e &quot;GET / HTTP&quot; -e &quot;GET /index.php HTTP&quot; -e &quot;GET /captcha.php HTTP&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Есть еще один вариант, когда /index.php?123456789 куча цыферок. Вот в данном случае есть только <span style=" font-weight:600;">1</span> способ это все выдернуть, никакие iptables не помогут. Там нет регепсов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">pcregrep</span><span style=" font-family:'Courier New'; color:#6a0e07;"> --color &quot;GET \/index\.php\?([0-9]+) HTTP&quot;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Ну а если я не разобрал ваш пример, пишите в комментарии, давайте урлы, или полностью строчки с логов, я и для них напишу паттерн. Чтобы ддосеры не спали, и занимались тренировкой мозгов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вроде бы первый способ я озвучил. Давайте займемся вплотную Iptables:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://netfilter.org/documentation/HOWTO/netfilter-extensions-HOWTO-3.html"><span style=" text-decoration: underline; color:#0057ae;">recent match doc : http://netfilter.org/documentation/HOWTO/netfilter-extensions-HOWTO-3.html</span></a><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Читаем брошурку и понимаем. Также можете посмотреть на nth match. Очень интерстный, но я пока не придумал как его в нашей ситуации можно использовать, если вы знаете, пишити в комментариях.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вот тут уже не получится фильтровать сразу за раз несолько урлов, и каждое правило применяется абсолютно ко всем доменам, так как действует на уровне всего сервера.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">iptables -A INPUT -p tcp -m tcp --dport 80 -m string --string &quot;GET / HTTP&quot; --algo kmp --to 1024 -m recent --set --name httpddos --rsource iptables -A INPUT -p tcp -m tcp --dport 80 -m string --string &quot;GET / HTTP&quot; --algo kmp --to 1024 -m recent --update --seconds 10 --hitcount 2 --name httpddos --rsource -j DROP</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Данные 2 правила делют следущее:<br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Приходит пакет, если в нем есть «GET / HTTP», то обрабатывается слудущим модулем – recent. Если этого нет, то идет на следущее правило. Записали в память. Если в течении 10 секунд с этого IP еще раз придет запрос который удовлетворит GET / HTTP, то тогда этот запрос идет в DROP. Вот и весь смысл. Все просто, просто нужно чуточку почитать документацию, и погуглить, уже есть куча решений, но не всегда то что вам нужно.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Есть одна проблема с модулем recent. Это количество запоминающихся IP адресов по дефолту.</p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">parm:           ip_list_tot:number of IPs to remember per list </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">uint</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">parm:           ip_pkt_list_tot:number of packets per IP to remember </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">max. 255</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span><span style=" font-family:'Courier New'; color:#6a0e07;"> </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">uint</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">parm:           ip_list_hash_size:</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">size</span><span style=" font-family:'Courier New'; color:#6a0e07;"> of </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">hash</span><span style=" font-family:'Courier New'; color:#6a0e07;"> table used to look up IPs </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">uint</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">parm:           ip_list_perms:permissions on </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">proc</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">net</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">ipt_recent</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/*</span><span style=" font-family:'Courier New'; color:#6a0e07;"> files </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">uint</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">parm:           ip_list_uid:owner of </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">proc</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">net</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">ipt_recent</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/*</span><span style=" font-family:'Courier New'; color:#6a0e07;"> files </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">uint</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">parm:           ip_list_gid:owning group of </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">proc</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">net</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">ipt_recent</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/*</span><span style=" font-family:'Courier New'; color:#6a0e07;"> files </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">(</span><span style=" font-family:'Courier New'; color:#6a0e07;">uint</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">ip_list_tot = 100. для этого нам нужно сделать</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">modprobe ipt_recent ip_list_tot=4000</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">При большом количестве pps при большом количестве этого параметра, ksoftirq процесс может начать жрать кучу CPU.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">ip_list_tot = 100</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'monospace';"> </span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Просмотреть количество записей в данный момент можно с помощью команды:</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">wc</span><span style=" font-family:'Courier New'; color:#6a0e07;"> -l </span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">proc</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">net</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/</span><span style=" font-family:'Courier New'; color:#6a0e07;">ipt_recent</span><span style=" font-family:'Courier New'; font-weight:600; color:#6a0e07;">/*</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Одно главное замечание, все это применимо к Debian Lenny. Как все это использовать в франкенштейне CentOS пинайте, пожалуйста не меня, а гугл.<br />Все эти методы я использую во время ддоса. Жду комментариев (:</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p></body></html>