<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Назначение модификатора const в объявлении функций-членов – определить, какие из них можно вызывать для константных объектов. Такие функции-члены важны по двум причинам. Во-первых, они облегчают понимание интерфейса класса, ведь полезно сразу видеть, какие функции могут модифицировать объект, а какие нет. Во-вторых, они обеспечивают возможность работать с константными объектами. Это очень важно для написания эффективного кода, потому что, как объясняется в правиле 20, один из основных способов повысить производительность программ на C++ – передавать объекты по ссылке на константу. Но эта техника будет работать только в случае, когда функции-члены для манипулирования константными объектами объявлены с модификатором const.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Многие упускают из виду, что функции, отличающиеся только наличием const в объявлении, могут быть перегружены. Это, однако, важное свойство C++. Рассмотрим класс, представляющий блок текста:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">class TextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">const char&amp; operator[](std::size_t position) const // operator[] для</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">{return text[position];} // константных объектов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">char&amp; operator[](std::size_t position) // operator[] для</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">{return text[position];} // неконстантных объектов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">std::string text;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Функцию operator[] в классе TextBlock можно использовать следующим образом:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">TextBlock tb(“Hello”);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">Std::cout &lt;&lt; tb[0]; // вызов неконстантного</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                    // оператора TextBlock::operator[]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">const TextBlock ctb(“World”);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">Std::cout &lt;&lt; ctb[0]; // вызов константного</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                     // оператора TextBlock::operator[]</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Кстати, константные объекты чаще всего встречаются в реальных программах в результате передачи по указателю или ссылке на константу. Приведенный выше пример ctb является довольно искусственным. Но вот вам более реалистичный:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">void print(const TextBlock&amp; ctb) // в этой функции ctb – ссылка</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                                 // на константный объект</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">std::cout &lt;&lt; ctb[0]; // вызов const TextBlock::operator[]</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Перегружая operator[] и создавая различные версии с разными возвращаемыми типами, вы можете по-разному обрабатывать константные и неконстантные объекты TextBlock:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">std::cout &lt;&lt; tb[0]; // нормально – читается</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                    // неконстантный TextBlock</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">tb[0] = ‘x’; // нормально – пишется</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">             // неконстантный TextBlock</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">std::cout &lt;&lt; ctb[0]; // нормально – читается</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                     // константный TextBlock</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">ctb[0] = ‘x’; // ошибка! – запись</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">              // константного TextBlock</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Отметим, что ошибка здесь связана только с типом значения, возвращаемого operator[]; сам вызов operator[] проходит нормально. Причина ошибки – в попытке присвоить значение объекту типа const char&amp;, потому что это именно такой тип возвращается константной версией operator[].</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Отметим также, что тип, возвращаемый неконстантной версией operator[], – это ссылка на char, а не сам char. Если бы operator[] возвращал просто char, то следующее предложение не скомпилировалось бы:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">tb[0] = ‘x’;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это объясняется тем, что возвращаемое функцией значение встроенного типа модифицировать некорректно. Даже если бы это было допустимо, тот факт, что C++ возвращает объекты по значению (см. правило 20), означал бы следующее: модифицировалась <span style=" font-style:italic;">копия</span> tb.text[0], а не само значение tb.text[0]. Вряд ли это то, чего вы ожидаете.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Давайте немного передохнем и пофилософствуем. Что означает для функции-члена быть константной? Существует два широко распространенных понятия: <span style=" font-style:italic;">побитовая константность</span> (также известная как <span style=" font-style:italic;">физическая константность)</span> и <span style=" font-style:italic;">логическая константность.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сторонники побитовой константности полагают, что функция-член константна тогда и только тогда, когда она не модифицирует никакие данные-члены объекта (за исключением статических), то есть не модифицирует ни одного бита внутри объекта. Определение побитовой константности хорошо тем, что ее нарушение легко обнаружить: компилятор просто ищет присваивания членам класса. Фактически, побитовая константность – это константность, определенная в C++: функция-член с модификатором const не может модифицировать нестатические данные-члены объекта, для которого она вызвана.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">К сожалению, многие функции-члены, которые ведут себя далеко не константно, проходят побитовый тест. В частности, функция-член, которая модифицирует то, на что указывает указатель, часто не ведет себя как константная. Но если объекту принадлежит только указатель, то функция формально является побитово константной, и компилятор не станет возражать. Это может привести к неожиданному поведению. Например, предположим, что есть класс подобный Text-Block, где данные хранятся в строках типа char * вместо string, поскольку это необходимо для передачи в функции, написанные на языке C, который не понимает, что такое объекты типа string.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">class CtextBlock {</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> char&amp; operator[](std::size_t position) const // неудачное (но побитово</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> { return pText[position]}                    // константное)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                                              // объявление operator[]</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> char *pText;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этом классе функция operator[] (неправильно!) объявлена как константная функция-член, хотя она возвращает ссылку на внутренние данные объекта (эта тема обсуждается в правиле 28). Оставим это пока в стороне и отметим, что реализация operator[] никак не модифицирует pText. В результате компилятор спокойно сгенерирует код для функции operator[]. Ведь она действительно является побитово константной, а это все, что компилятор может проверить. Но посмотрите, что происходит:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">const CtextBlock cctb(“Hello”); // объявление константного объекта</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">char &amp;pc = &amp;cctb[0]; // вызов const operator[] для получения</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                     // указателя на данные cctb</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">*pc = ‘j’; // cctb теперь имеет значение “Jello”</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Несомненно, есть что-то некорректное в том, что вы создаете константный объект с определенным значением, вызываете для него только константную функцию-член и тем не менее изменяете его значение!</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Это приводит нас к понятию логической константности. Сторонники этой философии утверждают, что функции-члены с const могут модифицировать некоторые биты вызвавшего их объекта, но только так, чтобы пользователь не мог этого обнаружить. Например, ваш класс CTextBlock мог бы кэшировать длину текстового блока при каждом запросе:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">Class CtextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> std::size_t length() const;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> char *pText;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> std::size_t textLength; // последнее вычисленное значение длины</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">                         // текстового блока</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> bool lengthIsValid; // корректна ли длина в данный момент</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">};</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">std::size_t CtextBlock::length() const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">if(!lengthIsValid) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> textLength = std::strlen(pText); // ошибка! Нельзя присваивать</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> lengthIsValid = true;            // значение textLength и</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">            }                     // lengthIsValid в константной функции-члене</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> return textLength;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Эта реализация length(), конечно же, не является побитово константной, поскольку может модифицировать значения членов textLength и lengthlsValid. Но в то же время со стороны кажется, что константности объектов CTextBlock это не угрожает. Однако компилятор не согласен. Он настаивает на побитовой константности. Что делать?</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Решение простое: используйте модификатор mutable. Он освобождает нестатические данные-члены от ограничений побитовой константности:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">Class CtextBlock {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">public:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> std::size_t length() const;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">private:</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> char *pText;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> mutable std::size_t textLength; // Эти данные-члены всегда могут быть</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> mutable bool lengthIsValid; // модифицированы, даже в константных</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">}; // функциях-членах</span></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New'; color:#6a0e07;"><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">std::size_t CtextBlock::length() const</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">{</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> if(!lengthIsValid) {</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">  textLength = std::strlen(pText); // теперь порядок</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">  lengthIsValid = true; // здесь то же</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> }</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;"> return textLength;</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a0e07;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>