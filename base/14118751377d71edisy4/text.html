<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-style:italic;">Это заготовка статьи. Дописать.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">До настоящего времени в Рунете я так и не смог найти статьи, в которой бы доступно и полно рассказывалось о том, как настраивать директивы RewriteCond и RewriteRule в файле .htaccess. </p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Нигде нет ответа на самые основные вопросы: как происходит преобразование URL, переданного браузером? Как увидеть новый преобразованный URL? А можно ли посмотреть лог преобразований URL?</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Нам дают какой-то черный ящик, в котором нужно писать какие-то странные заклинания, не видя, что происходит в процессе и на выходе. Нас это не устраивает. Поэтому будем разбираться.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Суровое примечание:</span><span style=" font-style:italic;"> существует разница между понятиями </span><span style=" font-weight:600; font-style:italic;">URL</span><span style=" font-style:italic;"> и </span><span style=" font-weight:600; font-style:italic;">URI</span><span style=" font-style:italic;">. Эти два термина являются стандартами представления адресов. URI (Uniform Resource Identifier, RFC 2396, т. е. универсальный идентификатор ресурса) — это общий термин для всех допустимых форматов схем адресации, поддерживаемых в сети Интернет. URL (Uniform Resource Locators, RFC 1738 / RFC 1808) — это формат схемы адресации с использованием универсальных локаторов ресурсов, которые явно указывают местонахождение ресурса. Грубо говоря, URL - это подмножество URI. В настоящее время повсеместно используется только стандарт URL. Но профессионалы, впавшие в интеллектуальный снобизм, используют термин URI как &quot;более точный и правильный&quot;. Я не отношусь к таким профессионалам, поэтому далее свободно использую термин URL, просто потому что мне так привычней.</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Далее предполагается, что модуль <span style=" font-family:'Courier New'; color:#6a1009;">mod_rewrite</span> подключен к Апачу и работает, а нам осталось только правильно прописать директивы перенаправления URL в файле <span style=" font-family:'Courier New'; color:#6a1009;">.htaccess</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Как работает перенаправление URL в .htaccess через модуль mod_rewrite?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Когда говорят о перенаправлении адреса через <span style=" font-family:'Courier New'; color:#6a1009;">mod_rewrite</span>, проще всего представить файл <span style=" font-family:'Courier New'; font-weight:600; color:#6a1009;">.</span><span style=" font-family:'Courier New'; color:#6a1009;">htaccess</span> в виде программы, которая выполняется по строкам сверху вниз. На вход этой программы подается исходный URL, на выходе получаем измененный URL.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Строками нашей условной программы являются директивы модуля <span style=" font-family:'Courier New'; color:#6a1009;">mod_rewrite</span>:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RewriteEngine</span> - включение/выключение перенаправления. Обычно используется в начале файла <span style=" font-family:'Courier New'; font-weight:600; color:#6a1009;">.</span><span style=" font-family:'Courier New'; color:#6a1009;">htaccess </span>в виде:<br /><br /><span style=" font-family:'Courier New'; color:#6a1009;">RewriteEngine On<br /></span></li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RewriteBase</span> - определение корневой директории для преобразования строки URL в имя файла. Обычно используется в начале файла <span style=" font-family:'Courier New'; font-weight:600; color:#6a1009;">.</span><span style=" font-family:'Courier New'; color:#6a1009;">htaccess </span>в виде:<br /><br /><span style=" font-family:'Courier New'; color:#6a1009;">RewriteBase /<br /></span></li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RewriteOptions</span> - установка некоторых специальных опций для текущей конфигурации в контексте сервера или каталога. Здесь рассматривать не будем.<br /></li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RewriteCond</span> - это пред-условие для директивы <span style=" font-family:'Courier New'; color:#6a1009;">RewriteRule</span>. Одно <span style=" font-family:'Courier New'; color:#6a1009;">RewriteRule</span> может иметь несколько <span style=" font-family:'Courier New'; color:#6a1009;">RewriteCond</span>. Имеет формат:<br /><br /><span style=" font-family:'Courier New'; color:#6a1009;">RewriteCond что_сравниваем с_чем_сравниваем<br /><br />RewriteRule</span> выполнится только в том случае, если все предыдущие директивы <span style=" font-family:'Courier New'; color:#6a1009;">RewriteCond</span> находилсь в значении True.<br /></li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">RewriteRule</span> - команда преобразования URL. Имеет формат:<br /><br /><span style=" font-family:'Courier New'; color:#6a1009;">RewriteRule исходная_строка(т.е. шаблон) преобразованная_строка(т.е. подстановка) [Флаги]</span></li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Здесь мы будем рассматривать только самое простое и самое популярное преобразование:  преобразование строки URL в имя файла на ресурсе, где крутится Apache.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">В каком виде попадает URL вовнутрь .htaccess?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В файл .htaccess строка URL попадает без обозначения протокола и имени домена.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Например, если в строке браузера написано <span style=" font-family:'Courier New'; color:#6a1009;">&quot;http://mysite.ru/messages/index.php&quot;</span>, то URL, который попадет вовнутрь файла <span style=" font-family:'Courier New'; color:#6a1009;">.htaccess</span>, будет <span style=" font-family:'Courier New'; color:#6a1009;">&quot;</span><span style=" font-family:'Courier New'; color:#6a1009;">messages/</span><span style=" font-family:'Courier New'; color:#6a1009;">index.php&quot;</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Как увидеть преобразования URL?</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пока мы не будем видеть преобразований, которые претерпевает URL при срабатывании директив <span style=" font-family:'Courier New'; color:#6a1009;">mod_rewrite</span>, мы не сможем понять его работу и не сможем правильно написать файл <span style=" font-family:'Courier New'; color:#6a1009;">.htaccess</span>.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Увидеть лог преобразований <span style=" font-family:'Courier New'; color:#6a1009;">mod_rewrite</span> можно в логе Апача. Но для начала нужно настроить Апач так, чтобы информация о преобразовании URL попадала в лог. Настройки для Апача версий ниже 2.4 и Apache 2.4 и выше отличаются.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Для Апача до версии 2.4:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В настроечном файле Апача <span style=" font-family:'Courier New'; color:#6a1009;">httpd.conf</span> надо проверить наличие директив <span style=" font-family:'Courier New'; color:#6a1009;">RewriteLog</span> и <span style=" font-family:'Courier New'; color:#6a1009;">RewriteLogLevel</span>, (при отсутсвии их нужно добавить), и установить следующие значения этим директивам:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"># Для Apache версий ниже 2.4</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">RewriteLog &quot;/var/log/apache2/rewrite.log&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">RewriteLogLevel 3</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Путь к файлу лога должен существовать в файловой системе. В этом файле будет складываться информация о преобразовании URL.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600; font-style:italic;">Для Апача 2.4 и выше:</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В настроечном файле Апача <span style=" font-family:'Courier New'; color:#6a1009;">httpd.conf</span> надо найти директиву <span style=" font-family:'Courier New'; color:#6a1009;">LogLevel</span> и установить ей значение:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;"># Для Apache 2.4 и выше</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:40px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">LogLevel alert rewrite:trace3</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Информация о преобразовании URL будет складываться в логе Апача (проверить, возможно, что не так, у меня нет Apache 2,4).</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">После чего необходимо перезапустить Апач. В логах будут видны примерно следующие записи:</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">rewrite 'admin/vipPortPageId/forward_function' -&gt; 'index.php/admin/vipPortPageId/forward_function'</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">RewriteCond: input='/small/asdfsadf/avatar.jpg' pattern='^(.*)/(.*)/(.*)' =&gt; matched</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">RewriteCond: input='/var/www/local.dev/www/small/avatar.jpg' pattern='-f' =&gt; matched</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">rewrite 'small/asdfsadf/avatar.jpg' -&gt; '/small/avatar.jpg'</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New'; color:#6a1009;">internal redirect with /small/avatar.jpg [INTERNAL REDIRECT]</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Внимание!</span> Логирование результатов преобразований в mod_rewrite - <span style=" font-weight:600;">очень</span> времязатратный процесс. Не допускайте таких настроек на сервере в продершене. Даже на тестовом сервере настройте логирование, отладьте перенаправление, а затем верните настройки назад.</p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p></body></html>