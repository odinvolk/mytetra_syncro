<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Примеры задач, в которых имеет смысл использовать DSL</span> </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">25 сентября 2013 </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Сказать по правде, я долгое время не понимал, для чего нужны DSL. В конце концов, всю жизнь без них как-то обходился, и нормально. Какую проблему, спрашивается, они решают? И вообще, у нас тут безо всяких DSL сплошь и рядом зоопарки языков программирования, а вы предлагаете ввести еще один язык!? Но, подумав, поспрашивав людей и погуглив немного, я пришел к выводу, что в ряде случаев создание собственных DSL может быть хорошей идеей. Проще всего убедиться в этом, рассмотрев несколько практических задач и как они решаются с использованием DSL. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-weight:600;">Дисклеймер:</span> Получился какой-то дамп сознания, а не пост, так что, пожалуйста, простите мне некоторую вольность в трактовке вещей вроде «что считается DSL, а что нет». Если вы ищите более строгий материал по предметно-ориентированным языкам, то можете найти его <a href="http://en.wikipedia.org/wiki/Domain-specific_language"><span style=" text-decoration: underline; color:#0000ff;">в статье на англоязычной Википедии</span></a> и далее по ссылкам.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В действительности, мы постоянно работаем с DSL, просто не всегда осознаем это. Несмотря на то, что предметно-ориентированные языки противопоставляются языкам программирования общего назначения, по факту, последнее тоже в существенной степени являются DSL. Например, Си представляет собой DSL для написания, например, всяких там драйверов, а PHP — DSL для написания сайтов. Doxygen, LaTeX, SQL, <a href="http://eax.me/regular-expr/"><span style=" text-decoration: underline; color:#0000ff;">регулярные выражения</span></a>, HTML, CSS, команды, которые мы вводим в bash, конфиги nginx — все это тоже DSL, заточенные специально для решения определенного круга задач. Согласитесь, было бы странно верстать веб-страницы на Си, а запросы к базе данных формулировать на CSS.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Но все названное представляет собой готовые DSL. Зачем же изобретать новые? На самом деле, этого лучше не делать. Если для решения вашей задачи уже есть готовый, проверенный временем, стабильный DSL, нет повода не использовать его. Но иногда вы можете столкнуться с задачами, для решения которых готового DSL нет. Тут-то вам и пригодятся макросы Lisp, <a href="http://eax.me/dsl-tasks/eax.me/template-haskell/"><span style=" text-decoration: underline; color:#0000ff;">Template Haskell</span></a>, так называемые <a href="http://eax.me/simple-interpreter/"><span style=" text-decoration: underline; color:#0000ff;">компиляторы компиляторов</span></a> и прочие средства для создания DSL.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вообще-то говоря, для создания собственного DSL не обязательно прибегать к метапрограммированию или написанию компилятора. Когда вы определяете набор функций или классов для работы в определенной предметной области, вы тоже создаете DSL. Например, <a href="http://eax.me/haskell-exceptions/"><span style=" text-decoration: underline; color:#0000ff;">функции для работы с исключениями</span></a> и <a href="http://eax.me/haskell-stm/"><span style=" text-decoration: underline; color:#0000ff;">транзакционной памятью</span></a> в Haskell представляют собой полноценные предметно-ориентированные языки программирования. Если есть возможность найти эффективное решение задачи без использования метапрограммирования, обычно лучше пойти именно этим путем. Далее будет предполагаться, что это не представляется возможным по каким-то причинам.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Так что же это могут быть за задачи?</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Допустим, вы в течение некоторого времени пилите некий <a href="http://eax.me/rest/"><span style=" text-decoration: underline; color:#0000ff;">RESTful сервис</span></a> и обратили внимание, что пишите довольно много шаблонного кода. Например, у вас обычно есть некая табличка в базе данных, для которой вы пишите CRUD, притом во время чтения может производится фильтрация по извлекаемым из таблицы полям, передаваться limit, offset и другие параметры. Также от вас обычно требуется предусмотреть экспорт в CSV или <a href="http://eax.me/scala-excel/"><span style=" text-decoration: underline; color:#0000ff;">еще какой-нибудь формат</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">В этом случае вы можете внимательно посмотреть на уже написанный код, найти в нем повторяющиеся куски для разных ресурсов и написать DSL, который принимает на вход некое описание ресурса (то есть, частей кода, которые различаются) и на основе этого описания создает в вашем сервисе новый ресурс. Например, на входе вы можете указать URL ресурса, его краткое описание, перечень полей таблицы в БД, их типы, допустимые значения, значения по умолчанию и так далее, а на выходе получить документацию по API в Markdown, схему базы данных (для <a href="http://eax.me/postgresql-vs-mysql/"><span style=" text-decoration: underline; color:#0000ff;">MySQL, PostgreSQL</span></a>, SQLite и Oracle), код серверной части приложения с корректной валидацией и сообщениями об ошибках, а также код клиентов на десяти языках программирования.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Мы описываем ресурс в десяти строках и получаем тысячи, если не десятки тысяч, строк! How cool is that? Если подумать, DSL почти всегда является в том или ином виде попыткой избавиться от шаблонного кода. Например, CSS нужен для того, чтобы не вводить постоянно стили прямо в HTML, Doxygen — чтобы генерировать документацию на основе комментариев, SQL — чтобы не писать запросы в терминах хождения по индексам, кэшам и чтения блоков данных с диска, всякие высокоуровневые языки программирования — чтобы не управлять памятью вручную и не писать проверки на выход за границы массива, язык Си — чтобы не писать на ассемблере, ассемблер — чтобы не писать в байткодах, байткоды — чтобы не вбивать единички и нолики.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://eax.me/mojolicious/"><span style=" text-decoration: underline; color:#0000ff;">Веб-фреймворки</span></a> по большому счету представляют собой DSL. Всякие ORM — это тоже DSL. Вы описываете базу данных, а в результате получаете SQL-запросы для ее инициализации, процедуры миграции от версии к версии, шаблонные функции типа create_user, user_exists и так далее. Другой вопрос, что <a href="http://eax.me/dbix-class/"><span style=" text-decoration: underline; color:#0000ff;">некоторые ORM</span></a> работают неправильно. Вместо того, чтобы описывать схему БД на неком DSL, они ходят в уже созданную базу, определяют ее схему и на ее основе генерируют наборы классов. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Вы можете написать <a href="http://eao197.blogspot.ru/2013/06/progthoughts-dsl.html"><span style=" text-decoration: underline; color:#0000ff;">DSL для описания логов системы</span></a>. Этим вы не только приведете логи к одному строгому формату, но и сможете сгенерировать документацию по ним с описанием, какое сообщение в логах что означает, какая дополнительная информация пишется в логи с этим сообщением, куда звонить или писать, если такое сообщение появляется. Документация может генерироваться в множестве различных форматов (doc, pdf, html, markdown, …). Кроме того, вы можете реализовать проверки на этапе компиляции, что нигде в приложении в логи не пишется какая-нибудь ерунда.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Нетрудно представить аналогичный DSL для описания конфигурационных файлов.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">При помощи DSL можно описывать форматы данных и протоколы, после чего генерировать на основе этого описания код для работы с этими протоколами и форматами. В том числе, код для сериализации и десериализации объектов в и из заданного формата, а также передачи сериализованных объектов по заданному протоколу. Другими словами, Protobuf тоже представляет собой DSL.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Различные DSL активно используются в <a href="http://eax.me/yesod-introduction/"><span style=" text-decoration: underline; color:#0000ff;">Yesod</span></a>, где с их помощью делаются такие классные вещи, как проверки на этапе компиляции, что приложение не сошлется на несуществующую веб-страницу, валидация HTML, CSS и JavaScript, компрессия CSS и JavaScript, парсинг файлов с переводами сайта на различные языки, компиляция HTML-шаблонов в машинный код, валидация форм (как на серверной стороне, так и на клиентской при помощи JavaScript) и не только.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">DSL приходят на помощь, если вы решили расширить используемый вами язык программирования. С их помощью вы можете добавить в язык модель акторов и обмен сообщениями, изменяемые переменные, множественное наследование, контрактное программирование или даже какое-нибудь <a href="http://eax.me/erlang-text-gen/"><span style=" text-decoration: underline; color:#0000ff;">описание грамматик для генерации текстов</span></a>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Как видите, DSL можно применять для решения огромного множества задач. На самом деле, даже странно, что в третьем тысячелетии мы все еще пишем код для решения задач, а не исключительно код для написания кода для решения задач. Ведь в этом случае автоматически возрастает производительность программиста, уменьшается количество шаблонного кода, снижается вероятность возникновения ошибок, да и работа становится интересней.</p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p>
<p style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"></p></body></html>