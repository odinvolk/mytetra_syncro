<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:18px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:xx-large; font-weight:600;">Настройка резервного копирования в Ubuntu за 20 минут.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Для работы над проектами использую svn, который находится на удаленном виртуальном выделенном хосте, под управлением ubuntu 8.04. Со временем объемы данных выросли, как и критичность этих данных. Потеря чего-то снилась в кошмарах. Время от времени копировал репозитории на локальный компьютер. Недавно мне это надоело. И я стал искать возможности автоматизировать это дело. Не буду говорить о поисках и вариантах, расскажу о результатах.<br /><br />Итак, мы имеем удаленный хост под управлением ubuntu, с некоторым массивом довольно критичных данных. Довольно логичным было бы настроить бэкап прямо на удаленном хосте, с помощью tar по крону, rsyns и т.д. Но, т.к. место на виртуальном выделенном хостинге довольно дорого и использовать его лучше по делу, идеально было бы, чтобы данные автоматически копировались на какую нибудь локальную машину, место на которой хоть отбавляй. В моем случае это файловый сервис в офисе, под управлением все той же Ubuntu.<br /><br /><a name="habracut"></a><br /></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Подготовка</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Данные будем переливать с помощью SSH, поэтому давайте сначала настроим public и private ключи для локального и удаленного серверов. Делаем это для того, чтобы программа, которая будет переливать данные могла заходить по SSH без пароля.<br /><br /><span style=" font-family:'Courier New,courier';">$ ssh-keygen -t dsa</span><br /><br />Оставьте папку по-умолчанию, а пароль сделайте пустым.<br />Эта команда должна создать в папке ~/.ssh(по умолчанию) два файла — private и public key. private предназначается для локальной машины, pub отправляется на удаленный.<br /><br />Теперь копируем private key в папку /root/.ssh, чтобы пользователь root так мог пользоваться им<br /><br /><span style=" font-family:'Courier New,courier';">$ cd ~/.ssh<br />$ sudo mkdir /root/.ssh<br />$ sudo cp id_dsa /root/.ssh</span><br /><br />Теперь надо скопировать public key на удаленную машину, с которой мы хотим копировать данные. Предварительно создайте пользователя backup на удаленной машине(команда adduser). Не забудьте дать этому пользователю права на чтение каталогов, которые вы хотите копировать.<br /><br /><span style=" font-family:'Courier New,courier';">$ cat ~/.ssh/id_dsa.pub | ssh backup@remotehost.ru &quot;cat &gt;&gt; ~/.ssh/authorized_keys2&quot;</span><br /><br />Теперь можем попробывать зайти через ssh на удаленную машину:<br /><br /><span style=" font-family:'Courier New,courier';">$ ssh backup@remotehost.ru</span><br /><br />В случае, если все сделано правильно, нас впустит без пароля.<br />На удаленной машине ставим нормальные права на чтение публичного ключа:<br /><br /><span style=" font-family:'Courier New,courier';">remotehostru$ chmod 700 .ssh<br />remotehostru$ chmod 400 .ssh/authorized_keys2<br />remotehostru$ exit</span><br /><br /></p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Настройка rsnapshot</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />rsnapshot — утилита для создания копий состояния файловых систем на базе rsync. Она упрощает создание периодических копий с локальной и удаленных машин по ssh. Она использует, по возможности, жесткие связи, что позволяет существенно уменьшить объем необходимого дискового пространства. (цитата <a href="http://citkit.ru/package/rsnapshot/"><span style=" text-decoration: underline; color:#0000ff;">отсюда</span></a>)<br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Установка</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Устанавливаем rsnapshot:<br /><br /><span style=" font-family:'Courier New,courier';">$ sudo apt-get install rsnapshot</span><br /><br />Если вы используете не debian-подобный дистрибутив, rsnapshot наверняка тоже есть в репозиториях вашего дистрибутива. Для CentOS, при включенных RPMForge это делается, например, так:<br /><br /><span style=" font-family:'Courier New,courier';"># yum install rsnapshot</span><br /><br />Теперь нам нужно создать директорию, где мы собираемся хранить наши «снимки»:<br /><br /><span style=" font-family:'Courier New,courier';">$ sudo mkdir /var/snapshots</span><br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Настройка</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Теперь можно перейти к настройке, собственно, rsnapshot:<br /><br /><span style=" font-family:'Courier New,courier';">$ sudo nano /etc/rsnapshot.conf</span><br /><br />Вместо nano вы можете использовать любой другой редактор, например vi, или gedit, если работаете в GNOME.<br />Настроить нужно следующие параметры:<br /><br /><span style=" font-family:'Courier New,courier';">snapshot_root - директория, в которую вы хотите сохранять &quot;снимки&quot;.<br /><br />interval xxx yy - ххх - название интервала(например hourly, daily), yy - количество снимков для каждого. Например:<br />interval hourly 6<br />interval daily 7</span><br /><br />Означает, что мы хотим хранить 6 ежечасных копий и 7 ежемесячных. Если уже доступно указанное количество копий, rsnapshot будет заменить старую более новой.<br /><br />Расскомментируйте cmd_cp. cmd_ssh расскоментируйте и измените на<br /><br /><span style=" font-family:'Courier New,courier';">cmd_ssh /usr/bin/ssh</span><br /><br />Настройка бэкапа осуществляется командой backup &lt;откуда&gt; &lt;куда&gt;:<br /><br /><span style=" font-family:'Courier New,courier';">#Добавляем папку /etc/ с локальной машины в папку localhost/<br />backup /etc/ local/<br />#Добавляем папку /var/svn с удаленной машины в папку remotehost/<br />backup backup@remotehost.ru:/var/svn/ remotehost/<br /></span><br /><br /><span style=" font-weight:600;">Помните, что в конфигурационном файле недопустимы пробелы — используйте только табы.</span><br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Пробный запуск</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />Запустим rsnapshot:<br /><span style=" font-family:'Courier New,courier';">$ rsnapshot hourly</span><br /><br />Второй параметр означает интервал, который мы задали в конфигурационном файле.<br />Команда может выполняется продолжительное время. После выполнения, смотрим, что она создала:<br /><span style=" font-family:'Courier New,courier';">$ ls -l /var/snapshots</span><br /><br />Пока что в директории должен быть один каталог: hourly.0. При следующем запуске rsnapshot будет создавать каталоги hourly.1, hourly.2 и т.д., пока не упрется в максимум, указанный нами в конфигурационном файле.<br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Настройка cron</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />В Ubuntu автоматически создается файл /etc/cron.d/rsnapshot со следующим содержанием:<br /><span style=" font-family:'Courier New,courier';">0 */4 * * * root /usr/bin/rsnapshot hourly<br />30 3 * * * root /usr/bin/rsnapshot daily<br />0 3 * * 1 root /usr/bin/rsnapshot weekly<br />30 2 1 * * root /usr/bin/rsnapshot monthly</span><br /><br />Вот и все. Теперь у вас 6 раз в сутки должен автоматически создаваться снимок данных с вашего удаленного сервера. Данные в сохранности, да еще и географически распределены.<br /><br />Кстати, 6 раз в сутки не означает, что размер будет в 6 раз больше, чем если копировать всего 1 раз в сутки. Если в промежутки между копированиями не будет изменений в файлах, то общий размер копий почти не изменится.<br /><br /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:medium; font-weight:600;">Дополнительная информация</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br />С помощью параметра backup_script можно также настроить резервное копирование баз данных MySQL, да и вообще всего, чего угодно. Я не описывал сей процесс, т.к. у меня он не используется и ничего конкретного сказать не могу.<br />Подробнее можно почитать в гугле. По запросу rsnapshot вылезает куча релевантных ссылок, правда на английском языке.<br /><br />Прошу особо не ругать, на гуру администрирования(да и linux) я не похож, но довольно долго искал, как просто автоматизировать резервное копирование — нашел способ, решил поделиться. <br /></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p></body></html>